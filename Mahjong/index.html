<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡πÑ‡∏û‡πà‡∏ô‡∏Å‡∏Å‡∏£‡∏∞‡∏à‡∏≠‡∏Å‡∏Å‡∏±‡∏ö‡∏ö‡∏≠‡∏ó</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #f0f0f0;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }

      .game-container {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 25px;
        text-align: center;
        width: 100%;
        max-width: 900px; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î */
        box-sizing: border-box;
      }

      h1,
      h2 {
        color: #333;
        margin-bottom: 15px;
      }

      .board {
        display: flex;
        flex-direction: column; /* ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        gap: 20px;
        margin-top: 20px;
      }

      @media (min-width: 768px) {
        /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå */
        .board {
          flex-direction: row; /* ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà */
          justify-content: space-around;
          align-items: flex-start;
        }
      }

      .player {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 15px;
        background-color: #f9f9f9;
        flex: 1; /* ‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
      }

      .tile-hand,
      .tile-area,
      .open-melds {
        display: flex;
        flex-wrap: wrap;
        gap: 8px; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏û‡πà */
        justify-content: center;
        min-height: 60px; /* ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ */
      }

      .open-melds {
        border-top: 1px dashed #ddd;
        margin-top: 10px;
        padding-top: 10px;
        font-size: 0.9em;
      }

      .meld-group {
        display: flex;
        gap: 2px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 2px;
        margin: 2px;
      }

      .tile {
        font-size: 32px; /* ‡∏Ç‡∏ô‡∏≤‡∏î Emoji */
        line-height: 1;
        cursor: pointer;
        padding: 5px;
        border: 1px solid #eee;
        border-radius: 4px;
        background-color: #fff;
        transition: transform 0.1s ease-in-out;
      }

      .tile:hover {
        transform: translateY(-3px);
      }

      .discard-pile {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 15px;
        background-color: #f9f9f9;
        flex: 2; /* ‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏¥‡πâ‡∏á‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
      }

      .actions {
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }

      .actions button {
        background-color: #4caf50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.2s;
      }

      .actions button:hover:not(:disabled) {
        background-color: #45a049;
      }

      .actions button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      .dynamic-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .dynamic-actions button {
        background-color: #008cba; /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Chi/Pon/Kan */
      }

      .dynamic-actions button:hover:not(:disabled) {
        background-color: #007bb5;
      }

      .message {
        margin-top: 20px;
        padding: 10px;
        background-color: #e7f3e7;
        border: 1px solid #d4edda;
        color: #155724;
        border-radius: 5px;
      }

      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î Emoji ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
      @media (max-width: 500px) {
        .tile {
          font-size: 24px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î Emoji ‡∏•‡∏á */
          padding: 3px;
        }
        .actions button {
          padding: 8px 12px;
          font-size: 14px;
        }
        .game-container {
          padding: 15px;
        }
      }

      /* Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á */
      .game-info {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        gap: 10px;
        padding: 10px;
        background-color: #e0f2f7; /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
        border-radius: 8px;
        font-size: 1.1em;
      }
      .game-info div {
        padding: 5px 10px;
        border-radius: 4px;
        background-color: #c7e8ed;
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <h1>‡πÄ‡∏Å‡∏°‡πÑ‡∏û‡πà‡∏ô‡∏Å‡∏Å‡∏£‡∏∞‡∏à‡∏≠‡∏Å</h1>

      <div class="board">
        <div class="player bot-hand">
          <h2>‡∏ö‡∏≠‡∏ó</h2>
          <div id="bot-tiles" class="tile-hand"></div>
          <div id="bot-open-melds" class="open-melds"></div>
        </div>

        <div class="discard-pile">
          <h2>‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏¥‡πâ‡∏á</h2>
          <div id="discarded-tiles" class="tile-area"></div>
        </div>

        <div class="player user-hand">
          <h2>‡∏Ñ‡∏∏‡∏ì</h2>
          <div id="user-tiles" class="tile-hand"></div>
          <div id="user-open-melds" class="open-melds"></div>
        </div>
      </div>

      <div class="game-info">
        <div id="user-score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏∏‡∏ì: 25000</div>
        <div id="bot-score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ö‡∏≠‡∏ó: 25000</div>
        <div id="round-info">
          <span id="round-wind">‡∏•‡∏°‡∏£‡∏≠‡∏ö: Êù±</span>
          |
          <span id="player-wind">‡∏•‡∏°‡∏Ñ‡∏∏‡∏ì: Êù±</span>
          |
          <span id="kyoutaku-sticks">Kyoutaku: 0x1000</span>
          |
          <span id="honba-count">Honba: 0</span>
        </div>
        <div id="dora-indicators">Dora Indicators:</div>
        <div id="dead-wall-count">‡πÑ‡∏û‡πà‡πÉ‡∏ô‡∏™‡∏≥‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</div>
      </div>

      <div class="actions">
        <button id="draw-tile-btn" disabled>‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà</button>
        <button id="riichi-btn" disabled>Riichi</button>
        <button id="tsumo-btn" style="display: none">Tsumo</button>
        <button id="ron-btn" style="display: none">Ron</button>
        <div id="dynamic-actions" class="dynamic-actions"></div>
      </div>

      <div id="game-message" class="message">
        ‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÑ‡∏î‡πâ
      </div>
    </div>
    <script>
      const TILES = {
        characters: ['üÄá', 'üÄà', 'üÄâ', 'üÄä', 'üÄã', 'üÄå', 'üÄç', 'üÄé', 'üÄè'], // 1-9 Man
        dots: ['üÄô', 'üÄö', 'üÄõ', 'üÄú', 'üÄù', 'üÄû', 'üÄü', 'üÄ†', 'üÄ°'], // 1-9 Pin
        bamboos: ['üÄê', 'üÄë', 'üÄí', 'üÄì', 'üÄî', 'üÄï', 'üÄñ', 'üÄó', 'üÄò'], // 1-9 Sou
        winds: ['üÄÄ', 'üÄÅ', 'üÄÇ', 'üÄÉ'], // East, South, West, North
        dragons: ['üÄÑ', 'üÄÖ', 'üÄÜ'], // Red, Green, White
      };

      let deck = [];
      let userHand = [];
      let botHand = [];
      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á openMelds ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á Meld ‡∏î‡πâ‡∏ß‡∏¢
      // ‡πÄ‡∏ä‡πà‡∏ô { type: 'pon', tiles: ['üÄá', 'üÄá', 'üÄá'] }
      // ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Kan: { type: 'minkan', tiles: ['üÄá', 'üÄá', 'üÄá', 'üÄá'] }
      // ‡∏´‡∏£‡∏∑‡∏≠ { type: 'ankan', tiles: ['üÄá', 'üÄá', 'üÄá', 'üÄá'] }
      let userOpenMelds = [];
      let botOpenMelds = [];
      let discardedTiles = [];
      let lastDiscardedTile = null;
      let lastDiscarder = null; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Chi)
      let currentTurn = 'user'; // 'user' or 'bot' or 'user_action_check' or 'bot_action_check'
      let isUserDiscardPhase = false; // true ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà
      let isRiichiDeclared = { user: false, bot: false }; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Riichi ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏≠‡∏ó
      let deadWall = []; // ‡πÑ‡∏û‡πà Dead Wall (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Rinshan Kaihou, Dora)
      let doraIndicators = []; // ‡πÑ‡∏û‡πà Dora Indicators

      const userTilesEl = document.getElementById('user-tiles');
      const botTilesEl = document.getElementById('bot-tiles');
      const discardedTilesEl = document.getElementById('discarded-tiles');
      const userOpenMeldsEl = document.getElementById('user-open-melds');
      const botOpenMeldsEl = document.getElementById('bot-open-melds');
      const drawTileBtn = document.getElementById('draw-tile-btn');
      const riichiBtn = document.getElementById('riichi-btn');
      const gameMessageEl = document.getElementById('game-message');
      const dynamicActionsEl = document.getElementById('dynamic-actions');

      let playerScores = {
        user: 25000, // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
        bot: 25000, // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÅ‡∏Ñ‡πà 2 ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
      };

      let roundWind = 'üÄÄ'; // ‡∏•‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏£‡∏≠‡∏ö (Êù± - East)
      let playerWind = {
        user: 'üÄÄ', // ‡∏•‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (Êù± - East)
        bot: 'üÄÅ', // ‡∏•‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ö‡∏≠‡∏ó (Âçó - South) - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 2 ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ‡∏ö‡∏≠‡∏ó‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô South
      };
      let isDealer = {
        user: true, // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏õ‡πá‡∏ô Dealer (Ë¶™ - Oya)
        bot: false,
      };

      // HTML Elements ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
      const userScoreEl = document.getElementById('user-score'); // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ô HTML
      const botScoreEl = document.getElementById('bot-score'); // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ô HTML

      // HTML Elements ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Tsumo/Ron (‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô index.html ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
      const tsumoBtn = document.getElementById('tsumo-btn');
      const ronBtn = document.getElementById('ron-btn');

      // Helper to get all possible tiles in order (for sorting and Chi logic)
      const ALL_TILES_ORDER = [].concat(
        TILES.characters,
        TILES.dots,
        TILES.bamboos,
        TILES.winds,
        TILES.dragons
      );

      // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏Å‡∏° ---
      function initializeGame() {
        deck = [];
        userHand = [];
        botHand = [];
        userOpenMelds = [];
        botOpenMelds = [];
        discardedTiles = [];
        lastDiscardedTile = null;
        lastDiscarder = null;
        isUserDiscardPhase = false;
        isRiichiDeclared = { user: false, bot: false }; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Riichi
        deadWall = [];
        doraIndicators = [];

        createDeck();
        shuffleDeck();
        setupDeadWall(); // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Dead Wall ‡πÅ‡∏•‡∏∞ Dora
        dealTiles();
        renderHands();
        updateGameMessage('‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÑ‡∏î‡πâ');
        drawTileBtn.disabled = false;
        riichiBtn.disabled = true;
        currentTurn = 'user';
        clearDynamicActions();

        playerScores = { user: 25000, bot: 25000 }; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        roundWind = 'üÄÄ'; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏•‡∏°‡∏£‡∏≠‡∏ö
        playerWind = { user: 'üÄÄ', bot: 'üÄÅ' }; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏•‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
        isDealer = { user: true, bot: false }; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Dealer

        updateScoresDisplay(); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        hideWinButtons(); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ä‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà
      }

      // Helper function: Counts occurrences of each tile in a hand
      function countTilesInHand(hand) {
        const counts = {};
        for (const tile of hand) {
          counts[tile] = (counts[tile] || 0) + 1;
        }
        return counts;
      }

      // Helper function: Checks if a tile is a simple tile (2-8 of numbers)
      function isSimpleTile(tile) {
        const type = getTileType(tile);
        const value = getTileValue(tile);
        return (
          (type === 'characters' || type === 'dots' || type === 'bamboos') &&
          value >= 2 &&
          value <= 8
        );
      }

      // Helper function: Checks if a tile is a terminal tile (1 or 9 of numbers)
      function isTerminalTile(tile) {
        const type = getTileType(tile);
        const value = getTileValue(tile);
        return (
          (type === 'characters' || type === 'dots' || type === 'bamboos') &&
          (value === 1 || value === 9)
        );
      }

      // Helper function: Checks if a tile is an honor tile (winds or dragons)
      function isHonorTile(tile) {
        return TILES.winds.includes(tile) || TILES.dragons.includes(tile);
      }

      // Main function to find winning patterns (4 groups and 1 pair, or special hands)
      // This is a recursive function that tries to form groups from the hand.
      function findWinningPattern(hand, melds = [], pair = null) {
        // Sort the hand to make processing easier
        sortHand(hand);

        // Base case: If no tiles left, a valid pattern is found
        if (hand.length === 0) {
          return {
            type: 'standard', // Standard 4 groups and 1 pair
            details: {
              melds: melds,
              pair: pair,
              fullHand: hand, // This will be the original full hand for reference
            },
          };
        }

        // --- Check for special winning patterns first (if not already handled) ---
        // These typically don't follow the 4 groups + 1 pair rule
        // NOTE: Chiitoitsu and Kokushi Musou checks are usually done *before* calling this function,
        // or within `isWinningHand` to return early.
        // For simplicity, this `findWinningPattern` focuses on standard hands.

        // If a pair has not been found yet, try to find one
        if (pair === null) {
          for (let i = 0; i < hand.length; i++) {
            if (hand[i] === hand[i + 1]) {
              // Found a pair
              const remainingHand = [...hand];
              remainingHand.splice(i, 2); // Remove the pair
              const result = findWinningPattern(remainingHand, melds, hand[i]);
              if (result) {
                // Attach the original fullHand for consistency
                result.details.fullHand = [
                  ...hand,
                  ...melds.flat(),
                  pair,
                ].sort(); // Reconstruct for full reference
                return result;
              }
            }
          }
        } else {
          // If a pair is already found, try to form melds
          const counts = countTilesInHand(hand);
          const uniqueTiles = Object.keys(counts).sort(
            (a, b) => getTileValue(a) - getTileValue(b)
          );

          for (const tile of uniqueTiles) {
            // Try to form a triplet (Pon)
            if (counts[tile] >= 3) {
              const remainingHand = [];
              for (const t in counts) {
                if (t === tile) {
                  for (let k = 0; k < counts[t] - 3; k++) remainingHand.push(t);
                } else {
                  for (let k = 0; k < counts[t]; k++) remainingHand.push(t);
                }
              }
              const newMelds = [...melds, [tile, tile, tile]];
              const result = findWinningPattern(remainingHand, newMelds, pair);
              if (result) return result;
            }

            // Try to form a sequence (Chi)
            const type = getTileType(tile);
            const value = getTileValue(tile);
            if (
              (type === 'characters' ||
                type === 'dots' ||
                type === 'bamboos') &&
              value <= 7
            ) {
              const tile2 = TILES[type][value + 1];
              const tile3 = TILES[type][value + 2];

              if (
                counts[tile] >= 1 &&
                counts[tile2] >= 1 &&
                counts[tile3] >= 1
              ) {
                const remainingHand = [];
                for (const t in counts) {
                  if (t === tile) {
                    for (let k = 0; k < counts[t] - 1; k++)
                      remainingHand.push(t);
                  } else if (t === tile2) {
                    for (let k = 0; k < counts[t] - 1; k++)
                      remainingHand.push(t);
                  } else if (t === tile3) {
                    for (let k = 0; k < counts[t] - 1; k++)
                      remainingHand.push(t);
                  } else {
                    for (let k = 0; k < counts[t]; k++) remainingHand.push(t);
                  }
                }
                const newMelds = [...melds, [tile, tile2, tile3]];
                const result = findWinningPattern(
                  remainingHand,
                  newMelds,
                  pair
                );
                if (result) return result;
              }
            }
          }
        }

        return null; // No winning pattern found
      }

      // Helper function to get the type of a tile (characters, dots, bamboos, winds, dragons)
      function getTileType(tile) {
        if (TILES.characters.includes(tile)) return 'characters';
        if (TILES.dots.includes(tile)) return 'dots';
        if (TILES.bamboos.includes(tile)) return 'bamboos';
        if (TILES.winds.includes(tile)) return 'winds';
        if (TILES.dragons.includes(tile)) return 'dragons';
        return null;
      }

      // Helper function to get the numeric value of a tile (1-9 for numbers, 0 for winds/dragons for sorting purposes)
      function getTileValue(tile) {
        let type = getTileType(tile);
        if (type === 'characters') return TILES.characters.indexOf(tile) + 1;
        if (type === 'dots') return TILES.dots.indexOf(tile) + 1;
        if (type === 'bamboos') return TILES.bamboos.indexOf(tile) + 1;
        // For winds and dragons, assign a numerical value for consistent sorting
        // Winds: East=1, South=2, West=3, North=4
        // Dragons: Red=1, White=2, Green=3
        if (type === 'winds') return TILES.winds.indexOf(tile) + 1;
        if (type === 'dragons') return TILES.dragons.indexOf(tile) + 1;
        return 0; // Should not happen for valid tiles
      }

      // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô sortHand ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ---
      function sortHand(hand) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ hand ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° sort
        if (!Array.isArray(hand)) {
          console.error('sortHand ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå:', hand);
          return; // ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
        }

        hand.sort((a, b) => {
          const typeA = getTileType(a);
          const typeB = getTileType(b);
          const valueA = getTileValue(a);
          const valueB = getTileValue(b);

          // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏û‡πà (‡πÄ‡∏ä‡πà‡∏ô Manzu ‡∏Å‡πà‡∏≠‡∏ô Pinzu ‡∏Å‡πà‡∏≠‡∏ô Souzu ‡∏Å‡πà‡∏≠‡∏ô Winds ‡∏Å‡πà‡∏≠‡∏ô Dragons)
          const typeOrder = {
            characters: 1,
            dots: 2,
            bamboos: 3,
            winds: 4,
            dragons: 5,
          };

          const orderA = typeOrder[typeA];
          const orderB = typeOrder[typeB];

          if (orderA !== orderB) {
            return orderA - orderB; // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏û‡πà
          } else {
            return valueA - valueB; // ‡∏´‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
          }
        });
      }

      // --- Update isWinningHand to use findWinningPattern ---
      function isWinningHand(hand) {
        // Always sort the hand for consistent processing
        sortHand(hand);
        const counts = countTilesInHand(hand);

        // 1. Check for Kokushi Musou (Thirteen Orphans)
        const kokushiTiles = [
          'üÄá',
          'üÄâ',
          'üÄê',
          'üÄí',
          'üÄô',
          'üÄõ', // Terminals 1,9 of Manzu, Pinzu, Souzu
          'üÄÄ',
          'üÄÅ',
          'üÄÇ',
          'üÄÉ', // Winds (East, South, West, North)
          'üÄÑ',
          'üÄÖ',
          'üÄÜ', // Dragons (Red, White, Green)
        ];
        let hasAllKokushi = true;
        let hasPairInKokushi = false;
        for (const tile of kokushiTiles) {
          if (!counts[tile]) {
            hasAllKokushi = false;
            break;
          }
          if (counts[tile] >= 2) {
            hasPairInKokushi = true;
          }
        }
        if (hasAllKokushi && hasPairInKokushi && hand.length === 14) {
          return { type: 'kokushi_musou' };
        }

        // 2. Check for Chiitoitsu (Seven Pairs)
        let uniquePairs = 0;
        let isChiitoitsu = true;
        for (const tile in counts) {
          if (counts[tile] === 2) {
            uniquePairs++;
          } else if (counts[tile] !== 0) {
            // Should only have pairs
            isChiitoitsu = false;
            break;
          }
        }
        if (isChiitoitsu && uniquePairs === 7 && hand.length === 14) {
          return { type: 'chiitoitsu' };
        }

        // 3. Check for standard 4 groups and 1 pair
        // The recursive findWinningPattern tries to find this structure
        const standardPattern = findWinningPattern(hand);
        if (standardPattern) {
          return standardPattern;
        }

        return null; // No winning hand found
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ö‡∏ô UI
      function updateScoresDisplay() {
        if (userScoreEl)
          userScoreEl.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏∏‡∏ì: ${playerScores.user}`;
        if (botScoreEl)
          botScoreEl.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ö‡∏≠‡∏ó: ${playerScores.bot}`;
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ä‡∏ô‡∏∞
      function hideWinButtons() {
        if (tsumoBtn) tsumoBtn.style.display = 'none';
        if (ronBtn) ronBtn.style.display = 'none';
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ä‡∏ô‡∏∞
      function showWinButtons() {
        if (tsumoBtn) tsumoBtn.style.display = 'inline-block';
        if (ronBtn) ronBtn.style.display = 'inline-block';
      }

      // Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Tsumo/Ron (‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô HTML)
      if (tsumoBtn) {
        tsumoBtn.addEventListener('click', () => {
          if (currentTurn === 'user_action_check' && lastDiscarder === null) {
            // Tsumo ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡∏ô‡∏∞
            declareWin('user', 'tsumo', userHand[userHand.length - 1]); // ‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏à‡∏±‡πà‡∏ß‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          } else {
            updateGameMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Tsumo ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ');
          }
        });
      }

      if (ronBtn) {
        ronBtn.addEventListener('click', () => {
          if (
            currentTurn === 'user_action_check' &&
            lastDiscarder !== null &&
            lastDiscardedTile !== null
          ) {
            // Ron ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà
            declareWin('user', 'ron', lastDiscardedTile);
          } else {
            updateGameMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Ron ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ');
          }
        });
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏£‡∏±‡∏ö‡πÑ‡∏û‡πà
      function createDeck() {
        for (const type in TILES) {
          TILES[type].forEach((tile) => {
            for (let i = 0; i < 4; i++) {
              // ‡πÑ‡∏û‡πà‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÉ‡∏ö‡∏°‡∏µ 4 ‡∏ä‡∏∏‡∏î
              deck.push(tile);
            }
          });
        }
      }

      // ‡∏™‡∏±‡∏ö‡πÑ‡∏û‡πà
      function shuffleDeck() {
        for (let i = deck.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [deck[i], deck[j]] = [deck[j], deck[i]];
        }
      }

      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Dead Wall ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡πà‡∏ß Dora Indicator
      function setupDeadWall() {
        // Dead Wall ‡∏°‡∏µ 14 ‡πÉ‡∏ö (7 ‡∏Ñ‡∏π‡πà)
        // 5 ‡∏Ñ‡∏π‡πà‡πÅ‡∏£‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Kan (4) ‡πÅ‡∏•‡∏∞ Dora Indicator (1)
        // ‡∏≠‡∏µ‡∏Å 2 ‡∏Ñ‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Ura-Dora (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        for (let i = 0; i < 14; i++) {
          deadWall.push(deck.pop());
        }
        // ‡πÑ‡∏û‡πà‡πÅ‡∏£‡∏Å‡πÉ‡∏ô Dead Wall (‡πÉ‡∏ö‡∏ó‡∏µ‡πà 3 ‡∏à‡∏≤‡∏Å‡∏ã‡πâ‡∏≤‡∏¢) ‡πÄ‡∏õ‡πá‡∏ô Dora Indicator
        doraIndicators.push(deadWall[4]); // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÉ‡∏ö‡∏ó‡∏µ‡πà 5 ‡πÄ‡∏õ‡πá‡∏ô Dora indicator
        // console.log("Dora Indicator:", doraIndicators[0]); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Debug
      }

      // ‡πÅ‡∏à‡∏Å‡πÑ‡∏û‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡∏°‡∏µ 13 ‡πÉ‡∏ö)
      function dealTiles() {
        for (let i = 0; i < 13; i++) {
          // ‡πÅ‡∏à‡∏Å 13 ‡πÉ‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô
          userHand.push(deck.pop());
          botHand.push(deck.pop());
        }
        sortHand(userHand); // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏û‡πà‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
        sortHand(botHand); // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏û‡πà‡∏ö‡∏≠‡∏ó‡∏î‡πâ‡∏ß‡∏¢ (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô)
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏û‡πà‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
      function renderHands() {
        userTilesEl.innerHTML = '';
        userHand.forEach((tile) => {
          const tileEl = document.createElement('span');
          tileEl.classList.add('tile');
          tileEl.textContent = tile;
          // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÅ‡∏•‡πâ‡∏ß
          // ‡∏ñ‡πâ‡∏≤ Riichi ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
          if (currentTurn === 'user' && isUserDiscardPhase) {
            tileEl.addEventListener('click', () =>
              discardTile(tile, userHand, userTilesEl)
            );
          }
          userTilesEl.appendChild(tileEl);
        });

        // ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏û‡πà‡∏ö‡∏≠‡∏ó‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ '?' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô
        botTilesEl.innerHTML = '';
        botHand.forEach(() => {
          const tileEl = document.createElement('span');
          tileEl.classList.add('tile');
          tileEl.textContent = 'üÄ´'; // ‡πÉ‡∏ä‡πâ emoji ‡πÑ‡∏û‡πà‡∏ô‡∏Å‡∏Å‡∏£‡∏∞‡∏à‡∏≠‡∏Å‡πÅ‡∏ó‡∏ô
          botTilesEl.appendChild(tileEl);
        });

        discardedTilesEl.innerHTML = '';
        discardedTiles.forEach((tile) => {
          const tileEl = document.createElement('span');
          tileEl.classList.add('tile');
          tileEl.textContent = tile;
          discardedTilesEl.appendChild(tileEl);
        });

        renderOpenMelds(userOpenMelds, userOpenMeldsEl);
        renderOpenMelds(botOpenMelds, botOpenMeldsEl);
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î (Chi/Pon/Kan)
      function renderOpenMelds(meldsArray, targetElement) {
        targetElement.innerHTML = '';
        if (meldsArray.length > 0) {
          const title = document.createElement('div');
          title.textContent = '‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î:';
          targetElement.appendChild(title);
        }
        meldsArray.forEach((meldObj) => {
          const meldGroupEl = document.createElement('div');
          meldGroupEl.classList.add('meld-group');
          meldObj.tiles.forEach((tile) => {
            // ‡πÉ‡∏ä‡πâ meldObj.tiles
            const tileEl = document.createElement('span');
            tileEl.classList.add('tile');
            tileEl.textContent = tile;
            tileEl.style.cursor = 'default'; // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏û‡πà‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î
            tileEl.style.transform = 'none'; // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ hover effect
            meldGroupEl.appendChild(tileEl);
          });
          targetElement.appendChild(meldGroupEl);
        });
      }

      // ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° Chi/Pon/Kan
      function clearDynamicActions() {
        dynamicActionsEl.innerHTML = '';
      }

      // --- ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏° ---

      // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà
      drawTileBtn.addEventListener('click', () => {
        if (currentTurn !== 'user' || deck.length === 0 || isUserDiscardPhase) {
          updateGameMessage(
            '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì, ‡πÑ‡∏û‡πà‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß, ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà!'
          );
          return;
        }
        if (isRiichiDeclared.user) {
          updateGameMessage(
            '‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Riichi ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ä‡∏ô‡∏∞‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ Kan'
          );
          return;
        }

        const newTile = deck.pop();
        userHand.push(newTile);
        sortHand(userHand);
        isUserDiscardPhase = true;
        renderHands();
        updateGameMessage(`‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏î‡πâ‡πÑ‡∏û‡πà ${newTile} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà 1 ‡πÉ‡∏ö`);
        drawTileBtn.disabled = true;
        riichiBtn.disabled = !canRiichi(
          userHand,
          userOpenMelds,
          isRiichiDeclared.user
        );

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Tsumo ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà
        const winResult = isWinningHand(userHand);
        if (winResult) {
          showWinButtons(); // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Tsumo/Ron
          updateGameMessage(
            `‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏î‡πâ‡πÑ‡∏û‡πà ${newTile}. ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Tsumo ‡πÑ‡∏î‡πâ! ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà`
          );
          // ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏î Tsumo ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà
        } else {
          hideWinButtons();
        }
      });

      // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà
      function discardTile(tileToDiscard, hand, handEl) {
        // ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏ü‡∏™‡∏Å‡∏≤‡∏£‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà
        if (currentTurn !== 'user' || !isUserDiscardPhase) {
          updateGameMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏¥‡πâ‡∏á!');
          return;
        }
        // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô Riichi ‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ Tenpai
        // (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏°‡∏≤‡∏Å ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Algorithm ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Agari-gata)
        if (isRiichiDeclared.user) {
          // Placeholder: ‡πÉ‡∏ô‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡πÉ‡∏ö‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤ Tenpai ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏±‡∏Å‡∏©‡∏≤ Tenpai ‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏Å‡∏é (Furikomi) ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏û‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          // ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
          updateGameMessage(
            '‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Riichi. ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á Tenpai ‡∏≠‡∏¢‡∏π‡πà!'
          );
        }

        hideWinButtons(); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ä‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà

        const index = hand.indexOf(tileToDiscard);
        if (index > -1) {
          hand.splice(index, 1);
          lastDiscardedTile = tileToDiscard; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ó‡∏¥‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          lastDiscarder = 'user'; // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà
          discardedTiles.push(tileToDiscard);
          isUserDiscardPhase = false; // ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏ü‡∏™‡∏Å‡∏≤‡∏£‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
          renderHands(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≠‡∏á‡∏ó‡∏¥‡πâ‡∏á
          updateGameMessage(`‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà ${tileToDiscard}`);

          // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà ‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏ó‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Chi/Pon/Kan
          clearDynamicActions(); // ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏ó
          currentTurn = 'bot_action_check'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó
          setTimeout(checkBotActions, 1000); // ‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏ó‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö action
        } else {
          updateGameMessage('‡πÑ‡∏û‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì');
        }
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Action ‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó (Chi/Pon/Kan)
      function checkBotActions() {
        clearDynamicActions();

        if (!lastDiscardedTile) {
          // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏¥‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          botTurn();
          return;
        }

        let canPerformAction = false;
        let canWin = false; // Flag for Ron

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Ron
        const winResult = isWinningHand([...userHand, lastDiscardedTile]); // ‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏¥‡πâ‡∏á‡∏°‡∏≤
        if (winResult) {
          // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Yaku ‡∏î‡πâ‡∏ß‡∏¢!
          const tempHandForYakuCheck = [...userHand, lastDiscardedTile];
          sortHand(tempHandForYakuCheck);
          const yakuFound = findYaku(
            winResult,
            tempHandForYakuCheck,
            userOpenMelds,
            lastDiscardedTile,
            'ron',
            {
              isRiichiDeclared: isRiichiDeclared.user,
              doraIndicators: doraIndicators,
              roundWind: roundWind,
              playerWind: playerWind.user,
            }
          );
          if (yakuFound.some((yaku) => yaku.name !== 'Dora' || yaku.han > 0)) {
            // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏¢‡∏≤‡∏Å‡∏∏‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Dora ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 Han (‡∏´‡∏£‡∏∑‡∏≠ Yakuman)
            canWin = true;
            showWinButtons(); // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Ron
            updateGameMessage(
              `‡πÑ‡∏û‡πà ${lastDiscardedTile} ‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏ó‡∏ó‡∏¥‡πâ‡∏á‡∏°‡∏≤ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Ron ‡πÑ‡∏î‡πâ!`
            );
          }
        }

        // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Chi/Pon/Kan) ...
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ action ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Chi/Pon/Kan) ‡∏´‡∏£‡∏∑‡∏≠ Ron ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Skip
        if (canPerformAction || canWin) {
          const skipBtn = document.createElement('button');
          skipBtn.textContent = '‡∏ú‡πà‡∏≤‡∏ô';
          skipBtn.addEventListener('click', () => {
            clearDynamicActions();
            hideWinButtons(); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ä‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏ú‡πà‡∏≤‡∏ô
            currentTurn = 'user';
            drawTileBtn.disabled = false;
            riichiBtn.disabled = !canRiichi(
              userHand,
              userOpenMelds,
              isRiichiDeclared.user
            );
            updateGameMessage('‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡πà‡∏≤‡∏ô ‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà');
          });
          dynamicActionsEl.appendChild(skipBtn);
        } else {
          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ action ‡πÉ‡∏î‡πÜ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ä‡∏ô‡∏∞ ‡πÉ‡∏´‡πâ‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà
          currentTurn = 'user';
          drawTileBtn.disabled = false;
          riichiBtn.disabled = !canRiichi(
            userHand,
            userOpenMelds,
            isRiichiDeclared.user
          );
          updateGameMessage('‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà');
          hideWinButtons();
        }

        botTurn();
      }

      // ‡∏ö‡∏≠‡∏ó‡πÄ‡∏•‡πà‡∏ô (‡∏à‡∏±‡πà‡∏ß‡πÅ‡∏•‡∏∞‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà)
      function botTurn() {
        if (deck.length === 0 && deadWall.length === 0) {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á deck ‡πÅ‡∏•‡∏∞ deadWall
          updateGameMessage('‡πÑ‡∏û‡πà‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡∏•‡∏á (Ryuukyoku)');
          drawTileBtn.disabled = true;
          currentTurn = 'game_over';
          return;
        }

        updateGameMessage('‡∏ö‡∏≠‡∏ó‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà...');
        setTimeout(() => {
          // ‡∏ö‡∏≠‡∏ó‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà
          let newTile;
          if (deck.length > 0) {
            newTile = deck.pop();
          } else {
            // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏û‡πà‡πÉ‡∏ô deck ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞ bot ‡∏ï‡πâ‡∏≠‡∏á Kan ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏û‡πà‡πÉ‡∏ô deadWall ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)
            updateGameMessage('‡πÑ‡∏û‡πà‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡∏•‡∏á');
            currentTurn = 'game_over';
            return;
          }

          botHand.push(newTile);
          sortHand(botHand); // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏û‡πà‡∏ö‡∏≠‡∏ó (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô)

          // ‡∏ö‡∏≠‡∏ó‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ß‡∏Å" (‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
          // ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô Yaku ‡∏´‡∏£‡∏∑‡∏≠ Tenpai
          const tileCounts = {};
          botHand.forEach((tile) => {
            tileCounts[tile] = (tileCounts[tile] || 0) + 1;
          });

          let tileToDiscard = botHand[0]; // ‡πÑ‡∏û‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏¥‡πâ‡∏á
          let minCount = 5; // ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 4 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏û‡πà‡∏°‡∏µ 4 ‡πÉ‡∏ö‡∏ï‡πà‡∏≠‡∏ä‡∏ô‡∏¥‡∏î

          // ‡∏´‡∏≤‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡πâ‡∏≥‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
          for (const tile of botHand) {
            if (tileCounts[tile] < minCount) {
              minCount = tileCounts[tile];
              tileToDiscard = tile;
            }
          }

          const indexToDiscard = botHand.indexOf(tileToDiscard);
          botHand.splice(indexToDiscard, 1);
          lastDiscardedTile = tileToDiscard;
          lastDiscarder = 'bot'; // ‡∏ö‡∏≠‡∏ó‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà
          discardedTiles.push(tileToDiscard);

          renderHands(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
          updateGameMessage(`‡∏ö‡∏≠‡∏ó‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà ${tileToDiscard}`);

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Tsumo ‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó
          const botWinResult = isWinningHand(botHand);
          if (botWinResult) {
            // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Yaku ‡∏î‡πâ‡∏ß‡∏¢!
            const yakuFound = findYaku(
              botWinResult,
              botHand,
              botOpenMelds,
              botHand[botHand.length - 1], // ‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏ó‡∏à‡∏±‡πà‡∏ß‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
              'tsumo',
              {
                isRiichiDeclared: isRiichiDeclared.bot,
                doraIndicators: doraIndicators,
                roundWind: roundWind,
                playerWind: playerWind.bot,
              }
            );
            if (
              yakuFound.some((yaku) => yaku.name !== 'Dora' || yaku.han > 0)
            ) {
              declareWin('bot', 'tsumo', botHand[botHand.length - 1]);
              return; // ‡∏ö‡∏≠‡∏ó‡∏ä‡∏ô‡∏∞ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà
            }
          }

          // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏≠‡∏ó‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Chi/Pon/Kan
          currentTurn = 'user_action_check'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
          setTimeout(checkUserActions, 1000); // ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö action
        }, 1000);
      }

      /**
       * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ä‡∏ô‡∏∞ (Tsumo/Ron)
       * @param {string} winner - 'user' ‡∏´‡∏£‡∏∑‡∏≠ 'bot'
       * @param {string} winType - 'tsumo' ‡∏´‡∏£‡∏∑‡∏≠ 'ron'
       * @param {string} winningTile - ‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡∏ô‡∏∞
       */
      function declareWin(winner, winType, winningTile) {
        let winningHand = [];
        let winningOpenMelds = [];
        let winnerIsDealerFlag = false;

        if (winner === 'user') {
          winningHand = [...userHand];
          winningOpenMelds = userOpenMelds;
          winnerIsDealerFlag = isDealer.user;
        } else {
          winningHand = [...botHand];
          winningOpenMelds = botOpenMelds;
          winnerIsDealerFlag = isDealer.bot;
        }

        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Ron, ‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Yaku
        if (winType === 'ron' && !winningHand.includes(winningTile)) {
          winningHand.push(winningTile);
          sortHand(winningHand);
        }

        const winResult = isWinningHand(winningHand);
        if (!winResult) {
          updateGameMessage(
            '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏°‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ä‡∏ô‡∏∞ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 4 ‡∏Å‡∏•‡∏∏‡πà‡∏° 1 ‡∏Ñ‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠ Yaku ‡∏û‡∏¥‡πÄ‡∏®‡∏©)'
          );
          return;
        }

        const yakuFound = findYaku(
          winResult,
          winningHand,
          winningOpenMelds,
          winningTile,
          winType,
          {
            isRiichiDeclared:
              winner === 'user' ? isRiichiDeclared.user : isRiichiDeclared.bot,
            doraIndicators: doraIndicators,
            roundWind: roundWind,
            playerWind: winner === 'user' ? playerWind.user : playerWind.bot,
          }
        );

        if (yakuFound.length === 0) {
          updateGameMessage(
            `${
              winner === 'user' ? '‡∏Ñ‡∏∏‡∏ì' : '‡∏ö‡∏≠‡∏ó'
            }‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≤‡∏Å‡∏∏ (Han) ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ä‡∏ô‡∏∞!`
          );
          // ‡πÉ‡∏ô‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡∏°‡∏µ Chombo ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡∏ô‡∏∞‡πÑ‡∏î‡πâ
          // ‡πÅ‡∏ï‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á
          hideWinButtons(); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ä‡∏ô‡∏∞‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Yaku
          // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Å‡∏é
          return;
        }

        const totalHan = yakuFound.reduce((sum, yaku) => sum + yaku.han, 0);
        const totalFu = calculateFu(
          winResult,
          winningOpenMelds,
          winningTile,
          winType,
          {
            roundWind: roundWind,
            playerWind: winner === 'user' ? playerWind.user : playerWind.bot,
          }
        );

        const scoreResult = calculateScore(
          totalHan,
          totalFu,
          winType,
          winnerIsDealerFlag
        );

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        if (winner === 'user') {
          playerScores.user += scoreResult.totalScore;
          if (winType === 'ron') {
            playerScores.bot -= scoreResult.totalScore; // ‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏ö‡∏≠‡∏ó‡∏ó‡∏µ‡πà‡∏ó‡∏¥‡πâ‡∏á
          } else if (winType === 'tsumo') {
            // Tsumo: Dealer ‡∏à‡πà‡∏≤‡∏¢ 2 ‡πÄ‡∏ó‡πà‡∏≤, Non-Dealer ‡∏à‡πà‡∏≤‡∏¢ 1 ‡πÄ‡∏ó‡πà‡∏≤
            if (winnerIsDealerFlag) {
              // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏õ‡πá‡∏ô Dealer
              playerScores.bot -= scoreResult.otherPlayers; // bot ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
            } else {
              // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Dealer
              playerScores.bot -= scoreResult.otherPlayers; // bot ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ (1x baseScore)
              // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 3 ‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô Dealer ‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ô‡πÄ‡∏Å‡∏° 3/4 ‡∏Ñ‡∏ô
            }
          }
        } else {
          // ‡∏ö‡∏≠‡∏ó‡∏ä‡∏ô‡∏∞
          playerScores.bot += scoreResult.totalScore;
          if (winType === 'ron') {
            playerScores.user -= scoreResult.totalScore; // ‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏¥‡πâ‡∏á
          } else if (winType === 'tsumo') {
            if (winnerIsDealerFlag) {
              // ‡∏ö‡∏≠‡∏ó‡πÄ‡∏õ‡πá‡∏ô Dealer
              playerScores.user -= scoreResult.otherPlayers; // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
            } else {
              // ‡∏ö‡∏≠‡∏ó‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Dealer
              playerScores.user -= scoreResult.otherPlayers; // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
              // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 3 ‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô Dealer ‡∏î‡πâ‡∏ß‡∏¢
            }
          }
        }

        updateScoresDisplay(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô

        const yakuNames = yakuFound
          .map((y) => `${y.name} (${y.han} Han)`)
          .join(', ');
        updateGameMessage(
          `${winner === 'user' ? '‡∏Ñ‡∏∏‡∏ì' : '‡∏ö‡∏≠‡∏ó'}‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß! ${
            winType === 'tsumo' ? 'Tsumo' : 'Ron'
          }! Yaku: ${yakuNames}. ‡∏£‡∏ß‡∏° ${totalHan} Han, ${totalFu} Fu. ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${
            scoreResult.totalScore
          }!`
        );

        drawTileBtn.disabled = true;
        riichiBtn.disabled = true;
        hideWinButtons();
        currentTurn = 'game_over'; // ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏ö‡πÅ‡∏Ñ‡πà‡∏£‡∏≠‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏ö)

        // TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
        // ‡πÄ‡∏ä‡πà‡∏ô: ‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà"
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Action ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (Chi/Pon/Kan)
      function checkUserActions() {
        clearDynamicActions(); // ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô

        if (!lastDiscardedTile) {
          // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏¥‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Pon/Kan ‡πÅ‡∏•‡∏∞‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
          currentTurn = 'user';
          drawTileBtn.disabled = false;
          riichiBtn.disabled = !canRiichi(
            userHand,
            userOpenMelds,
            isRiichiDeclared.user
          );
          updateGameMessage('‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà');
          return;
        }

        let canPerformAction = false;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Pon
        if (canPon(userHand, lastDiscardedTile)) {
          const ponBtn = document.createElement('button');
          ponBtn.textContent = 'Pon';
          ponBtn.addEventListener('click', () => {
            performPon(userHand, lastDiscardedTile, userOpenMelds);
            clearDynamicActions();
            currentTurn = 'user'; // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Pon
            isUserDiscardPhase = true; // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà
            updateGameMessage('‡∏Ñ‡∏∏‡∏ì Pon! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà 1 ‡πÉ‡∏ö');
            drawTileBtn.disabled = true; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡πà‡∏ß‡∏ã‡πâ‡∏≥
            isRiichiDeclared.user = false; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Riichi ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß
            riichiBtn.disabled = true; // ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Riichi ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏∑‡∏≠
            renderHands(); // Render ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏û‡πà‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ
          });
          dynamicActionsEl.appendChild(ponBtn);
          canPerformAction = true;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Chi (‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏¥‡πâ‡∏á‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤" ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô)
        // ‡πÉ‡∏ô‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏ö‡∏≠‡∏ó‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô lastDiscarder ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 'bot'
        if (lastDiscarder === 'bot') {
          const chiOptions = canChi(userHand, lastDiscardedTile);
          if (chiOptions.length > 0) {
            chiOptions.forEach((option) => {
              const chiBtn = document.createElement('button');
              chiBtn.textContent = `Chi (${option.join('')})`; // ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Chi
              chiBtn.addEventListener('click', () => {
                performChi(userHand, lastDiscardedTile, option, userOpenMelds);
                clearDynamicActions();
                currentTurn = 'user'; // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Chi
                isUserDiscardPhase = true; // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà
                updateGameMessage('‡∏Ñ‡∏∏‡∏ì Chi! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà 1 ‡πÉ‡∏ö');
                drawTileBtn.disabled = true; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡πà‡∏ß‡∏ã‡πâ‡∏≥
                isRiichiDeclared.user = false; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Riichi ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß
                riichiBtn.disabled = true; // ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Riichi ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏∑‡∏≠
                renderHands(); // Render ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏û‡πà‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ
              });
              dynamicActionsEl.appendChild(chiBtn);
              canPerformAction = true;
            });
          }
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Kan (‡∏Ñ‡∏≤‡∏ô‡πÄ‡∏õ‡∏¥‡∏î: Minkan) ‡∏à‡∏≤‡∏Å‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏¥‡πâ‡∏á
        if (canKan(userHand, lastDiscardedTile)) {
          const kanBtn = document.createElement('button');
          kanBtn.textContent = 'Kan (Minkan)';
          kanBtn.addEventListener('click', () => {
            performMinkan(userHand, lastDiscardedTile, userOpenMelds);
            clearDynamicActions();
            // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÄ‡∏™‡∏£‡∏¥‡∏° (Rinshan Kaihou) ‡πÅ‡∏•‡∏∞‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà 1 ‡πÉ‡∏ö
            const newTile = deadWall.shift(); // ‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏≤‡∏Å Dead Wall
            if (!newTile) {
              updateGameMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÑ‡∏î‡πâ Dead Wall ‡∏´‡∏°‡∏î!');
              // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà Dead Wall ‡∏´‡∏°‡∏î (‡πÄ‡∏Å‡∏°‡∏≠‡∏≤‡∏à‡∏à‡∏ö‡∏•‡∏á)
              return;
            }
            userHand.push(newTile);
            sortHand(userHand);

            flipDora(); // ‡∏û‡∏•‡∏¥‡∏Å Dora indicator ‡πÄ‡∏û‡∏¥‡πà‡∏°

            currentTurn = 'user'; // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Kan
            isUserDiscardPhase = true; // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà
            updateGameMessage(
              `‡∏Ñ‡∏∏‡∏ì Kan ‡πÑ‡∏û‡πà ${lastDiscardedTile}! ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÄ‡∏™‡∏£‡∏¥‡∏° ${newTile} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà 1 ‡πÉ‡∏ö`
            );
            drawTileBtn.disabled = true; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡πà‡∏ß‡∏ã‡πâ‡∏≥
            isRiichiDeclared.user = false; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Riichi ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß
            riichiBtn.disabled = true; // ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Riichi ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏∑‡∏≠
            renderHands(); // Render ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏û‡πà‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ
          });
          dynamicActionsEl.appendChild(kanBtn);
          canPerformAction = true;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Ankan (‡∏Ñ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î) - ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ï‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏û‡πà‡∏ó‡∏¥‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Ankan ‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÑ‡∏û‡πà 4 ‡πÉ‡∏ö‡πÉ‡∏ô‡∏°‡∏∑‡∏≠
        // ‡πÅ‡∏•‡∏∞ Ankan ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏∑‡∏≠ ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏¢‡∏±‡∏á Riichi ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà
        const ankanOptions = canAnkan(userHand);
        if (ankanOptions.length > 0 && !isUserDiscardPhase) {
          // ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏ü‡∏™‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà
          ankanOptions.forEach((tile) => {
            const ankanBtn = document.createElement('button');
            ankanBtn.textContent = `Kan (Ankan ${tile})`;
            ankanBtn.addEventListener('click', () => {
              performAnkan(userHand, tile, userOpenMelds);
              clearDynamicActions();
              // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÄ‡∏™‡∏£‡∏¥‡∏° (Rinshan Kaihou) ‡πÅ‡∏•‡∏∞‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà 1 ‡πÉ‡∏ö
              const newTile = deadWall.shift(); // ‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏≤‡∏Å Dead Wall
              if (!newTile) {
                updateGameMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÑ‡∏î‡πâ Dead Wall ‡∏´‡∏°‡∏î!');
                return;
              }
              userHand.push(newTile);
              sortHand(userHand);
              flipDora(); // ‡∏û‡∏•‡∏¥‡∏Å Dora indicator ‡πÄ‡∏û‡∏¥‡πà‡∏°

              currentTurn = 'user'; // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Kan
              isUserDiscardPhase = true; // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà
              updateGameMessage(
                `‡∏Ñ‡∏∏‡∏ì Ankan ‡πÑ‡∏û‡πà ${tile}! ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÄ‡∏™‡∏£‡∏¥‡∏° ${newTile} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà 1 ‡πÉ‡∏ö`
              );
              drawTileBtn.disabled = true; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡πà‡∏ß‡∏ã‡πâ‡∏≥
              // Riichi ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢ Riichi ‡πÅ‡∏•‡πâ‡∏ß
              riichiBtn.disabled = !canRiichi(
                userHand,
                userOpenMelds,
                isRiichiDeclared.user
              ); // ‡∏¢‡∏±‡∏á Riichi ‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á Tenpai ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏∑‡πà‡∏ô
              renderHands();
            });
            dynamicActionsEl.appendChild(ankanBtn);
            canPerformAction = true;
          });
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Chakan (‡∏Ñ‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°) - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏û‡πà‡πÉ‡∏ö‡∏ó‡∏µ‡πà 4 ‡∏•‡∏á‡πÉ‡∏ô Pon ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
        const chakanOptions = canChakan(userHand, userOpenMelds);
        if (chakanOptions.length > 0 && !isUserDiscardPhase) {
          chakanOptions.forEach((meldObj) => {
            const chakanBtn = document.createElement('button');
            chakanBtn.textContent = `Kan (Chakan ${meldObj.tiles[0]})`;
            chakanBtn.addEventListener('click', () => {
              performChakan(userHand, meldObj, userOpenMelds);
              clearDynamicActions();
              const newTile = deadWall.shift(); // ‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏≤‡∏Å Dead Wall
              if (!newTile) {
                updateGameMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÑ‡∏î‡πâ Dead Wall ‡∏´‡∏°‡∏î!');
                return;
              }
              userHand.push(newTile);
              sortHand(userHand);
              flipDora(); // ‡∏û‡∏•‡∏¥‡∏Å Dora indicator ‡πÄ‡∏û‡∏¥‡πà‡∏°

              currentTurn = 'user';
              isUserDiscardPhase = true;
              updateGameMessage(
                `‡∏Ñ‡∏∏‡∏ì Chakan ‡πÑ‡∏û‡πà ${meldObj.tiles[0]}! ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà‡πÄ‡∏™‡∏£‡∏¥‡∏° ${newTile} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà 1 ‡πÉ‡∏ö`
              );
              drawTileBtn.disabled = true;
              isRiichiDeclared.user = false; // Chakan ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô ‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÄ‡∏Ñ‡∏¢ Riichi ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
              riichiBtn.disabled = true;
              renderHands();
            });
            dynamicActionsEl.appendChild(chakanBtn);
            canPerformAction = true;
          });
        }

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ action ‡πÉ‡∏î‡πÜ ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡πá‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥) ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏î "‡∏ú‡πà‡∏≤‡∏ô"
        if (!canPerformAction) {
          currentTurn = 'user';
          drawTileBtn.disabled = false;
          riichiBtn.disabled = !canRiichi(
            userHand,
            userOpenMelds,
            isRiichiDeclared.user
          );
          updateGameMessage('‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà');
        } else {
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° "‡∏ú‡πà‡∏≤‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "Skip" ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Chi/Pon/Kan
          const skipBtn = document.createElement('button');
          skipBtn.textContent = '‡∏ú‡πà‡∏≤‡∏ô';
          skipBtn.addEventListener('click', () => {
            clearDynamicActions();
            currentTurn = 'user';
            drawTileBtn.disabled = false;
            riichiBtn.disabled = !canRiichi(
              userHand,
              userOpenMelds,
              isRiichiDeclared.user
            );
            updateGameMessage('‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡πà‡∏≤‡∏ô ‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡πà‡∏ß‡πÑ‡∏û‡πà');
          });
          dynamicActionsEl.appendChild(skipBtn);
        }
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Chi (‡∏Å‡∏¥‡∏ô) ‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      // ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô array ‡∏Ç‡∏≠‡∏á‡πÑ‡∏û‡πà 2 ‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ Chi ‡πÑ‡∏î‡πâ
      function canChi(playerHand, lastDiscarded) {
        const options = [];
        const discardType = getTileType(lastDiscarded);
        const discardValue = getTileValue(lastDiscarded);

        // Chi ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡πÑ‡∏û‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        if (
          discardType &&
          (discardType === 'characters' ||
            discardType === 'dots' ||
            discardType === 'bamboos')
        ) {
          const potentialTiles = TILES[discardType];

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á copy ‡∏Ç‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Å‡∏±‡∏ö original array
          const handCopy = [...playerHand];
          const handCounts = countTilesInHand(handCopy);

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∏‡∏î (value-2, value-1, discarded) ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏¥‡∏ô 3 ‡∏î‡πâ‡∏ß‡∏¢ 1,2
          if (discardValue >= 3) {
            const tile1 = potentialTiles[discardValue - 3];
            const tile2 = potentialTiles[discardValue - 2];
            if (handCounts[tile1] && handCounts[tile2]) {
              options.push([tile1, tile2]);
            }
          }
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∏‡∏î (value-1, discarded, value+1) ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏¥‡∏ô 3 ‡∏î‡πâ‡∏ß‡∏¢ 2,4
          if (discardValue >= 2 && discardValue <= 8) {
            const tile1 = potentialTiles[discardValue - 2];
            const tile2 = potentialTiles[discardValue];
            if (handCounts[tile1] && handCounts[tile2]) {
              options.push([tile1, tile2]);
            }
          }
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∏‡∏î (discarded, value+1, value+2) ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏¥‡∏ô 3 ‡∏î‡πâ‡∏ß‡∏¢ 4,5
          if (discardValue <= 7) {
            const tile1 = potentialTiles[discardValue];
            const tile2 = potentialTiles[discardValue + 1];
            if (handCounts[tile1] && handCounts[tile2]) {
              options.push([tile1, tile2]);
            }
          }
        }
        return options; // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà Chi ‡πÑ‡∏î‡πâ
      }

      // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ Chi
      function performChi(playerHand, discardedTile, chiTiles, openMeldsArray) {
        // ‡∏•‡∏ö‡πÑ‡∏û‡πà 2 ‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Chi ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
        chiTiles.forEach((tile) => {
          const index = playerHand.indexOf(tile);
          if (index > -1) {
            playerHand.splice(index, 1);
          }
        });
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î Chi ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô openMeldsArray
        const meldTiles = chiTiles
          .concat(discardedTile)
          .sort(
            (a, b) => ALL_TILES_ORDER.indexOf(a) - ALL_TILES_ORDER.indexOf(b)
          );
        openMeldsArray.push({ type: 'chi', tiles: meldTiles });
        sortHand(playerHand); // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏°‡∏∑‡∏≠
        updateGameMessage(
          `‡∏Ñ‡∏∏‡∏ì Chi ‡πÑ‡∏û‡πà ${discardedTile} ‡∏î‡πâ‡∏ß‡∏¢ ${chiTiles.join('')}`
        );
        lastDiscardedTile = null; // ‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏¥‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Pon (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏á) ‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      function canPon(playerHand, lastDiscarded) {
        let count = 0;
        playerHand.forEach((tile) => {
          if (tile === lastDiscarded) {
            count++;
          }
        });
        return count >= 2;
      }

      // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ Pon
      function performPon(playerHand, discardedTile, openMeldsArray) {
        // ‡∏•‡∏ö‡πÑ‡∏û‡πà 2 ‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Pon ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
        let count = 0;
        for (let i = playerHand.length - 1; i >= 0; i--) {
          if (playerHand[i] === discardedTile && count < 2) {
            playerHand.splice(i, 1);
            count++;
          }
        }
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î Pon ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô openMeldsArray
        openMeldsArray.push({
          type: 'pon',
          tiles: [discardedTile, discardedTile, discardedTile],
        });
        sortHand(playerHand); // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏°‡∏∑‡∏≠
        updateGameMessage(`‡∏Ñ‡∏∏‡∏ì Pon ‡πÑ‡∏û‡πà ${discardedTile}`);
        lastDiscardedTile = null; // ‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏¥‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Kan (‡∏Ñ‡∏≤‡∏ô‡πÄ‡∏õ‡∏¥‡∏î: Minkan) ‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      function canKan(playerHand, lastDiscarded) {
        let count = 0;
        playerHand.forEach((tile) => {
          if (tile === lastDiscarded) {
            count++;
          }
        });
        return count >= 3; // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏û‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏≠‡∏µ‡∏Å 3 ‡πÉ‡∏ö‡πÉ‡∏ô‡∏°‡∏∑‡∏≠
      }

      // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ Kan (‡∏Ñ‡∏≤‡∏ô‡πÄ‡∏õ‡∏¥‡∏î: Minkan)
      function performMinkan(playerHand, discardedTile, openMeldsArray) {
        // ‡∏•‡∏ö‡πÑ‡∏û‡πà 3 ‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Kan ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
        let count = 0;
        for (let i = playerHand.length - 1; i >= 0; i--) {
          if (playerHand[i] === discardedTile && count < 3) {
            playerHand.splice(i, 1);
            count++;
          }
        }
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î Kan ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô openMeldsArray
        openMeldsArray.push({
          type: 'minkan',
          tiles: [discardedTile, discardedTile, discardedTile, discardedTile],
        });
        sortHand(playerHand); // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏°‡∏∑‡∏≠
        updateGameMessage(`‡∏Ñ‡∏∏‡∏ì Minkan ‡πÑ‡∏û‡πà ${discardedTile}`);
        lastDiscardedTile = null; // ‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏¥‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Ankan (‡∏Ñ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î) - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÑ‡∏û‡πà 4 ‡πÉ‡∏ö‡πÉ‡∏ô‡∏°‡∏∑‡∏≠
      function canAnkan(playerHand) {
        const possibleAnkans = [];
        const counts = countTilesInHand(playerHand);
        for (const tile in counts) {
          if (counts[tile] === 4) {
            possibleAnkans.push(tile);
          }
        }
        return possibleAnkans; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ array ‡∏Ç‡∏≠‡∏á‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Ankan ‡πÑ‡∏î‡πâ
      }

      // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ Ankan (‡∏Ñ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î)
      function performAnkan(playerHand, tileToKan, openMeldsArray) {
        // ‡∏•‡∏ö‡πÑ‡∏û‡πà 4 ‡πÉ‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
        let count = 0;
        for (let i = playerHand.length - 1; i >= 0; i--) {
          if (playerHand[i] === tileToKan && count < 4) {
            playerHand.splice(i, 1);
            count++;
          }
        }
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î Ankan ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô openMeldsArray (Ankan ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô meld ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏∑‡∏≠)
        openMeldsArray.push({
          type: 'ankan',
          tiles: [tileToKan, tileToKan, tileToKan, tileToKan],
        });
        sortHand(playerHand);
        updateGameMessage(`‡∏Ñ‡∏∏‡∏ì Ankan ‡πÑ‡∏û‡πà ${tileToKan}`);
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Chakan (‡∏Ñ‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°) - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏û‡πà‡πÉ‡∏ö‡∏ó‡∏µ‡πà 4 ‡∏•‡∏á‡πÉ‡∏ô Pon ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
      function canChakan(playerHand, openMeldsArray) {
        const possibleChakans = [];
        for (const meld of openMeldsArray) {
          if (meld.type === 'pon' && playerHand.includes(meld.tiles[0])) {
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏û‡πà‡πÉ‡∏ö‡∏ó‡∏µ‡πà 4 ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÑ‡∏û‡πà‡πÉ‡∏ô Pon ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
            possibleChakans.push(meld);
          }
        }
        return possibleChakans; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ array ‡∏Ç‡∏≠‡∏á meld ‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Chakan ‡πÑ‡∏î‡πâ
      }

      // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ Chakan (‡∏Ñ‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°)
      function performChakan(playerHand, ponMeld, openMeldsArray) {
        const tileToKan = ponMeld.tiles[0];
        const indexInHand = playerHand.indexOf(tileToKan);
        if (indexInHand > -1) {
          playerHand.splice(indexInHand, 1); // ‡∏•‡∏ö‡πÑ‡∏û‡πà‡πÉ‡∏ö‡∏ó‡∏µ‡πà 4 ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á meld ‡∏à‡∏≤‡∏Å 'pon' ‡πÄ‡∏õ‡πá‡∏ô 'chakan' ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏û‡πà
          ponMeld.type = 'chakan';
          ponMeld.tiles.push(tileToKan);
          sortHand(playerHand);
          updateGameMessage(`‡∏Ñ‡∏∏‡∏ì Chakan ‡πÑ‡∏û‡πà ${tileToKan}`);
        }
      }

      // ‡∏û‡∏•‡∏¥‡∏Å Dora indicator (‡∏à‡∏≤‡∏Å Dead Wall)
      function flipDora() {
        if (doraIndicators.length < 5 && deadWall.length > 0) {
          // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏•‡∏¥‡∏Å Dora ‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡πÉ‡∏ö
          const newDora = deadWall[4 + doraIndicators.length]; // ‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÉ‡∏ô Dead Wall
          if (newDora) {
            doraIndicators.push(newDora);
            // console.log("New Dora Indicator:", newDora); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Debug
            updateGameMessage(`‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏•‡∏¥‡∏Å Dora Indicator ‡πÉ‡∏´‡∏°‡πà: ${newDora}`);
          }
        }
      }

      // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Riichi (‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏°‡∏≤‡∏Å ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å) ---
     // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô canRiichi
     function canRiichi(hand, openMelds, isRiichiAlreadyDeclared) {
        if (openMelds.length > 0) { // Riichi requires a closed hand
          return false;
        }
        if (isRiichiAlreadyDeclared) { // Can only Riichi once
          return false;
        }
        if (deck.length < 4) { // Not enough tiles left to Riichi (usually 4 tiles left)
          // Some rulesets allow Riichi with fewer than 4 tiles, but 4 is common.
          return false;
        }

        const { isTenpai: handIsTenpai } = isTenpai(hand, openMelds); // ‡πÉ‡∏ä‡πâ isTenpai ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
        return handIsTenpai;
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÄ‡∏Å‡∏°
      function updateGameMessage(message) {
        gameMessageEl.textContent = message;
      }

      // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
      document.addEventListener('DOMContentLoaded', initializeGame);

      // Riichi button logic
      riichiBtn.addEventListener('click', () => {
        if (canRiichi(userHand, userOpenMelds, isRiichiDeclared.user)) {
          updateGameMessage('‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Riichi! ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà 1 ‡πÉ‡∏ö');
          isRiichiDeclared.user = true; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Riichi
          riichiBtn.disabled = true;
          drawTileBtn.disabled = true; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡πà‡∏ß‡∏ã‡πâ‡∏≥
          isUserDiscardPhase = true; // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà
          // Logic for Riichi, e.g., turn 90 degrees one discarded tile
          // ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é Riichi
          renderHands(); // Render ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏û‡πà‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏¥‡πâ‡∏á
        } else {
          updateGameMessage(
            '‡∏¢‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Riichi ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ Tenpai ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß)'
          );
        }
      });

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Tenpai ‡πÅ‡∏•‡∏∞ Winning Hand (‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î)
      // ‡∏Å‡∏≤‡∏£ Implement ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Algorithm ‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ
      // ‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û

      function countTilesInHand(hand) {
        const counts = {};
        hand.forEach((tile) => {
          counts[tile] = (counts[tile] || 0) + 1;
        });
        return counts;
      }

      /**
       * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
       * (‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Recursive Backtracking ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Optimized)
       *
       * @param {object} counts - Object ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏û‡πà‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏ô‡∏¥‡∏î
       * @param {number} requiredMelds - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á
       * @returns {boolean} true ‡∏ñ‡πâ‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡πÑ‡∏î‡πâ
       */
      function canFormMelds(counts, requiredMelds) {
        if (requiredMelds === 0) {
          // ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß
          // ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏û‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô counts ‡πÄ‡∏•‡∏¢
          return Object.values(counts).every((count) => count === 0);
        }

        // ‡∏´‡∏≤‡πÑ‡∏û‡πà‡πÉ‡∏ö‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤)
        const availableTiles = Object.keys(counts).filter(
          (tile) => counts[tile] > 0
        );
        if (availableTiles.length === 0) {
          // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏û‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
          return false;
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏û‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á Backtracking)
        availableTiles.sort(
          (a, b) => ALL_TILES_ORDER.indexOf(a) - ALL_TILES_ORDER.indexOf(b)
        );
        const firstTile = availableTiles[0];
        const firstTileType = getTileType(firstTile);
        const firstTileValue = getTileValue(firstTile);

        // 1. ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Pon (Triplet)
        if (counts[firstTile] >= 3) {
          counts[firstTile] -= 3;
          if (canFormMelds(counts, requiredMelds - 1)) return true;
          counts[firstTile] += 3; // backtrack
        }

        // 2. ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Chi (Sequence) - ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏û‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡πÑ‡∏û‡πà‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏¢‡∏®
        if (
          firstTileType &&
          (firstTileType === 'characters' ||
            firstTileType === 'dots' ||
            firstTileType === 'bamboos')
        ) {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏±‡∏ô (value+1, value+2) ‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if (firstTileValue !== null && firstTileValue <= 7) {
            // 7 ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà Chi ‡πÑ‡∏î‡πâ (7-8-9)
            const nextTile = TILES[firstTileType][firstTileValue]; // ‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ +1
            const nextNextTile = TILES[firstTileType][firstTileValue + 1]; // ‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ +2

            if (
              counts[firstTile] >= 1 &&
              counts[nextTile] >= 1 &&
              counts[nextNextTile] >= 1
            ) {
              counts[firstTile] -= 1;
              counts[nextTile] -= 1;
              counts[nextNextTile] -= 1;

              if (canFormMelds(counts, requiredMelds - 1)) return true;

              counts[firstTile] += 1; // backtrack
              counts[nextTile] += 1;
              counts[nextNextTile] += 1;
            }
          }
        }
        return false;
      }
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Helper: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Tenpai ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏£‡∏≠
function isTenpai(hand, openMelds = []) {
        const potentialWinningTiles = new Set();
        const allTiles = Object.values(TILES).flat(); // Get all possible tiles

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô 13 ‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏° Open Melds
        let baseHand = [...hand];
        // Note: For isTenpai, we usually check a 13-tile hand (before drawing the last one)
        // or a 14-tile hand that's one tile away from completion.
        // For simplicity here, we assume 'hand' is the current 13-tile hand before drawing.
        // If 'hand' includes the drawn tile already (14 tiles), remove one temporarily.

        if (baseHand.length % 3 === 2) { // If it's a 14-tile hand (just drawn a tile)
          // Temporarily remove each tile to check if removing it leads to Tenpai
          for (let i = 0; i < baseHand.length; i++) {
            const tempHand = [...baseHand];
            tempHand.splice(i, 1); // Remove one tile
            for (const testTile of allTiles) {
              const testHandWithWinTile = [...tempHand, testTile];
              if (isWinningHand(testHandWithWinTile)) {
                potentialWinningTiles.add(testTile);
              }
            }
          }
        } else { // If it's a 13-tile hand (before drawing or after discarding)
          for (const testTile of allTiles) {
            const testHandWithWinTile = [...baseHand, testTile];
            if (isWinningHand(testHandWithWinTile)) {
              potentialWinningTiles.add(testTile);
            }
          }
        }


        if (potentialWinningTiles.size > 0) {
          return { isTenpai: true, waits: Array.from(potentialWinningTiles) };
        }
        return { isTenpai: false, waits: [] };
      }
  
      function findYaku(
        winningPattern,
        fullHand,
        openMelds,
        winningTile,
        winType,
        gameState
      ) {
        const yakuList = [];
        const closedHandTiles = [...fullHand]; // ‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏°‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á

        // ‡∏•‡∏ö‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô openMelds ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å closedHandTiles ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏°‡∏∑‡∏≠‡∏õ‡∏¥‡∏î
        openMelds.forEach((meld) => {
          meld.tiles.forEach((tile) => {
            const index = closedHandTiles.indexOf(tile);
            if (index > -1) {
              closedHandTiles.splice(index, 1);
            }
          });
        });

        const isMenzen = openMelds.length === 0; // ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

        // Yakuman (Chiitoitsu, Kokushi Musou) - ‡∏ô‡∏±‡∏ö Han ‡πÅ‡∏¢‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
        if (winningPattern.type === 'chiitoitsu') {
          yakuList.push({ name: 'Chiitoitsu', han: 2 });
          // Chiitoitsu ‡∏°‡∏µ Han ‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß
          return yakuList; // Chiitoitsu ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö Yaku ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Dora/Ura-Dora
        } else if (winningPattern.type === 'kokushi_musou') {
          yakuList.push({ name: 'Kokushi Musou', han: 13 }); // Yakuman
          // Kokushi Musou ‡πÄ‡∏õ‡πá‡∏ô Yakuman ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö Yaku ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
          return yakuList;
        }

        // Yaku ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏õ‡∏¥‡∏î (Menzen)
        if (isMenzen) {
          // Yaku: Menzen Tsumo (Self-Draw with Closed Hand)
          if (winType === 'tsumo') {
            yakuList.push({ name: 'Menzen Tsumo', han: 1 });
          }

          // Yaku: Riichi (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
          if (gameState.isRiichiDeclared) {
            yakuList.push({ name: 'Riichi', han: 1 });
            // TODO: Ippatsu (First turn after Riichi) - Requires tracking turns
            // if (isIppatsu) yakuList.push({ name: 'Ippatsu', han: 1 });
            // TODO: Double Riichi (Riichi ‡πÉ‡∏ô‡∏ï‡∏≤‡πÅ‡∏£‡∏Å) - Requires tracking first turn
            // if (isDoubleRiichi) yakuList.push({ name: 'Double Riichi', han: 2 });
          }

          // Yaku: Pinfu (No Fu from Melds, Only Chi, Menzen Tsumo/Ron, Ryanmen Wait)
          // Pinfu ‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏°‡∏≤‡∏Å ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Fu ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏≠
          // ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Pon/Kan ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏õ‡∏¥‡∏î ‡πÅ‡∏•‡∏∞ pair ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏û‡πà‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Fu
          // ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Ryanmen (‡∏™‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á)
          let isPinfu = true;
          if (winningPattern.type === 'standard' && winType === 'tsumo') {
            // Pinfu Tsumo
            if (
              !winningPattern.details.melds.every((meld) => {
                const type = getTileType(meld[0]);
                const v0 = getTileValue(meld[0]);
                const v1 = getTileValue(meld[1]);
                const v2 = getTileValue(meld[2]);
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Chi (‡∏•‡∏≥‡∏î‡∏±‡∏ö) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                return (
                  type &&
                  (type === 'characters' ||
                    type === 'dots' ||
                    type === 'bamboos') &&
                  v0 === v1 - 1 &&
                  v1 === v2 - 1
                );
              })
            ) {
              isPinfu = false;
            }

            const pairTile = winningPattern.details.pair;
            const isYakuhaiPair =
              isHonorTile(pairTile) ||
              pairTile === gameState.roundWind ||
              pairTile === gameState.playerWind;
            if (isYakuhaiPair) isPinfu = false;

            // TODO: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Ryanmen Wait (‡∏Å‡∏≤‡∏£‡∏£‡∏≠ 2 ‡∏î‡πâ‡∏≤‡∏ô)
            // ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏°‡∏≤‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2 ‡πÉ‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Ryanmen ‡∏´‡∏£‡∏∑‡∏≠ Implement logic later
            const waitType = getWaitType(
              winningPattern.details.fullHand,
              winningPattern.details.pair,
              winningTile
            );
            if (waitType !== 'ryanmen') isPinfu = false;

            if (isPinfu) {
              yakuList.push({ name: 'Pinfu', han: 1 });
            }
          } else if (
            winningPattern.type === 'standard' &&
            winType === 'ron' &&
            isMenzen
          ) {
            // Pinfu Ron
            // Pinfu Ron ‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ Pinfu Tsumo ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏±‡∏ö Menzen Tsumo
            // ‡πÅ‡∏•‡∏∞ Fu = 30 ‡πÅ‡∏ó‡∏ô 20 (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö Fu ‡∏à‡∏≤‡∏Å melds/wait)
            // Logic ‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö Pinfu Tsumo
            let isPinfuRon = true;
            if (
              !winningPattern.details.melds.every((meld) => {
                const type = getTileType(meld[0]);
                const v0 = getTileValue(meld[0]);
                const v1 = getTileValue(meld[1]);
                const v2 = getTileValue(meld[2]);
                return (
                  type &&
                  (type === 'characters' ||
                    type === 'dots' ||
                    type === 'bamboos') &&
                  v0 === v1 - 1 &&
                  v1 === v2 - 1
                );
              })
            ) {
              isPinfuRon = false;
            }

            const pairTile = winningPattern.details.pair;
            const isYakuhaiPair =
              isHonorTile(pairTile) ||
              pairTile === gameState.roundWind ||
              pairTile === gameState.playerWind;
            if (isYakuhaiPair) isPinfuRon = false;

            const waitType = getWaitType(
              winningPattern.details.fullHand,
              winningPattern.details.pair,
              winningTile
            );
            if (waitType !== 'ryanmen') isPinfuRon = false;

            if (isPinfuRon) {
              yakuList.push({ name: 'Pinfu', han: 1 });
            }
          }

          // Yaku: Iipeikou (Pure Double Chii)
          if (winningPattern.type === 'standard') {
            const chiMelds = winningPattern.details.melds.filter((meld) => {
              const type = getTileType(meld[0]);
              const v0 = getTileValue(meld[0]);
              const v1 = getTileValue(meld[1]);
              const v2 = getTileValue(meld[2]);
              return (
                type &&
                (type === 'characters' ||
                  type === 'dots' ||
                  type === 'bamboos') &&
                v0 === v1 - 1 &&
                v1 === v2 - 1
              ); // Check if it's a sequence
            });

            // Check for two identical chi melds
            for (let i = 0; i < chiMelds.length; i++) {
              for (let j = i + 1; j < chiMelds.length; j++) {
                if (
                  chiMelds[i][0] === chiMelds[j][0] &&
                  chiMelds[i][1] === chiMelds[j][1] &&
                  chiMelds[i][2] === chiMelds[j][2]
                ) {
                  yakuList.push({ name: 'Iipeikou', han: 1 });
                  break;
                }
              }
              if (yakuList.some((y) => y.name === 'Iipeikou')) break;
            }
          }

          // Yaku: Sanankou (Three Closed Triplets)
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ Pon ‡∏õ‡∏¥‡∏î 3 ‡∏ä‡∏∏‡∏î
          if (winningPattern.type === 'standard') {
            const closedPonCount = winningPattern.details.melds.filter(
              (meld) =>
                meld.length === 3 &&
                meld[0] === meld[1] &&
                !openMelds.some(
                  (om) => om.type === 'pon' && om.tiles[0] === meld[0]
                ) // ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö Pon ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î
            ).length;
            if (closedPonCount === 3) {
              yakuList.push({ name: 'Sanankou', han: 2 });
            }
          }
        } // End of isMenzen

        // Yaku ‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏∑‡∏≠‡πÑ‡∏î‡πâ
        // Yaku: Tanyao (All Simples) - ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
        let isTanyao = true;
        for (const tile of fullHand) {
          if (!isSimpleTile(tile)) {
            isTanyao = false;
            break;
          }
        }
        if (isTanyao) {
          yakuList.push({ name: 'Tanyao', han: 1 });
        }

        // Yaku: Yakuhai (Dragon Triplets, Seat Wind, Round Wind) - ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
        const fullHandCounts = countTilesInHand(fullHand);
        if (fullHandCounts['üÄÑ'] >= 3) yakuList.push({ name: 'Hatsu', han: 1 });
        if (fullHandCounts['üÄÖ'] >= 3) yakuList.push({ name: 'Haku', han: 1 });
        if (fullHandCounts['üÄÜ'] >= 3) yakuList.push({ name: 'Chun', han: 1 });
        if (fullHandCounts[gameState.playerWind] >= 3)
          yakuList.push({ name: 'Jihai', han: 1 });
        if (fullHandCounts[gameState.roundWind] >= 3) {
          if (gameState.playerWind !== gameState.roundWind) {
            // ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏ã‡πâ‡∏≥‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            yakuList.push({ name: 'Ba-fu', han: 1 });
          } else {
            // ‡∏ñ‡πâ‡∏≤‡∏•‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Daburu-Ton/Nan ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏±‡∏ö Yaku ‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
            // For simplicity, just count one if it's the same wind.
            // Or handle Daburu-Ton/Nan separately if needed.
          }
        }

        // Yaku: Toitoi (All Triplets/Quads)
        // ‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Pon/Kan
        if (winningPattern.type === 'standard') {
          const allMeldsAreTriplets = winningPattern.details.melds.every(
            (meld) => meld.length === 3 && meld[0] === meld[1]
          );
          if (allMeldsAreTriplets) {
            yakuList.push({ name: 'Toitoi', han: 2 });
          }
        }

        // Yaku: Honitsu (Half Flush)
        // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏û‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏™‡∏≠‡∏á‡∏ä‡∏ô‡∏¥‡∏î: ‡πÑ‡∏û‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ä‡∏ô‡∏¥‡∏î ‡πÅ‡∏•‡∏∞‡πÑ‡∏û‡πà‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏¢‡∏®
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ type ‡∏Ç‡∏≠‡∏á‡πÑ‡∏û‡πà
        const uniqueTypes = new Set();
        let hasHonorTiles = false;
        let hasNumberTiles = false;
        let numberTileSuit = null; // 'characters', 'dots', 'bamboos'

        for (const tile of fullHand) {
          const type = getTileType(tile);
          uniqueTypes.add(type);
          if (isHonorTile(tile)) {
            hasHonorTiles = true;
          } else if (
            type === 'characters' ||
            type === 'dots' ||
            type === 'bamboos'
          ) {
            hasNumberTiles = true;
            if (!numberTileSuit) {
              numberTileSuit = type;
            } else if (numberTileSuit !== type) {
              // ‡∏°‡∏µ‡πÑ‡∏û‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏ä‡∏ô‡∏¥‡∏î
              numberTileSuit = 'mixed';
              break;
            }
          }
        }

        if (
          hasHonorTiles &&
          hasNumberTiles &&
          numberTileSuit !== 'mixed' &&
          uniqueTypes.size === 2
        ) {
          yakuList.push({ name: 'Honitsu', han: isMenzen ? 3 : 2 });
        }

        // Yaku: Chinitsu (Full Flush)
        // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏û‡πà‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏•‡πâ‡∏ß‡∏ô‡πÜ (Man/Pin/Sou) ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏û‡πà‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏¢‡∏®
        if (
          hasNumberTiles &&
          !hasHonorTiles &&
          numberTileSuit !== 'mixed' &&
          uniqueTypes.size === 1
        ) {
          yakuList.push({ name: 'Chinitsu', han: isMenzen ? 6 : 5 });
        }

        // Yaku: Dora (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
        let doraCount = 0;
        const actualDoraTiles = gameState.doraIndicators.map(getDoraTile);
        for (const dora of actualDoraTiles) {
          fullHand.forEach((tile) => {
            if (tile === dora) {
              doraCount++;
            }
          });
        }
        if (doraCount > 0) {
          yakuList.push({ name: 'Dora', han: doraCount }); // Dora ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ Han ‡∏´‡∏•‡∏≤‡∏¢ Han ‡πÑ‡∏î‡πâ
        }

        // Rule: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏¢‡∏≤‡∏Å‡∏∏ (Han) ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 Han (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô Tenhou/Chiihou/Renhou ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô Yakuman ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
        const totalHan = yakuList.reduce((sum, yaku) => sum + yaku.han, 0);
        if (totalHan === 0) {
          // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ Yaku ‡πÄ‡∏•‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡πÅ‡∏ï‡πà Dora ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢)
          // ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Tenhou/Chiihou/Renhou (‡∏ã‡∏∂‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å)
          // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡∏ô‡∏∞‡πÑ‡∏î‡πâ
          return [];
        }

        return yakuList;
      }

      // Helper: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏£‡∏≠ (Wait Type)
      // ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏Å‡πÉ‡∏ô‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á
      function getWaitType(fullHand, pairTile, winningTile) {
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö pair ‡πÅ‡∏•‡∏∞ melds ‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
        // ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å 2 ‡πÉ‡∏ö ‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á

        // simplified logic:
        const counts = countTilesInHand(fullHand);
        counts[pairTile] -= 2; // ‡∏•‡∏ö‡πÑ‡∏û‡πà‡∏Ñ‡∏π‡πà

        const tempHandWithoutPair = [];
        for (const tile in counts) {
          for (let i = 0; i < counts[tile]; i++) {
            tempHandWithoutPair.push(tile);
          }
        }
        sortHand(tempHandWithoutPair);

        // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö wait ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ (‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏Å)
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô 2 ‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Chi ‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞ winningTile ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á (Ryanmen)
        if (tempHandWithoutPair.length === 2) {
          const tile1 = tempHandWithoutPair[0];
          const tile2 = tempHandWithoutPair[1];
          const type1 = getTileType(tile1);
          const val1 = getTileValue(tile1);
          const type2 = getTileType(tile2);
          const val2 = getTileValue(tile2);

          if (type1 === type2) {
            // ‡πÄ‡∏ä‡πà‡∏ô üÄá,üÄâ  ‡∏£‡∏≠ üÄà (Kanchan)
            if (val2 - val1 === 2 && winningTile === TILES[type1][val1]) {
              return 'kanchan';
            }
            // ‡πÄ‡∏ä‡πà‡∏ô üÄá,üÄà  ‡∏£‡∏≠ üÄâ (Ryanmen) ‡∏´‡∏£‡∏∑‡∏≠ üÄâ,üÄä ‡∏£‡∏≠ üÄá (Ryanmen)
            if (val2 - val1 === 1) {
              if (winningTile === TILES[type1][val2] && val2 < 9)
                return 'ryanmen';
              if (winningTile === TILES[type1][val1 - 1] && val1 > 1)
                return 'ryanmen';
            }
          }
        }

        // ‡∏ñ‡πâ‡∏≤ winningTile ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÑ‡∏û‡πà‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Tanki)
        if (counts[winningTile] === 1) {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà
          return 'tanki';
        }
        // ‡∏ñ‡πâ‡∏≤ Winning Tile ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î Pon
        if (
          winningPattern.details.melds.some(
            (meld) =>
              meld[0] === winningTile &&
              meld[1] === winningTile &&
              meld[2] === winningTile
          )
        ) {
          // ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ Shanpon (‡∏£‡∏≠‡∏Ñ‡∏π‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Pon) - ‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏°‡∏≤‡∏Å
          // For simplicity, let's treat it as a special case if needed for Fu.
        }

        return 'other'; // Placeholder for other complex waits or default
      }

      function calculateFu(
        winningPattern,
        openMelds,
        winningTile,
        winType,
        gameState
      ) {
        let fu = 20; // Fu ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞‡πÉ‡∏î‡πÜ

        // Yaku ‡∏ó‡∏µ‡πà Fu = 0 (Pinfu) ‡∏´‡∏£‡∏∑‡∏≠ Yaku ‡∏ó‡∏µ‡πà Fu ‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ (Chiitoitsu, Kokushi Musou)
        // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Pinfu ‡πÅ‡∏•‡∏∞ Menzen Tsumo
        const isMenzen = openMelds.length === 0;
        const hasPinfu = findYaku(
          winningPattern,
          winningPattern.details.fullHand,
          openMelds,
          winningTile,
          winType,
          gameState
        ).some((y) => y.name === 'Pinfu');

        if (winningPattern.type === 'chiitoitsu') {
          return 25; // Chiitoitsu ‡∏°‡∏µ 25 Fu ‡πÄ‡∏™‡∏°‡∏≠
        }
        if (winningPattern.type === 'kokushi_musou') {
          return 0; // Yakuman ‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î Fu
        }

        // ‡∏Å‡∏£‡∏ì‡∏µ Pinfu
        if (hasPinfu) {
          if (winType === 'tsumo') return 20; // Pinfu Tsumo = 20 Fu
          else if (winType === 'ron') return 30; // Pinfu Ron = 30 Fu (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î Fu ‡∏à‡∏≤‡∏Å Ron)
        }

        // Fu ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏∞ (Tsumo vs Ron)
        if (winType === 'tsumo') {
          fu += 2; // Tsumo Fu (+2)
        }

        // Fu ‡∏à‡∏≤‡∏Å Pair (Jantou)
        const pairTile = winningPattern.details.pair;
        const roundWind = gameState.roundWind;
        const playerWind = gameState.playerWind;

        // Fu for Yakuhai pair (Dragon, Round Wind, Seat Wind)
        if (TILES.dragons.includes(pairTile)) {
          fu += 2;
        }
        if (pairTile === roundWind) {
          fu += 2;
        }
        if (pairTile === playerWind) {
          fu += 2;
        }
        // Double wind pair (e.g., East wind where round is East and player is East)
        if (pairTile === roundWind && pairTile === playerWind) {
          fu += 2; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å 2 ‡πÄ‡∏õ‡πá‡∏ô 4 Fu
        }

        // Fu ‡∏à‡∏≤‡∏Å Melds (Sets)
        winningPattern.details.melds.forEach((meld) => {
          const tile = meld[0];
          const isTerminalOrHonor = isTerminalTile(tile) || isHonorTile(tile);
          const meldIsClosed = !openMelds.some(
            (om) => om.tiles.includes(tile) && om.type !== 'ankan'
          ); // Ankan ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏∑‡∏≠

          if (meld.length === 3 && meld[0] === meld[1]) {
            // Pon
            let ponFu = 2;
            if (isTerminalOrHonor) ponFu *= 2; // 4 Fu
            if (meldIsClosed) ponFu *= 2; // Closed: 4 Fu (Simple) / 8 Fu (Terminal/Honor)
            fu += ponFu;
          } else if (meld.length === 4 && meld[0] === meld[1]) {
            // Kan (Minkan/Ankan/Chakan)
            let kanFu = 8;
            if (isTerminalOrHonor) kanFu *= 2; // 16 Fu
            if (meldIsClosed) kanFu *= 2; // Closed: 16 Fu (Simple) / 32 Fu (Terminal/Honor)
            fu += kanFu;
          }
          // Chi (Sequence) ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Fu
        });

        // Fu ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏≠ (Wait)
        // ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏à‡∏≤‡∏Å winningTile
        const waitType = getWaitType(
          winningPattern.details.fullHand,
          winningPattern.details.pair,
          winningTile
        );
        if (
          waitType === 'penchan' ||
          waitType === 'kanchan' ||
          waitType === 'tanki'
        ) {
          fu += 2;
        }
        // Shanpon wait also gives 2 Fu, but detecting it is more complex.

        // ‡∏õ‡∏±‡∏î Fu ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö (e.g., 22 Fu -> 30 Fu)
        return Math.ceil(fu / 10) * 10;
      }
    </script>
  </body>
</html>
