<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Dashboard - No Graph</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Kanit', sans-serif; background-color: #f0f2f5; }
        .modal { transition: opacity 0.25s ease; }
        .modal-active { overflow: hidden; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div id="main-dashboard-view">
            <header class="mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Sensor Monitoring Dashboard</h1>
            </header>

            <section id="summary-section" class="mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></section>

            <div class="mb-6 flex flex-wrap gap-4 p-4 bg-white rounded-lg shadow-sm border-l-4 border-gray-500 items-center">
                <h3 class="text-lg font-semibold text-gray-700 mr-4">เครื่องมือ:</h3>
                <button id="summary-report-btn-all" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center gap-2">
                    <i class="ph ph-table"></i> Summary Report
                </button>
                <button id="log-report-btn-all" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-800 transition duration-300 flex items-center gap-2">
                    <i class="ph ph-file-csv"></i> Log Report
                </button>
                <button id="log-settings-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-300 flex items-center gap-2">
                    <i class="ph ph-gear"></i> ตั้งค่า Log
                </button>
            </div>

            <h2 class="text-2xl font-bold text-gray-700 mb-4">สถานะภาพรวม (คลิกเพื่อดูรายละเอียด)</h2>
            <main id="sensors-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-4 gap-6"></main>
        </div>

        <div id="detail-view" class="hidden">
            <button id="back-to-dashboard-btn" class="mb-6 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-300 flex items-center gap-2">
                <i class="ph ph-arrow-left"></i> กลับไปหน้าหลัก
            </button>
            <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-4 mb-4">
                <div class="space-y-2">
                    <h2 id="detail-title" class="text-3xl font-bold text-gray-800"></h2>
                    <p id="detail-last-updated" class="text-sm text-gray-500"></p>
                </div>
                <div class="flex flex-col items-stretch gap-2 p-3 bg-gray-100 rounded-lg border w-full sm:w-auto">
                    <h3 class="text-md font-semibold text-gray-700 text-center mb-2">รายงานสำหรับเสานี้</h3>
                    <button id="detail-summary-btn" class="w-full bg-blue-100 text-blue-800 text-sm font-bold py-2 px-3 rounded-lg hover:bg-blue-200 transition duration-300 flex items-center justify-center gap-1">
                        <i class="ph ph-table"></i> Summary Report
                    </button>
                    <button id="detail-log-btn" class="w-full bg-gray-200 text-gray-800 text-sm font-bold py-2 px-3 rounded-lg hover:bg-gray-300 transition duration-300 flex items-center justify-center gap-1">
                        <i class="ph ph-file-csv"></i> Log Report
                    </button>
                </div>
            </div>
            <div id="detail-data-container" class="bg-white p-6 rounded-xl shadow-lg"></div>
        </div>
    </div>

    <div id="log-modal" class="modal fixed inset-0 w-full h-full bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="log-modal-title" class="text-xl font-bold text-gray-800">Log Report</h2>
                <div class="flex items-center gap-4">
                    <button id="download-log-csv-btn" class="bg-green-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-700 transition duration-300 flex items-center gap-2 text-sm">
                        <i class="ph ph-download-simple"></i> Download CSV
                    </button>
                    <button id="close-log-modal" class="text-gray-500 hover:text-gray-800"><i class="ph-bold ph-x text-2xl"></i></button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pole ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">PM2.5</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Humidity</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Temperature</th>
                    </tr></thead><tbody id="log-table-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                </div>
            </div>
        </div>
    </div>
    
    <div id="summary-modal" class="modal fixed inset-0 w-full h-full bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="summary-modal-title" class="text-xl font-bold text-gray-800">Summary Report</h2>
                <button id="close-summary-modal" class="text-gray-500 hover:text-gray-800"><i class="ph-bold ph-x text-2xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-8">
                <p class="text-sm text-yellow-700 bg-yellow-100 p-3 rounded-md">
                    <strong>หมายเหตุ:</strong> ข้อมูลนี้เป็นการคำนวณจาก Log ที่ถูกเก็บไว้ในเบราว์เซอร์ (ย้อนหลังสูงสุด 90 วัน)
                </p>
                <div id="summary-7-days">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold text-gray-700">ค่าเฉลี่ยย้อนหลัง 7 วัน</h3>
                        <button data-period="7" class="download-summary-pdf-btn bg-red-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-700 transition duration-300 flex items-center gap-2 text-sm">
                            <i class="ph ph-file-pdf"></i> Export PDF (7 Days)
                        </button>
                    </div>
                    <div id="summary-table-7-days" class="overflow-x-auto border rounded-lg"></div>
                </div>
                <div id="summary-30-days">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold text-gray-700">ค่าเฉลี่ยย้อนหลัง 30 วัน</h3>
                        <button data-period="30" class="download-summary-pdf-btn bg-red-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-700 transition duration-300 flex items-center gap-2 text-sm">
                            <i class="ph ph-file-pdf"></i> Export PDF (30 Days)
                        </button>
                    </div>
                    <div id="summary-table-30-days" class="overflow-x-auto border rounded-lg"></div>
                </div>
                <div id="summary-90-days">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold text-gray-700">ค่าเฉลี่ยย้อนหลัง 90 วัน</h3>
                        <button data-period="90" class="download-summary-pdf-btn bg-red-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-700 transition duration-300 flex items-center gap-2 text-sm">
                            <i class="ph ph-file-pdf"></i> Export PDF (90 Days)
                        </button>
                    </div>
                    <div id="summary-table-90-days" class="overflow-x-auto border rounded-lg"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="log-settings-modal" class="modal fixed inset-0 w-full h-full bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold text-gray-800">ตั้งค่าความถี่ในการเก็บ Log</h2>
                <button id="close-log-settings-modal" class="text-gray-500 hover:text-gray-800"><i class="ph-bold ph-x text-2xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-gray-600">เลือกความถี่ที่เซิร์ฟเวอร์จะทำการบันทึกข้อมูลลงฐานข้อมูล (การตั้งค่านี้ไม่มีผลต่อความเร็วในการแสดงผลบนหน้าจอ)</p>
                <div>
                    <label for="log-interval-select" class="block text-sm font-medium text-gray-700 mb-1">ความถี่ในการเก็บข้อมูล:</label>
                    <select id="log-interval-select" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="5">ทุกๆ 5 นาที</option>
                        <option value="10">ทุกๆ 10 นาที</option>
                        <option value="15">ทุกๆ 15 นาที</option>
                    </select>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 border-t flex justify-end">
                <button id="save-log-interval-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center gap-2">
                    <i class="ph ph-save"></i> บันทึก
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const API_URL = 'https://fast-api-v81f.onrender.com/api/sensor-data';
            const LOG_RETENTION_DAYS = 90;
            const DEFAULT_FETCH_INTERVAL = 5000;
            const GLOBAL_DATA_FETCH_INTERVAL = 5000; 
            
            // --- DOM ELEMENTS ---
            const mainDashboardView = document.getElementById('main-dashboard-view');
            const sensorsContainer = document.getElementById('sensors-container');
            const summaryContainer = document.getElementById('summary-section');
            const logReportBtnAll = document.getElementById('log-report-btn-all');
            const summaryReportBtnAll = document.getElementById('summary-report-btn-all');
            const logSettingsBtn = document.getElementById('log-settings-btn');
            
            const detailView = document.getElementById('detail-view');
            const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
            const detailTitle = document.getElementById('detail-title');
            const detailLastUpdated = document.getElementById('detail-last-updated');
            const detailDataContainer = document.getElementById('detail-data-container');
            const detailSummaryBtn = document.getElementById('detail-summary-btn');
            const detailLogBtn = document.getElementById('detail-log-btn');

            const logModal = document.getElementById('log-modal');
            const logModalTitle = document.getElementById('log-modal-title');
            const closeLogModalBtn = document.getElementById('close-log-modal');
            const logTableBody = document.getElementById('log-table-body');
            const downloadLogCsvBtn = document.getElementById('download-log-csv-btn');

            const summaryModal = document.getElementById('summary-modal');
            const summaryModalTitle = document.getElementById('summary-modal-title');
            const closeSummaryModalBtn = document.getElementById('close-summary-modal');

            const logSettingsModal = document.getElementById('log-settings-modal');
            const closeLogSettingsModalBtn = document.getElementById('close-log-settings-modal');
            const logIntervalSelect = document.getElementById('log-interval-select');
            const saveLogIntervalBtn = document.getElementById('save-log-interval-btn');

            // --- STATE ---
            let sensorDataLog = [];
            let currentSensorData = [];
            let activeDetailSensorId = null;
            let currentLogsForDownload = [];
            let summaryDataForDownload = { 7: null, 30: null, 90: null }; 
            let fetchIntervalId = null;
            let logStorageInterval = 1;

            let cardUiUpdateTimers = {};

            const statusMap = {
                online: { text: 'Online' },
                offline: { text: 'Offline' },
                error: { text: 'Error' }
            };

            // --- CORE FUNCTIONS ---
            const fetchData = async () => {
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    const newData = result.sensors.map(s => ({...s, timestamp: new Date().toISOString() }));
                    currentSensorData = newData;
                    sensorDataLog.unshift(...newData);
                    const retentionDate = new Date();
                    retentionDate.setDate(retentionDate.getDate() - LOG_RETENTION_DAYS);
                    sensorDataLog = sensorDataLog.filter(log => new Date(log.timestamp) > retentionDate);
                    /*if (sensorsContainer.children.length === 0 && currentSensorData.length > 0) {
                        updateDashboardUI(currentSensorData);
                    } else {
                        currentSensorData.forEach(updateSingleCardUI);
                    }*/
                    updateSummaryCards(currentSensorData);
                } catch (error) {
                    console.error("Failed to fetch sensor data:", error);
                    sensorsContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">ไม่สามารถเชื่อมต่อได้</p>`;
                }
            };

            // ฟังก์ชันสำหรับจัดการ timer ของการ์ดแต่ละใบโดยเฉพาะ
        const setupCardUpdater = (sensorId, interval) => {
            // หยุด timer เก่าของการ์ดนี้ (ถ้ามี)
            if (cardUiUpdateTimers[sensorId]) {
                clearInterval(cardUiUpdateTimers[sensorId]);
            }

            // ฟังก์ชันที่จะทำงานทุกครั้งที่ timer ดัง
            const updateFunction = () => {
                const sensor = currentSensorData.find(s => s.id === sensorId);
                if (sensor) {
                    updateSingleCardUI(sensor);
                }
            };

            // สั่งให้ทำงานครั้งแรกทันที เพื่อให้ข้อมูลแสดงผล
            updateFunction(); 

            // สร้าง timer ใหม่สำหรับการ์ดใบนี้โดยเฉพาะ
            cardUiUpdateTimers[sensorId] = setInterval(updateFunction, interval);
        };

            // แก้ไข updateDashboardUI ให้เรียกใช้ setupCardUpdater ตอนสร้างการ์ดเสร็จ
        const updateDashboardUI = (data) => {
            sensorsContainer.innerHTML = data.map(createSensorCard).join('');
            
            // +++ เพิ่มเข้ามา +++
            // หลังจากสร้างการ์ดทั้งหมดแล้ว ให้วนลูปเพื่อสร้าง timer ให้แต่ละการ์ด
            data.forEach(sensor => {
                const selectElement = document.querySelector(`#card-${sensor.id} .refresh-rate-selector`);
                // ดึงค่า interval เริ่มต้นจาก dropdown ของการ์ดนั้นๆ
                const initialInterval = parseInt(selectElement.value, 10);
                setupCardUpdater(sensor.id, initialInterval);
            });
        };

            const updateSingleCardUI = (sensor) => {
                const card = document.getElementById(`card-${sensor.id}`);
                if (!card) return;
                const style = getStatusStyle(sensor.status);
                card.className = `bg-white rounded-xl shadow-md border-l-4 ${style.borderColor} p-5 flex flex-col`;
                const statusBadge = card.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.className = `status-badge text-sm font-semibold px-3 py-1 rounded-full ${style.bgColor} ${style.textColor}`;
                    statusBadge.innerHTML = `${style.icon} ${style.text}`;
                }
                const spans = card.querySelectorAll('.font-mono');
                if(spans.length >= 3) {
                    spans[0].innerHTML = renderValue(sensor.data?.['pm2.5'], 'µg/m³');
                    spans[1].innerHTML = renderValue(sensor.data?.humidity, '%');
                    spans[2].innerHTML = renderValue(sensor.data?.temperature, '°C');
                }
            };

            const updateSummaryCards = (data) => {
                const total = data.length;
                const online = data.filter(s => s.status === 'online').length;
                const avgData = calculateAverage(data);
                const createSummaryCard = (title, value, icon, unit, color) => `<div class="bg-white p-5 rounded-xl shadow-md flex items-center gap-4 border-l-4 border-${color}-500">
                    <div class="bg-${color}-100 text-${color}-600 p-3 rounded-full"><i class="ph-bold ${icon} text-2xl"></i></div>
                    <div><p class="text-sm text-gray-500">${title}</p><p class="text-2xl font-bold text-gray-800">${value} ${unit}</p></div>
                </div>`;
                summaryContainer.innerHTML = [
                    createSummaryCard('สถานะ Online', `${online} / ${total}`, 'ph-plugs-connected', '', 'green'),
                    createSummaryCard('PM2.5 เฉลี่ย', avgData.pm25.toFixed(2), 'ph-wind', 'µg/m³', 'yellow'),
                    createSummaryCard('ความชื้นเฉลี่ย', avgData.humidity.toFixed(2), 'ph-drop', '%', 'blue'),
                    createSummaryCard('อุณหภูมิเฉลี่ย', avgData.temp.toFixed(2), 'ph-thermometer-cold', '°C', 'red')
                ].join('');
            };

            const showLogModal = (sensorId = null) => {
                activeDetailSensorId = sensorId;
                currentLogsForDownload = sensorId ? sensorDataLog.filter(log => log.id === sensorId) : sensorDataLog;
                logModalTitle.textContent = sensorId ? `Log Report for Pole ${sensorId}` : 'Log Report (All Poles)';
                logTableBody.innerHTML = currentLogsForDownload.map(log => `<tr>
                    <td class="px-6 py-4 text-sm text-gray-500">${new Date(log.timestamp).toLocaleString('th-TH')}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">Pole ${log.id}</td>
                    <td class="px-6 py-4 text-sm">${(statusMap[log.status] || {text:'Unknown'}).text}</td>
                    <td class="px-6 py-4 text-sm">${renderValue(log.data?.['pm2.5'])}</td>
                    <td class="px-6 py-4 text-sm">${renderValue(log.data?.humidity)}</td>
                    <td class="px-6 py-4 text-sm">${renderValue(log.data?.temperature)}</td>
                </tr>`).join('');
                logModal.classList.remove('hidden'); document.body.classList.add('modal-active');
            };

            const showSummaryModal = (sensorId = null) => {
                activeDetailSensorId = sensorId;
                summaryModalTitle.textContent = sensorId ? `Summary Report for Pole ${sensorId}` : `Overall Summary Report`;
                generateSummaryTable(sensorId, 7); generateSummaryTable(sensorId, 30); generateSummaryTable(sensorId, 90);
                summaryModal.classList.remove('hidden'); document.body.classList.add('modal-active');
            };
            
            const generateSummaryTable = (sensorId, days) => {
                const now = new Date(); const pastDate = new Date(); pastDate.setDate(now.getDate() - days);
                const sourceData = sensorId ? sensorDataLog.filter(log => log.id === sensorId) : sensorDataLog;
                const filteredLogs = sourceData.filter(log => new Date(log.timestamp) >= pastDate);
                const poleIds = [...new Set(filteredLogs.map(log => log.id))].sort();
                if (poleIds.length === 0) { document.getElementById(`summary-table-${days}-days`).innerHTML = `<p class="text-center text-gray-500 p-4">ไม่พบข้อมูลสำหรับช่วงเวลานี้</p>`; summaryDataForDownload[days] = null; return; }
                const tableDataByPole = {}; poleIds.forEach(id => { const poleLogs = filteredLogs.filter(log => log.id === id); tableDataByPole[id] = calculateAverage(poleLogs); });
                const headers = ["Metric", ...poleIds.map(id => `Pole ${id}`)];
                const bodyRows = { "Avg PM2.5 (µg/m³)": poleIds.map(id => tableDataByPole[id].pm25.toFixed(2)), "Avg Humidity (%)": poleIds.map(id => tableDataByPole[id].humidity.toFixed(2)), "Avg Temperature (°C)": poleIds.map(id => tableDataByPole[id].temp.toFixed(2)) };
                const body = Object.entries(bodyRows).map(([metric, values]) => [metric, ...values]);
                summaryDataForDownload[days] = { title: `${summaryModalTitle.textContent} - ${days} Days Summary`, headers: headers, body: body };
                let tableHTML = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">${h}</th>`).join('')}</tr></thead><tbody class="bg-white divide-y divide-gray-200">${body.map(row => `<tr>${row.map((cell, index) => `<td class="px-6 py-4 whitespace-nowrap text-sm ${index === 0 ? 'font-semibold text-gray-800' : ''}">${cell}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
                document.getElementById(`summary-table-${days}-days`).innerHTML = tableHTML;
            };

            const downloadFile = (filename, content, mimeType) => { const finalContent = mimeType.includes('csv') ? '\uFEFF' + content : content; const blob = new Blob([finalContent], { type: mimeType }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href); };
            
            const calculateAverage = (dataArray) => { const validData = dataArray.filter(s => s.data); if (validData.length === 0) return { pm25: 0, humidity: 0, temp: 0 }; const sum = validData.reduce((acc, s) => { acc.pm25 += s.data['pm2.5'] || 0; acc.humidity += s.data.humidity || 0; acc.temp += s.data.temperature || 0; return acc; }, { pm25: 0, humidity: 0, temp: 0 }); return { pm25: sum.pm25 / validData.length, humidity: sum.humidity / validData.length, temp: sum.temp / validData.length }; };
            
            const renderValue = (value, unit = '') => value != null ? `${Number(value).toFixed(2)} ${unit}`.trim() : '-';
            
            const getStatusStyle = (status) => ({ online: { icon: '✅', bgColor: 'bg-green-100', borderColor: 'border-green-500', textColor: 'text-green-800', text: 'Online' }, offline: { icon: '❌', bgColor: 'bg-red-100', borderColor: 'border-red-500', textColor: 'text-red-800', text: 'Offline' }, error: { icon: '⚠️', bgColor: 'bg-yellow-100', borderColor: 'border-yellow-500', textColor: 'text-yellow-800', text: 'Error' } })[status] || { icon: '❓', bgColor: 'bg-gray-100', borderColor: 'border-gray-500', textColor: 'text-gray-800', text: 'Unknown' };

            const createSensorCard = (sensor) => {
                const { id, status, data } = sensor;
                const style = getStatusStyle(status);
                return `<div id="card-${id}" class="bg-white rounded-xl shadow-md border-l-4 ${style.borderColor} p-5 flex flex-col">
                    <div data-id="${id}" class="cursor-pointer flex-grow">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-gray-700">Pole ${id}</h2>
                            <span class="status-badge text-sm font-semibold px-3 py-1 rounded-full ${style.bgColor} ${style.textColor}">${style.icon} ${style.text}</span>
                        </div>
                        <div class="space-y-2 text-gray-600">
                            <p class="flex justify-between"><strong>PM2.5:</strong> <span class="font-mono">${renderValue(data?.['pm2.5'], 'µg/m³')}</span></p>
                            <p class="flex justify-between"><strong>Humidity:</strong> <span class="font-mono">${renderValue(data?.humidity, '%')}</span></p>
                            <p class="flex justify-between"><strong>Temperature:</strong> <span class="font-mono">${renderValue(data?.temperature, '°C')}</span></p>
                        </div>
                        <div class="text-center mt-4 pt-3 border-t text-blue-600 font-semibold hover:underline">ดูรายละเอียด</div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <label class="text-xs text-gray-500">ความเร็วอัปเดต:</label>
                        <select class="refresh-rate-selector w-full text-xs p-3 rounded border-gray-300">
                            <option value="5000">ทุก 5 วินาที</option>
                            <option value="10000">ทุก 10 วินาที</option>
                            <option value="30000">ทุก 30 วินาที</option>
                            <option value="60000">ทุก 1 นาที</option>
                            <option value="300000" selected>ทุก 5 นาที</option>
                            <option value="600000">ทุก 10 นาที</option>
                            <option value="1800000">ทุก 30 นาที</option>
                        </select>
                    </div>
                </div>`;
            };
            
            const showDetailView = (sensorId) => {
                activeDetailSensorId = sensorId;
                const sensor = currentSensorData.find(s => s.id === sensorId); if (!sensor) return;
                mainDashboardView.classList.add('hidden'); detailView.classList.remove('hidden');
                detailTitle.textContent = `ข้อมูลสำหรับ Pole ${sensorId}`;
                detailLastUpdated.textContent = `อัปเดตล่าสุด: ${new Date().toLocaleTimeString('th-TH')}`;
                detailDataContainer.innerHTML = `<div class="space-y-4 text-lg">
                    <p class="flex justify-between items-center"><strong>สถานะ:</strong> <span class="font-semibold text-gray-800">${(statusMap[sensor.status]||{text:'N/A'}).text}</span></p>
                    <p class="flex justify-between items-center"><strong>PM2.5:</strong> <span class="font-mono text-2xl font-bold text-yellow-600">${renderValue(sensor.data?.['pm2.5'], 'µg/m³')}</span></p>
                    <p class="flex justify-between items-center"><strong>ความชื้น:</strong> <span class="font-mono text-2xl font-bold text-blue-600">${renderValue(sensor.data?.humidity, '%')}</span></p>
                    <p class="flex justify-between items-center"><strong>อุณหภูมิ:</strong> <span class="font-mono text-2xl font-bold text-red-600">${renderValue(sensor.data?.temperature, '°C')}</span></p>
                </div>`;
            };

            const showLogSettingsModal = () => {
                logIntervalSelect.value = logStorageInterval;
                logSettingsModal.classList.remove('hidden');
                document.body.classList.add('modal-active');
            };

            const sendToServerLogInterval = async (minutes) => {
                console.log(`Simulating: Sending new log interval (${minutes} min) to server...`);
                await new Promise(resolve => setTimeout(resolve, 500));
                console.log('Simulating: Server acknowledged the new interval.');
                return true;
            };

            // --- EVENT LISTENERS ---
            backToDashboardBtn.addEventListener('click', () => { detailView.classList.add('hidden'); mainDashboardView.classList.remove('hidden'); activeDetailSensorId = null; });
            
            sensorsContainer.addEventListener('click', (e) => {
                const detailTrigger = e.target.closest('[data-id]');
                if (detailTrigger) showDetailView(detailTrigger.dataset.id);
            });

            // แก้ไข Event Listener ให้ทำงานกับการ์ดใบเดียว
        sensorsContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('refresh-rate-selector')) {
                const cardElement = e.target.closest('[id^="card-"]');
                if (!cardElement) return;

                // หา ID ของ sensor จาก ID ของ element การ์ด
                const sensorId = cardElement.id.replace('card-', '');
                const newInterval = parseInt(e.target.value, 10);
                
                // เรียกใช้ฟังก์ชันเพื่ออัปเดต timer ของการ์ดใบนี้โดยเฉพาะ
                setupCardUpdater(sensorId, newInterval);
                console.log(`Update interval for Pole ${sensorId} changed to ${newInterval / 1000} seconds.`);
            }
        });
            
            logReportBtnAll.addEventListener('click', () => showLogModal());
            summaryReportBtnAll.addEventListener('click', () => showSummaryModal());
            logSettingsBtn.addEventListener('click', showLogSettingsModal);
            
            detailLogBtn.addEventListener('click', () => showLogModal(activeDetailSensorId));
            detailSummaryBtn.addEventListener('click', () => showSummaryModal(activeDetailSensorId));
            
            closeLogModalBtn.addEventListener('click', () => { logModal.classList.add('hidden'); document.body.classList.remove('modal-active'); });
            downloadLogCsvBtn.addEventListener('click', () => { if (currentLogsForDownload.length === 0) return alert('No log data to download.'); const headers = "Timestamp,Pole ID,Status,PM2.5,Humidity,Temperature"; const rows = currentLogsForDownload.map(log => { const values = [ new Date(log.timestamp).toISOString(), `Pole ${log.id}`, (statusMap[log.status] || {text:'Unknown'}).text, log.data?.['pm2.5']?.toFixed(2) || '', log.data?.humidity?.toFixed(2) || '', log.data?.temperature?.toFixed(2) || '' ]; return values.map(v => `"${String(v).replace(/"/g, '""')}"`).join(','); }); const filename = activeDetailSensorId ? `log_pole_${activeDetailSensorId}.csv` : 'log_all.csv'; downloadFile(filename, `${headers}\n${rows.join('\n')}`, 'text/csv;charset=utf-8;'); });
            
            closeSummaryModalBtn.addEventListener('click', () => { summaryModal.classList.add('hidden'); document.body.classList.remove('modal-active'); });
            document.querySelectorAll('.download-summary-pdf-btn').forEach(button => { button.addEventListener('click', (e) => { const period = e.currentTarget.dataset.period; const data = summaryDataForDownload[period]; if (!data || !data.body || data.body.length === 0) { alert(`No summary data to download for the ${period}-day period.`); return; } const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape' }); doc.setFont("helvetica", "bold"); doc.text(data.title, 14, 15); doc.setFont("helvetica", "normal"); doc.setFontSize(10); doc.text(`Generated on: ${new Date().toLocaleString('th-TH')}`, 14, 22); doc.autoTable({ head: [data.headers], body: data.body, startY: 28, }); const filename = activeDetailSensorId ? `summary_pole_${activeDetailSensorId}_${period}d.pdf` : `summary_all_${period}d.pdf`; doc.save(filename); }); });

            closeLogSettingsModalBtn.addEventListener('click', () => { logSettingsModal.classList.add('hidden'); document.body.classList.remove('modal-active'); });
            saveLogIntervalBtn.addEventListener('click', async () => {
                const newInterval = parseInt(logIntervalSelect.value, 10);
                saveLogIntervalBtn.disabled = true; saveLogIntervalBtn.textContent = 'กำลังบันทึก...';
                const success = await sendToServerLogInterval(newInterval);
                if (success) {
                    logStorageInterval = newInterval;
                    alert(`บันทึกสำเร็จ! เซิร์ฟเวอร์จะทำการเก็บข้อมูลทุกๆ ${newInterval} นาที`);
                    logSettingsModal.classList.add('hidden'); document.body.classList.remove('modal-active');
                } else {
                    alert('เกิดข้อผิดพลาดในการบันทึก!');
                }
                saveLogIntervalBtn.disabled = false; saveLogIntervalBtn.innerHTML = '<i class="ph ph-save"></i> บันทึก';
            });

            const initializeDashboard = async () => {
            // 1. ดึงข้อมูลครั้งแรกเพื่อแสดงผล
            await fetchData();

            // 2. สร้างการ์ดและตั้งค่า timer เริ่มต้นให้แต่ละใบ
            if (currentSensorData.length > 0) {
                updateDashboardUI(currentSensorData);
            } else {
                sensorsContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">ไม่พบข้อมูลเซ็นเซอร์</p>`;
            }

            // 3. เริ่มการดึงข้อมูลจาก Server เป็นระยะๆ (ทำงานอยู่เบื้องหลัง)
            // เพื่อให้ state `currentSensorData` สดใหม่อยู่เสมอ
            fetchIntervalId = setInterval(fetchData, GLOBAL_DATA_FETCH_INTERVAL);
        };

        // สั่งให้ Dashboard เริ่มทำงาน
        initializeDashboard();
        });
    </script>
</body>
</html>
