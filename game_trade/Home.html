<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            background-color: #333;
            color: white;
            padding: 10px;
            margin-bottom: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-info img {
            object-fit: cover;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }

        .money-info {
            color: yellow;
            display: flex;
            align-items: center;
            font-size: 24px;
        }

        .money-info i {
            margin-left: 5px;
            font-size: 30px;
        }

        .gear-icon {
            cursor: pointer;
            font-size: x-large;
        }

        .content {
            padding: 20px;
        }

        .shop,
        .auction,
        .inventory {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
        }

        .shop-item,
        .auction-item,
        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .shop-item img,
        .auction-item img,
        .inventory-item img {
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }

        .shop-item .details,
        .auction-item .details,
        .inventory-item .details {
            flex-grow: 1;
        }

        @media only screen and (max-width: 425px) {

            .shop-item,
            .auction-item {
                flex-direction: column;
            }

            .price-btn-container,
            .auction-item {
                flex-direction: column;
                align-items: stretch;
            }

            .btn,
            .auction-item {
                margin-top: 10px;
                width: 90%;
            }
        }

        .btn {
            padding: 5px 10px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 3px;
            margin-left: 20px;
        }

        .btn:hover {
            font-size: large;
        }

        .btn.disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        #notification {
            background-color: red;
            color: white;
            padding: 10px;
            position: fixed;
            top: 20px;
            right: 20px;
            display: none;
            border-radius: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            z-index: 999;
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 5px solid #96896e;
            width: 80%;
            border-radius: 5px;
        }

        .close,
        .closec {
            color: #ff2828;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus,
        .closechat:hover,
        .closechat:focus,
        .closec:hover,
        .closec:focus {
            color: rgb(136, 31, 31);
            text-decoration: none;
            cursor: pointer;
        }

        /* CSS Styles for Profile Picture Preview */
        #profilePicPreview,
        #profileUser {
            display: block;
            text-align: center;
            width: 100px;
            height: 100px;
            margin: 20px auto;
            border-radius: 50%;
            object-fit: cover;
        }

        .save {
            height: 40px;
            width: 20%;
            border: none;
            border-radius: 15px;
            background-color: #4caf50;
            color: white;
            cursor: pointer;
            transition: 0.7s;
        }

        .save:hover {
            width: 40%;
        }

        #editProfileForm {
            text-align: center;
        }

        .modal {
            display: flex;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
        }

        .close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .hidden {
            display: none;
            text-align: center;

        }

        #full-screen-image {
            height: 300px;
            width: 300px;
        }

        .inventory-item {
            background-color: #f0f0f0;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        .inventory-item img {
            border-radius: 10px;
            margin-right: 15px;
        }

        .inventory-item .details {
            flex: 1;
        }

        .shop-item {
            background-color: #f8f8f8;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        .shop-item img {
            border-radius: 8px;
            margin-right: 15px;
        }

        .shop-item .details {
            flex: 1;
        }

        .shop-item .btn {
            background-color: #ff6666;
            border: none;
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
        }

        .shop-item .btn:hover {
            background-color: #ff4d4d;
        }

        #rankButton {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #rankButton:hover {
            background-color: #45a049;
        }

        #rankingTableContainer {
            margin: 20px;
            font-family: Arial, sans-serif;
        }

        #rankingTable {
            width: 100%;
            border-collapse: collapse;
            background-color: #f9f9f9;
        }

        #rankingTable th,
        #rankingTable td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        #rankingTable th {
            background-color: #4CAF50;
            color: white;
        }

        #rankingTable tr:hover {
            background-color: #f1f1f1;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 600px) {

            #rankingTable th,
            #rankingTable td {
                padding: 8px;
                font-size: 14px;
            }

            #rankingTable th {
                font-size: 16px;
            }

            #rankButton {
                padding: 3px 7px;
                font-size: 12px;

            }

            .money-info,
            i {
                font-size: small;
                margin-left: 2%;
            }

            #logout-button,
            #editProfileBtn {
                display: block;
            }

            #icon {
                font-size: small;
                cursor: pointer;
            }
        }

        #chatContainer {
            display: none;
            position: fixed;
            bottom: 0;
            right: 0;
            top: 75px;
            background-color: white;
            border: 1px solid #ccc;
            width: 100vw;
            height: 60vh;
            max-width: 400px;
            max-height: 500px;
            z-index: 1000;
        }

        #chatBox {
            width: 100%;
            height: 80%;
            overflow-y: auto;
            padding: 10px;
            border-bottom: 1px solid #ccc;
            display: flex;
            flex-direction: column;
        }

        #chatInput {
            width: calc(100% - 50px);
            padding: 10px;
            box-sizing: border-box;
            margin-right: 10px;
        }

        #sendButton {
            padding: 20px;
            cursor: pointer;
            background-color: rgb(53, 92, 219);
            color: rgb(255, 255, 255);
            border: none;
            border-radius: 15px;
        }

        .user-message {
            align-self: flex-end;
            background-color: #e1f7d5;
            margin: 5px 0;
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
            margin-right: 20px;
        }

        .other-message {
            align-self: flex-start;
            background-color: #f1f0f0;
            margin: 5px 0;
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
        }

        .other-message-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            margin-left: 10px;
        }

        .profile-pic {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }
        #chat{
            font-size: larger;
            background-color: #f1f1f1;
            border-radius: 15px;
            padding: 10px 15px;
            margin: 10px;
            cursor: pointer;
        }

        @media (max-width: 540px) {
            #chatContainer {

            top: 125px;
           
        }
        }
    </style>
</head>

<body>
    <script src="https://kit.fontawesome.com/1e0e692548.js" crossorigin="anonymous"></script>

    <!-- แถบบนที่แสดงข้อมูลผู้ใช้และจำนวนเงิน -->
    <div class="top-bar">
        <div class="user-info">
            <img id="picU" src="" alt="Profile">
            <div id="nameU">ชื่อผู้ใช้</div>
        </div>
        <div class="money-info">
            <span id="money">0</span> บาท
            <i class="fas fa-coins" id="icon"></i>
        </div>

        <div style="white-space: nowrap;">
            <button id="rankButton" onclick="toggleItems2()">แสดงตารางอันดับ</button>
            <div class="gear-icon" id="editProfileBtn" style="display: inline-block; margin: 0 10px 0 10px; ">
                <i class="fas fa-cog"></i>
            </div>
            <button id="logout-button"
                style=" padding: 5px; border: none;  border-radius: 15px;  background-color: #ff4d4d;">ออกจากระบบ</button>
        </div>
    </div>
    <span class="icon" id="chat"">💬 แชท</span>
    <script>
        // ฟังก์ชันสำหรับออกจากระบบ
        function logout() {
            // ลบข้อมูลอีเมลจาก localStorage
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userMoney');

            // เปลี่ยนเส้นทางไปยังหน้าล็อกอิน
            window.location.href = 'login.html'; // เปลี่ยนเป็นชื่อไฟล์ของหน้าล็อกอินของคุณ
        }

        // เพิ่ม Event Listener ให้กับปุ่ม
        document.getElementById('logout-button').addEventListener('click', logout);

    </script>
    <div id="chatContainer">
        <div id="chatBox"></div>
        <div style="display: flex; align-items: center;">
            <input type="text" id="chatInput" placeholder="พิมพ์ข้อความ...">
            <button id="sendButton">ส่ง</button>
        </div>
    </div>

    
    <!-- ตารางสำหรับแสดงอันดับ -->
    <div id="rankingTableContainer" class="hidden">
        <script>
            function toggleItems2() {
                const moreItems2 = document.getElementById("rankingTable");
                if (moreItems2.classList.contains("hidden")) {
                    moreItems2.classList.remove("hidden");
                } else {
                    moreItems2.classList.add("hidden");
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                toggleItems2();
            });

        </script>
        <table id="rankingTable" border="1">
            <thead>
                <tr>
                    <th>อันดับ</th>
                    <th>ภาพโปรไฟล์</th>
                    <th>ชื่อผู้ใช้</th>
                    <th>จำนวนเงิน</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="editProfileModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <!-- เนื้อหาหน้าต่างแก้ไขโปรไฟล์ -->
            <div class="container2">
                <h2>แก้ไขโปรไฟล์</h2>
                <!-- ฟอร์มแก้ไขโปรไฟล์ -->
                <form id="editProfileForm">
                    <img src="" id="profilePicPreview" alt="Profile Picture Preview">
                    <input type="file" id="profilePicInput" accept="image/*" style="display: none;">

                    <!-- เพิ่มปุ่มสำหรับเปลี่ยนภาพโปรไฟล์ -->
                    <label for="username" style="font-size: larger;">ชื่อผู้ใช้ :</label>
                    <input type="text" id="usernamePreview" name="username"></input>
                    <h4 id="userID"></h4>
                    <h4 id="email"></h4>
                    <h4 id="date"></h4>
                    <input type="submit" value="Save" id="save" class="save"></input>
                </form>
            </div>
        </div>
    </div>

    <!-- เนื้อหาหลัก -->
    <div class="content">
        <!-- แถบร้านค้า -->
        <div class="shop">
            <h2>ร้านค้า</h2>
            <div id="shop-items">
                <!-- สินค้า 2 รายการแรกจะแสดงที่นี่ -->
            </div>
            <div id="more-items" class="hidden">
                <!-- สินค้าเพิ่มเติมจะถูกเพิ่มที่นี่ -->
            </div>
            <script>
                function toggleItems() {
                    const moreItems = document.getElementById("more-items");
                    if (moreItems.classList.contains("hidden")) {
                        moreItems.classList.remove("hidden");
                    } else {
                        moreItems.classList.add("hidden");
                    }
                }

                document.addEventListener('DOMContentLoaded', function () {
                    toggleItems();
                });
            </script>

            <button class="btn" onclick="toggleItems()">ดูเพิ่มเติม</button>
        </div>
        <script>
            // กดภาพเเล้วเเสดง
            function openModal(imageSrc) {
                const modal = document.getElementById('full-screen-modal');
                const modalImage = document.getElementById('full-screen-image');
                modalImage.src = imageSrc;
                modal.classList.remove('hidden');
            }

            // ปิดเเสดงภาพ
            function closeModal() {
                const modal = document.getElementById('full-screen-modal');
                modal.classList.add('hidden');
            }
        </script>

        <!-- กดภาพเเล้วเเสดง -->
        <div id="full-screen-modal" class="modal hidden">
            <span class="close" onclick="closeModal()">&times;</span>
            <img class="modal-content" id="full-screen-image">
        </div>

        <!-- แถบประมูล -->
        <div class="auction">
            <h2>ประมูลสินค้า<div id="userCountDisplay" style="color: #ff2828;">เข้าร่วม: 0 คน</div>
            </h2>
            <div class="auction-item">
                <!-- เเสดงสินค้าที่ลงประมูล -->
            </div>
            <div id="auction-timer" style="color: #ff2828; font-size: xx-large;"></div>
        </div>

        <!-- คลังสินค้าของผู้ใช้ -->
        <div class="inventory">
            <h2>คลังสินค้า</h2>
            <div id="total-items"></div>

            <div id="inventory-items">
                <!-- ถ้าไม่มีสินค้า -->

            </div>
        </div>
    </div>

    <!-- การแจ้งเตือน -->
    <div id="notification"></div>

    <script type="module" defer>

        import { initializeApp, } from "https://www.gstatic.com/firebasejs/9.12.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/9.12.0/firebase-auth.js";
        import {
            getFirestore, collection, addDoc, where, setDoc, serverTimestamp, getDocs, getDoc, doc,
            updateDoc, query, orderBy, onSnapshot
        } from "https://www.gstatic.com/firebasejs/9.12.0/firebase-firestore.js";

        import { getStorage, uploadBytes, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.12.0/firebase-storage.js"; // เพิ่มการนำเข้า Firebase Storage API
        import { getDatabase, set, push, ref, onValue, remove, get, child } from "https://www.gstatic.com/firebasejs/9.12.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVzawA_NDnkqCHKerT2Gcg4zO9yohWx3U",
            authDomain: "pangpone-1372b.firebaseapp.com",
            databaseURL: "https://pangpone-1372b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pangpone-1372b",
            storageBucket: "pangpone-1372b.appspot.com",
            messagingSenderId: "911442011016",
            appId: "1:911442011016:web:8434ea79964ceab63a903d",
            measurementId: "G-S144W2V9SG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const firestore = getFirestore(app);
        const storage = getStorage(app);
        const getdata = getDatabase(app);

        async function clearBidData() {
            try {
                await remove(ref(getdata, 'bid'));
                await remove(ref(getdata, 'countall'));
            } catch (error) {
                console.error('Error clearing bid data:', error);
            }
        }

        let countUsers = 0;

        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.style.display = chatContainer.style.display === 'none' ? 'block' : 'none';

            // เมื่อเปิดแชท ให้เลื่อนลงไปที่ข้อความล่าสุด
            if (chatContainer.style.display === 'block') {
                const chatBox = document.getElementById('chatBox');
                chatBox.scrollTop = chatBox.scrollHeight; // เลื่อนให้แสดงข้อความล่าสุด
            }
        }

        function sendMessage() {
            const userEmail = localStorage.getItem('userEmail') || "";
            const chatBox = document.getElementById('chatBox');
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();

            if (message) {
                // ส่งข้อความไปยัง Firebase
                set(push(ref(getdata, 'chat')), {
    user: userEmail,
    msg: message,
    timestamp: Date.now() // ใช้ Date.now() เพื่อเก็บเวลาในรูปแบบ millisecond
});

                chatInput.value = ''; // เคลียร์ช่องกรอกข้อความ

                // เลื่อนให้แสดงข้อความล่าสุด
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }



let lastUserEmail = null; 
let messages = []; 

async function displayMessage(userEmail, message, timestamp) {
    const chatBox = document.getElementById('chatBox');
    const currentUserEmail = localStorage.getItem('userEmail');

    let username;
    let profileImageUrl;

    try {
        const userQuery = query(collection(db, 'usersgame'), where('email', '==', userEmail));
        const querySnapshot = await getDocs(userQuery);

        if (!querySnapshot.empty) {
            querySnapshot.forEach(doc => {
                const userData2 = doc.data();
                username = userData2.username;
                profileImageUrl = userData2.picture;
            });
        } else {
            console.error('ไม่พบผู้ใช้ที่มีอีเมลนี้');
            return;
        }
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการดึงข้อมูลผู้ใช้:', error);
        return;
    }

    // ตรวจสอบว่ามีข้อความที่ตรงกับ userEmail และ timestamp นี้ใน messages หรือไม่
    if (!messages.some(msg => msg.userEmail === userEmail && msg.timestamp === timestamp)) {
        messages.push({ userEmail, message, timestamp, username, profileImageUrl });
        messages.sort((a, b) => a.timestamp - b.timestamp);

        chatBox.innerHTML = '';

        messages.forEach(msg => {
    const messageElement = document.createElement('div');

    if (msg.userEmail === currentUserEmail) {
        messageElement.className = 'user-message';
        messageElement.textContent = msg.message;
    } else {
        // สร้าง element แสดงชื่อผู้ใช้ให้อยู่ด้านนอกของ otherMessageContainer
        const usernameElement = document.createElement('div');
        usernameElement.className = 'other-user';
        usernameElement.style.marginBottom = '5px'; 
        usernameElement.textContent = msg.username;
        usernameElement.style.marginLeft = '15px'; 

        // สร้าง container สำหรับรูปโปรไฟล์และกล่องข้อความ
        const otherMessageContainer = document.createElement('div');
        otherMessageContainer.className = 'other-message-container';

        const profilePic = document.createElement('img');
        profilePic.src = msg.profileImageUrl || 'defaultProfilePic.png';
        profilePic.className = 'profile-pic';
        profilePic.alt = `${msg.username}'s profile picture`;

        const otherMessage = document.createElement('div');
        otherMessage.className = 'other-message';
        otherMessage.textContent = msg.message;

        otherMessageContainer.appendChild(profilePic);
        otherMessageContainer.appendChild(otherMessage);

        // เพิ่ม usernameElement และ otherMessageContainer เข้าไปใน chatBox ตามลำดับ
        chatBox.appendChild(usernameElement);
        chatBox.appendChild(otherMessageContainer);
    }

    chatBox.appendChild(messageElement);
    lastUserEmail = msg.userEmail;
});


        chatBox.scrollTop = chatBox.scrollHeight;
    }
}

function loadChatMessages() {
    const chatBox = document.getElementById('chatBox');

    const chatRef = ref(getdata, 'chat');
    onValue(chatRef, (snapshot) => {
        let newMessages = [];

        snapshot.forEach((childSnapshot) => {
            const childData = childSnapshot.val();
            if (!messages.some(msg => msg.userEmail === childData.user && msg.timestamp === childData.timestamp)) {
                newMessages.push(childData);
            }
        });

        newMessages.sort((a, b) => a.timestamp - b.timestamp);

        newMessages.forEach((childData) => {
            displayMessage(childData.user, childData.msg, childData.timestamp);
        });

        chatBox.scrollTop = chatBox.scrollHeight;
    });
}




        // เพิ่ม event listeners เมื่อ DOM ถูกโหลด
        document.addEventListener('DOMContentLoaded', () => {
            const chatToggle = document.getElementById('chat');
            const sendButton = document.getElementById('sendButton');

            chatToggle.addEventListener('click', toggleChat);
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', sendMessage1);

            // โหลดข้อมูลแชทเมื่อเริ่มต้น
            loadChatMessages();
        });

        function sendMessage1(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }


        // ฟังก์ชันในการโหลดสินค้าประมูล
        async function loadAuctionItems() {
            try {
                console.log("โหลดสินค้าประมูล");
                const dd = localStorage.getItem('name');
                const response = await fetch('auction.php', {
                    method: 'POST', // ใช้ POST เพื่อส่งข้อมูล
                    headers: {
                        'Content-Type': 'application/json', // กำหนด Content-Type
                    },
                    body: JSON.stringify({ user_email: dd }) // ส่งอีเมลในรูปแบบ JSON
                });

                const resultText = await response.text(); // รับข้อมูลเป็นข้อความ
                console.log("Raw response:", resultText); // แสดงข้อมูลดิบ

                // ใช้ Regular Expression เพื่อลบข้อมูลที่ไม่จำเป็น (อาเรย์ว่าง)
                const cleanedResultText = resultText.replace(/}\s*{/g, '},{'); // แก้ไขการแยก JSON ที่ไม่ถูกต้อง

                // หากมีข้อมูลมากกว่าหนึ่ง JSON จะต้องจัดการให้ถูกต้อง
                const jsonParts = cleanedResultText.split('}{');
                const combinedJson = jsonParts.join('},{'); // เชื่อมข้อมูลที่แตกต่างกันให้ถูกต้อง
                const finalJsonText = `[${combinedJson}]`; // สร้าง JSON array

                // แปลงเป็นอาเรย์ JSON
                const responseArray = JSON.parse(finalJsonText); // แปลงเป็น JSON

                // ลบอ็อบเจ็กต์ที่สองออก
                if (responseArray.length > 1) {
                    responseArray.splice(1, 1); // ลบอ็อบเจ็กต์ที่สอง
                }

                console.log("ผลลัพธ์หลังจากลบ:", responseArray); // แสดงผลลัพธ์หลังจากลบ

                // ตรวจสอบว่า result.data เป็นอาเรย์
                responseArray.forEach(item => {
                    if (item.data && Array.isArray(item.data)) {
                        const auctionItems = item.data.filter(item => item && item.name && item.description && item.image && item.price); // เก็บเฉพาะข้อมูลที่ครบถ้วน

                        auctionItems.forEach(auctionItem => {
                            const auctionItemElement = document.createElement('div');
                            auctionItemElement.classList.add('auction-item');

                            auctionItemElement.innerHTML = `
                    <img src="${auctionItem.image}" style="height: 100px; width: 100px; margin-bottom:10px;" alt="${auctionItem.name}">
                    <div class="details">
                        <strong>${auctionItem.name}</strong>
                        <p>${auctionItem.description}</p>
                    </div>
                    <div style="font-weight:800;">ราคาขั้นต่ำ: <span id="min-bid">${auctionItem.price}</span> บาท</div>
                `;

                            // เก็บข้อมูลใน localStorage
                            localStorage.setItem('img', auctionItem.image);
                            localStorage.setItem('name', auctionItem.name);
                            localStorage.setItem('bid', auctionItem.price);
                            localStorage.setItem('details', auctionItem.description);

                            // เชื่อมต่อไปยังฐานข้อมูลเพื่อตรวจสอบว่ามีข้อมูลใน 'bid' หรือไม่
                            const bidRef = ref(getdata, 'bid');  // อ้างถึงตำแหน่ง 'bid' ในฐานข้อมูล
                            onValue(bidRef, (snapshot) => {
                                const data = snapshot.val();

                                if (!data) {
                                    // ถ้าไม่มีข้อมูลใน bid จะแสดงปุ่มเข้าร่วมประมูล
                                    const bidButton = document.createElement('button');
                                    bidButton.classList.add('btn');
                                    bidButton.textContent = 'เข้าร่วมประมูล';
                                    bidButton.addEventListener('click', () => startAuction(auctionItem.price));

                                    auctionItemElement.appendChild(bidButton);
                                } else {
                                    // ถ้ามีข้อมูลใน bid ไม่ต้องแสดงปุ่มเข้าร่วมประมูล
                                    console.log('มีข้อมูลใน bid อยู่แล้ว');
                                }
                            });

                            // เพิ่มรายการสินค้าลงใน DOM
                            document.querySelector('.auction').appendChild(auctionItemElement);
                        });
                    } else {
                        console.error("ข้อมูลที่ได้รับไม่ถูกต้อง:", result);
                    }

                });
            } catch (error) {
                console.error("Error loading auction items:", error);
            }
        }

        document.addEventListener('DOMContentLoaded', async function () {

            localStorage.removeItem('userMoney');
            localStorage.removeItem('countUsers');
            localStorage.removeItem('img');
            localStorage.removeItem('name');
            localStorage.removeItem('bid');
            localStorage.removeItem('details');

            const usergmtemp = localStorage.getItem('userEmail');

            await loadAuctionItems(); // โหลดสินค้าประมูล
            await clearBidData();
            await loadUsersData(usergmtemp);
            // อัปเดตข้อมูลผู้ใช้ในหน้าต่างแก้ไขโปรไฟล์
            updateProfileModal();
            html = `เข้าร่วม: ${countUsers} คน`;
            const userCountDisplay = document.getElementById('userCountDisplay');
            userCountDisplay.textContent = html;
        });
        let userDatagm = [];
        async function loadUsersData(usergmtemp) {
            try {
                userDatagm = []; // เคลียร์ข้อมูลใน userDatagm เพื่อให้แน่ใจว่าข้อมูลเป็นข้อมูลล่าสุดที่ถูกโหลดมา

                const querySnapshot = await getDocs(collection(db, 'usersgame'));
                querySnapshot.forEach((userDoc) => {
                    const userData = userDoc.data();
                    const { username, email, password, accoutpp, picture, created_at, money } = userData;
                    const id = userDoc.id;

                    // ตรวจสอบว่าเป็นเจ้าของอีเมล์หรือไม่ก่อนที่จะเพิ่มข้อมูลเข้าไปใน usersData
                    if (usergmtemp && email === usergmtemp) {
                        // เพิ่มเฉพาะข้อมูลของเจ้าของอีเมล์เท่านั้น
                        userDatagm.push({
                            username: username,
                            email: email,
                            password: password,
                            accoutpp: accoutpp,
                            picture: picture,
                            created_at: new Date(created_at.seconds * 1000 + created_at.nanoseconds / 1000000),
                            money: money,
                            id: id
                        });
                    }
                });

                if (usergmtemp && userDatagm.length === 0) {
                    console.log('ไม่พบข้อมูลผู้ใช้ที่มีรหัสผู้ใช้ที่เก็บไว้ใน localStorage');
                } else {
                    // ตรวจสอบและเข้าถึง money หลังจากโหลดข้อมูลเสร็จสิ้น
                    if (userDatagm.length > 0) {
                        let money = userDatagm[0].money;
                        userMoney = money;
                        //window.money = money; // กำหนดให้ money เป็นส่วนหนึ่งของ window
                        localStorage.setItem('userMoney', money);
                    }
                }
            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการโหลดข้อมูลผู้ใช้:', error);
            }
        }

        //กดปุ่ม เมื่อตั้งโปรไฟล์ใหม่เสร็จ
        document.getElementById('save').addEventListener('click', async (event) => {
            event.preventDefault(); // ป้องกันรีเฟรชหน้าเว็บ

            const newUsername = document.getElementById('usernamePreview').value; // ค่าชื่อใหม่ที่ผู้ใช้ป้อน
            const selectedFile = document.getElementById('profilePicInput').files[0]; // ไฟล์ภาพที่ผู้ใช้เลือก

            console.log("selectedFile:" + selectedFile);

            // ตรวจสอบว่า userDatagm ไม่ว่างเพื่อให้แน่ใจว่าข้อมูลผู้ใช้ถูกโหลดมาแล้ว
            if (userDatagm.length > 0) {
                const currentUserEmail = localStorage.getItem('userEmail');
                const userToUpdate = userDatagm.find(user => user.email === currentUserEmail);

                if (userToUpdate) {
                    console.log('พบข้อมูลผู้ใช้:', userToUpdate);

                    if (selectedFile && selectedFile.name) {
                        if (selectedFile) {
                            console.log("Selected file:", selectedFile); // แสดงข้อมูลของไฟล์ที่เลือก
                        } else {
                            console.error("No file selected.");
                        }

                        if (!selectedFile.name || selectedFile.name.trim() === "") {
                            console.error("File name is invalid.");
                            return;
                        }
                        if (!storage) {
                            console.error("Firebase storage instance is not initialized.");
                            return;
                        }

                        const fileRef = storageRef(storage, `images/${selectedFile.name}`);


                        const uploadTask = uploadBytes(fileRef, selectedFile);


                        uploadTask.then(async (snapshot) => {
                            console.log('Uploaded file successfully');
                            const downloadURL = await getDownloadURL(snapshot.ref);
                            await updateProfilePicture(userToUpdate.id, downloadURL);
                            await updateUsername(userToUpdate.id, newUsername);
                            alert("อัปเดตข้อมูลผู้ใช้เรียบร้อยแล้ว");
                        }).catch((error) => {
                            console.error("เกิดข้อผิดพลาดในการอัปโหลดภาพ:", error);
                        });

                    } else {
                        // อัปเดตเฉพาะชื่อผู้ใช้เมื่อไม่มีการเลือกภาพ
                        await updateUsername(userToUpdate.id, newUsername);
                        alert("อัปเดตชื่อผู้ใช้เรียบร้อยแล้ว");
                    }
                } else {
                    console.log("ไม่พบข้อมูลผู้ใช้ที่ตรงกับ userEmail");
                }
            } else {
                console.log('โปรดโหลดข้อมูลผู้ใช้ก่อนอัปเดต');
            }
        });

        async function uploadFile(selectedFile, userToUpdate, newUsername) {
            if (!selectedFile) {
                console.error("ไม่มีไฟล์ที่เลือก");
                return;
            }

            const storage = getStorage();
            const fileRef = storageRef(storage, `images/${selectedFile.name}`);

            try {
                const snapshot = await uploadBytes(fileRef, selectedFile);
                console.log('Uploaded file successfully');

                const downloadURL = await getDownloadURL(snapshot.ref);
                await updateProfilePicture(userToUpdate.id, downloadURL);
                await updateUsername(userToUpdate.id, newUsername);
                alert("อัปเดตข้อมูลผู้ใช้เรียบร้อยแล้ว");
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการอัปโหลดภาพ:", error);
            }
        }

        // ใช้งานฟังก์ชัน
        const handleFileUpload = (e) => {
            const selectedFile = e.target.files[0]; // หามือถือไฟล์ที่ถูกเลือก
            uploadFile(selectedFile, userToUpdate, newUsername);
        };

        // ฟังก์ชันในการแสดงข้อมูลผู้ใช้ในหน้าต่างแก้ไขโปรไฟล์
        document.getElementById('editProfileBtn').addEventListener('click', async () => {
            // แสดงหน้าต่างแก้ไขโปรไฟล์

            editProfileModal.style.display = 'block';
            // เพิ่มการป้องกันการส่งคำสั่งฟอร์ม
            document.body.style.overflow = 'hidden'; // ป้องกันการเลื่อนหน้า
            // โหลดข้อมูลผู้ใช้ใหม่ก่อนอัปเดตโปรไฟล์
            const usergmtemp = localStorage.getItem('userEmail');
            await loadUsersData(usergmtemp);
            // อัปเดตข้อมูลผู้ใช้ในหน้าต่างแก้ไขโปรไฟล์
            updateProfileModal();
        });

        // ฟังก์ชันในการอัปเดตข้อมูลผู้ใช้ในหน้าต่างแก้ไขโปรไฟล์
        async function updateProfileModal() {
            const usergmtemp = localStorage.getItem('userEmail');
            const usernamePreviewInput = document.getElementById('usernamePreview');
            const profilePicPreview = document.getElementById('profilePicPreview');
            const userID = document.getElementById('userID');
            const date = document.getElementById('date');
            const email = document.getElementById('email');
            const nameU = document.getElementById('nameU');
            const picU = document.getElementById('picU');
            const money = document.getElementById('money');

            // เข้าถึงข้อมูลผู้ใช้ภายนอกฟังก์ชัน
            if (userDatagm.length > 0) {
                usernamePreviewInput.value = userDatagm[0].username;
                nameU.textContent = userDatagm[0].username;
                profilePicPreview.src = userDatagm[0].picture;
                picU.src = userDatagm[0].picture;
                userID.textContent = "uid : " + userDatagm[0].accoutpp;
                email.textContent = "email : " + userDatagm[0].email;
                date.textContent = "date : " + userDatagm[0].created_at.toLocaleString();
                money.textContent = userDatagm[0].money;

            } else {
                console.log('ไม่พบข้อมูลผู้ใช้');
            }
        }

        // สร้างตัวแปรสำหรับหน้าต่างแก้ไขโปรไฟล์
        const editProfileModal = document.getElementById('editProfileModal');
        // สร้างตัวแปรสำหรับปุ่มปิด
        const closeButton = document.querySelector('.close');
        // ตัวจับเหตุการณ์เมื่อผู้ใช้คลิกที่ปุ่มปิด
        closeButton.addEventListener('click', () => {
            // ปิดหน้าต่างแก้ไขโปรไฟล์
            editProfileModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        });

        // ตัวจับเหตุการณ์เมื่อผู้ใช้คลิกที่พื้นหลังเพื่อปิดหน้าต่าง
        window.addEventListener('click', (event) => {
            if (event.target === editProfileModal) {
                // ปิดหน้าต่างแก้ไขโปรไฟล์เมื่อคลิกที่พื้นหลัง
                editProfileModal.style.display = 'none';
                // คืนค่าการเลื่อนหน้าให้เป็นปกติ
                document.body.style.overflow = 'auto';
            }
        });

        // ฟังก์ชันสำหรับอัปเดตชื่อผู้ใช้ใน Firestore
        async function updateUsername(userId, newUsername) {
            const userRef = doc(db, 'usersgame', userId);
            try {
                await updateDoc(userRef, { username: newUsername });
                console.log('ชื่อผู้ใช้อัปเดตเรียบร้อย');
            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการอัปเดตชื่อผู้ใช้:', error);
                throw error;
            }
        }

        // ฟังก์ชันสำหรับอัปเดต URL ภาพโปรไฟล์ใน Firestore
        async function updateProfilePicture(userId, downloadURL) {
            const userRef = doc(db, 'usersgame', userId);
            try {
                await updateDoc(userRef, { picture: downloadURL });
                console.log('URL ภาพโปรไฟล์อัปเดตเรียบร้อย');
            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการอัปเดตภาพโปรไฟล์:', error);
                throw error;
            }
        }



        // คำสั่งในการเพิ่มปุ่มสำหรับการเลือกภาพโปรไฟล์
        const changeProfilePicBtn = document.getElementById('profilePicPreview');
        const profilePicInput = document.getElementById('profilePicInput');

        changeProfilePicBtn.addEventListener('click', () => {
            profilePicInput.click(); // คลิกที่ input เพื่อเปิดตัวเลือกไฟล์
        });

        window.onload = function () {
            var profilePicPreview = document.getElementById('profilePicPreview');

            if (profilePicPreview) {
                document.getElementById('profilePicInput').addEventListener('change', function (event) {
                    var reader = new FileReader();

                    reader.onload = function () {
                        if (profilePicPreview) {
                            profilePicPreview.src = reader.result;  // Set the preview image
                        } else {
                            console.error('profilePicPreview is null. Ensure the <img> element with id="profilePicPreview" exists in the HTML.');
                        }
                    };

                    reader.readAsDataURL(event.target.files[0]);  // Read the selected file
                });
            } else {
                console.error('profilePicPreview is null. Check if the element exists in the DOM.');
            }
        };

        document.getElementById('profilePicInput').addEventListener('change', function (event) {
            var reader = new FileReader();
            reader.onload = function () {
                var profilePicPreview = document.getElementById('profilePicPreview');
                if (profilePicPreview) {
                    profilePicPreview.src = reader.result;  // ตั้งค่าภาพตัวอย่างจากไฟล์ที่อัปโหลด
                } else {
                    console.error('profilePicPreview is null. Ensure the <img> element with id="profilePicPreview" exists in the HTML.');
                }
            };
            reader.readAsDataURL(event.target.files[0]);  // อ่านไฟล์ที่ถูกเลือก
        });















        let userMoney = 0;
        let moneyUser = true;
        let state_run = false;
        async function startAuction(minBid) {
            state_run = true;
            console.log("เตรียมข้อมูลสำหรับเข้าร่วมประมูล");

            const userEmail = localStorage.getItem('userEmail');

            // ตรวจสอบว่าผู้ใช้เข้าสู่ระบบหรือไม่
            if (!userEmail || userEmail.trim() === "") {
                alert('กรุณาเข้าสู่ระบบ'); // แจ้งเตือนเมื่อไม่มีอีเมลผู้ใช้
                return;
            }

            localStorage.setItem('userMoney', userMoney);
            localStorage.setItem('countUsers', countUsers);

            console.log("จำนวนคนทั้งหมดที่ดึงมา:" + countUsers);
            // ตรวจสอบว่า userEmail ไม่เป็นค่าว่าง
            if (!userEmail || userEmail.trim() === "") {
                alert('ไม่พบอีเมลผู้ใช้');
                return;
            }

            // ตรวจสอบสถานะและเงินของผู้ใช้
            if (countUsers < 2) {/*************************   ตอนใช้จริงอย่าลืมปรับเป็น 2  *****************************/
                alert("รอผู้ใช้เพิ่มอีก 1 คน");
            } else if (userMoney < minBid) {
                moneyUser = false;
                alert("เงินน้อยกว่าบิดขั้นต่ำ"); // แสดงข้อความเมื่อเงินไม่เพียงพอ

            } else if (countUsers >= 2) {
                console.log("การประมูลเริ่มแล้ว");
                startCountdown(5); // เริ่มนับถอยหลัง
            }

            if (moneyUser) {
                checkAndPushEmail(userEmail);
            }
        }

        // ตรวจสอบอีเมลก่อนส่ง
        async function checkAndPushEmail(userEmail) {
            onValue(ref(getdata, 'countall'), (snapshot) => {
                const data = snapshot.val();
                let emailExists = false;

                // ถ้ามีข้อมูลใน snapshot
                if (data) {
                    // วนลูปเพื่อตรวจสอบอีเมลในฐานข้อมูล
                    for (const key in data) {
                        if (data[key].user === userEmail) {
                            emailExists = true;
                            break;
                        }
                    }
                }

                // ถ้าไม่พบอีเมล ทำการส่งข้อมูล
                if (!emailExists) {

                    set(push(ref(getdata, 'countall')), {
                        user: userEmail
                    });
                    console.log('ข้อมูลถูกส่งเรียบร้อยแล้ว');
                } else {
                    console.log('อีเมลนี้มีอยู่ในฐานข้อมูลแล้ว');
                }
            }, {
                onlyOnce: true  // ทำให้ onValue ทำงานเพียงครั้งเดียว
            });
        }
        let html;
        // โหลดสินค้าประมูล
        document.addEventListener('DOMContentLoaded', async function () {
            const bb = localStorage.getItem('bid');
            let bid2 = parseInt(localStorage.getItem('bb'));


            // ดึงอีเมลผู้ใช้จาก localStorage
            const userEmail = localStorage.getItem('userEmail');


            // ตรวจสอบว่าผู้ใช้เข้าสู่ระบบหรือไม่
            if (!userEmail || userEmail.trim() === "") {
                alert('กรุณาเข้าสู่ระบบ'); // แจ้งเตือนเมื่อไม่มีอีเมลผู้ใช้
                return;
            }

            onValue(ref(getdata, 'countall'), (snapshot) => {
                const data = snapshot.val();

                if (data) {
                    countUsers = Object.keys(data).length; // นับจำนวนคีย์ที่อยู่ใน data (จำนวนผู้ใช้ที่ถูกเก็บ)
                    console.log(`มีผู้ใช้ทั้งหมด: ${countUsers} คน`);

                    // คุณสามารถใช้ข้อมูลนี้ในการสร้าง HTML หรือแจ้งเตือนผู้ใช้ได้ตามต้องการ
                    html = `เข้าร่วม: ${countUsers} คน ขั้นต่ำต้อง2คน`;
                    localStorage.setItem('countUsers', countUsers);

                    const userCountDisplay = document.getElementById('userCountDisplay');
                    userCountDisplay.textContent = html;
                    if (state_run) {
                        startAuction(bid2);
                    }

                } else {
                    const userCountDisplay = document.getElementById('userCountDisplay');
                    userCountDisplay.textContent = html;
                    console.log('ไม่พบข้อมูลใน countall');
                    html = `เข้าร่วม: ${countUsers} คน`;
                    localStorage.setItem('countUsers', countUsers);

                }
            });



            // ฟังก์ชันสำหรับลบปุ่มเข้าร่วมประมูล
            function removeBidButtons() {
                const bidButtons = document.querySelectorAll('.btn');
                bidButtons.forEach(button => {
                    button.remove();
                });
            }
        });

        function startCountdown(seconds) {
            console.log("เริ่มนับเวลา");
            const timerDisplay = document.getElementById('auction-timer');
            let timeLeft = seconds;

            const timer = setInterval(() => {
                if (timeLeft <= 0) {
                    console.log("เริ่มการประมูลแล้ว");
                    // เปลี่ยนหน้าไปยังหน้าการประมูล
                    window.location.href = "auction-page.html";
                } else {
                    timerDisplay.innerHTML = `เวลาที่เหลือ: ${timeLeft} วินาที`;
                    timeLeft--;
                }
            }, 1000);
        }

        // ฟังก์ชันในการโหลดสินค้าในคลังของผู้ใช้
        async function loadUserInventory() {
            const userEmail = localStorage.getItem('userEmail');

            if (!userEmail || userEmail.trim() === "") {
                console.error('กรุณาเข้าสู่ระบบ'); // แจ้งเตือนเมื่อไม่มีอีเมลผู้ใช้
                return;
            }

            try {
                // สร้างการค้นหาผู้ใช้ใน Firestore ตามอีเมล
                const userQuery = query(collection(db, 'usersgame'), where('email', '==', userEmail));
                const querySnapshot = await getDocs(userQuery);

                if (querySnapshot.empty) {
                    console.error('ไม่พบข้อมูลผู้ใช้');
                    return;
                }

                // ดึงข้อมูลจากเอกสารแรกที่ค้นพบ
                let userData;
                querySnapshot.forEach((doc) => {
                    userData = doc.data(); // ดึงข้อมูลผู้ใช้
                });

                const bagItems = userData.bag || []; // ดึงข้อมูลจาก bag

                const inventoryDiv = document.getElementById('inventory-items');
                inventoryDiv.innerHTML = ''; // เคลียร์ข้อมูลก่อนแสดงใหม่

                // แสดงจำนวนสินค้าทั้งหมด
                const totalItems = bagItems.length;
                const totalItemsDiv = document.getElementById('total-items');
                totalItemsDiv.innerHTML = `<p>จำนวนสินค้าทั้งหมดในคลัง: ${totalItems} รายการ</p>`;


                if (totalItems > 0) {
                    bagItems.forEach(item => {
                        const itemElement = document.createElement('div');
                        itemElement.classList.add('inventory-item');

                        // ตรวจสอบและแปลงวันที่พร้อมเวลา ถ้าเป็น Timestamp
                        const itemDate = item.date && item.date.toDate
                            ? item.date.toDate().toLocaleString() // แปลงเป็นวันที่และเวลา
                            : item.date;

                        itemElement.innerHTML = `                       
                            <img src="${item.image}" style="height: 100px; width: 100px;" alt="${item.name}">
                            <div class="details">
                                <strong>${item.name}</strong>
                                <p>รายละเอียด: ${item.description}</p> 
                                <p>รับเมื่อ: ${itemDate}</p> 
                                <p>ราคาเริ่มต้น: ${item.price} บาท</p>
                                <p>ประมูลจบในราคา: ${item.bid} บาท</p>
                            </div>                      
                        `;

                        inventoryDiv.appendChild(itemElement);
                    });
                } else {
                    inventoryDiv.innerHTML = '<p>ไม่มีสินค้าในคลัง</p>';
                }
                return bagItems; // คืนข้อมูลสินค้าผู้ใช้
            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการดึงข้อมูล:', error);
            }
        }

        // ฟังก์ชันโหลดสินค้าจากร้านค้าและแสดงปุ่มขายเฉพาะสินค้าที่ผู้ใช้มีในคลัง 
        async function loadShopAndCompareWithInventory() {
            const bagItems = await loadUserInventory(); // โหลดสินค้าของผู้ใช้
            const userItemsNames = bagItems.map(item => item.name); // รายชื่อสินค้าที่ผู้ใช้มี

            try {
                const querySnapshot = await getDocs(collection(db, 'products'));
                let allItems = [];

                querySnapshot.forEach((doc) => {
                    const productData = doc.data();
                    Object.keys(productData).forEach(key => {
                        const productArray = productData[key];

                        if (Array.isArray(productArray)) {
                            productArray.forEach((itemData) => {
                                allItems.push(itemData);
                            });
                        }
                    });
                });

                const shopContainer = document.getElementById('shop-items');
                const moreItemsContainer = document.getElementById('more-items');
                shopContainer.innerHTML = ''; // ล้างข้อมูลเดิม
                moreItemsContainer.innerHTML = ''; // ล้างข้อมูลเดิมสำหรับรายการเพิ่มเติม

                allItems.forEach((itemData, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('shop-item');
                    itemElement.innerHTML = `
                <img src="${itemData.image}" alt="Item" style="height: 100px; width: 100px;" onclick="openModal('${itemData.image}')">
                <div class="details">
                    <strong style="font-size:larger; color:red;">${itemData.name}</strong>
                    <p>${itemData.description}</p>
                </div>
                <div>ราคาซื้อ: ${itemData.sell} บาท</div>
            `;

                    // ตรวจสอบว่าผู้ใช้มีสินค้านี้หรือไม่
                    if (userItemsNames.includes(itemData.name)) {
                        const sellButton = document.createElement('button');
                        sellButton.classList.add('btn');
                        sellButton.textContent = 'ขาย';
                        sellButton.onclick = () => sellItem(itemData.name, itemData.sell); // ส่งชื่อและราคาสินค้าไปยังฟังก์ชันขาย
                        itemElement.appendChild(sellButton);
                    }

                    // แสดงรายการเฉพาะ 2 รายการแรกใน shopContainer
                    if (index < 2) {
                        shopContainer.appendChild(itemElement);
                    } else {
                        moreItemsContainer.appendChild(itemElement); // รายการที่เหลือไปยัง moreItemsContainer
                    }
                });

                // ซ่อน moreItemsContainer ถ้าไม่มีรายการ
                moreItemsContainer.classList.add("hidden");
                if (moreItemsContainer.children.length > 0) {
                    moreItemsContainer.classList.remove("hidden"); // แสดงถ้ามีรายการใน moreItemsContainer
                }

                const usergmtemp = localStorage.getItem('userEmail');
                await loadUsersData(usergmtemp);
                // อัปเดตข้อมูลผู้ใช้ในหน้าต่างแก้ไขโปรไฟล์
                updateProfileModal();
            } catch (error) {
                console.error("Error getting documents: ", error);
            }
        }

        // ฟังก์ชันขายสินค้า
        async function sellItem(itemName, price) {
            const userEmail = localStorage.getItem('userEmail');
            if (!userEmail || userEmail.trim() === "") {
                console.error('กรุณาเข้าสู่ระบบ');
                return;
            }

            try {
                // ค้นหาผู้ใช้จากอีเมล
                const userQuery = query(collection(db, 'usersgame'), where('email', '==', userEmail));
                const querySnapshot = await getDocs(userQuery);

                if (querySnapshot.empty) {
                    console.error('ไม่พบข้อมูลผู้ใช้');
                    return;
                }

                let userDocId;
                let userData;

                querySnapshot.forEach((doc) => {
                    userDocId = doc.id;
                    userData = doc.data();
                });

                // ลบสินค้าชิ้นแรกที่ตรงกับ itemName ออกจากคลังผู้ใช้
                let updatedBag = [...userData.bag]; // คัดลอก bag เพื่อแก้ไข
                const itemIndex = updatedBag.findIndex(item => item.name === itemName);

                if (itemIndex !== -1) {
                    updatedBag.splice(itemIndex, 1); // ลบสินค้าชิ้นแรกที่ตรงกับชื่อออก
                } else {
                    console.error('ไม่พบสินค้าที่ต้องการขาย');
                    return;
                }

                const updatedMoney = (userData.money || 0) + price; // เพิ่มเงินตามราคาสินค้าที่ขาย

                // อัพเดตข้อมูลใน Firestore
                await updateDoc(doc(db, 'usersgame', userDocId), {
                    bag: updatedBag,
                    money: updatedMoney
                });

                console.log(`ขาย ${itemName} ในราคา ${price} บาทสำเร็จ!`);
                alert(`ขาย ${itemName} สำเร็จ! เงินเพิ่ม ${price} บาท`);

                // อัพเดตหน้าจอหลังจากขายสินค้า
                await loadShopAndCompareWithInventory();
            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการขายสินค้า:', error);
            }
        }

        // เรียกใช้งานฟังก์ชันเมื่อโหลดหน้า
        document.addEventListener('DOMContentLoaded', async function () {
            await loadShopAndCompareWithInventory(); // โหลดสินค้าร้านค้าและเปรียบเทียบกับคลังของผู้ใช้
            toggleItems();
        });
        function toggleItems() {
            const moreItems = document.getElementById("more-items");
            if (moreItems.classList.contains("hidden")) {
                moreItems.classList.remove("hidden");
            } else {
                moreItems.classList.add("hidden");
            }
        }

















        /************   ยืมเครื่องผู้ใช้อัปเดตข้อมูล   ************/
        async function fetchFromFirebase() {
            const querySnapshot = await getDocs(collection(db, 'products'));
            let firebaseProducts = [];

            querySnapshot.forEach((doc) => {
                const productData = doc.data();
                Object.keys(productData).forEach(key => {
                    const productArray = productData[key];
                    if (Array.isArray(productArray)) {
                        productArray.forEach((itemData) => {
                            firebaseProducts.push(itemData);
                        });
                    }
                });
            });

            return firebaseProducts;
        }

        async function fetchFromJSON() {
            const response = await fetch('products.json');
            const jsonData = await response.json();
            return jsonData;
        }

        async function updateProductsIfNeeded() {
            const firebaseProducts = await fetchFromFirebase();
            const jsonData = await fetchFromJSON();

            // เปลี่ยน firebasePd และ jsonDt ให้เป็น jsonสตริงเพื่เปียบเทียบ
            const firebaseProductsString = JSON.stringify(firebaseProducts);
            const jsonDataString = JSON.stringify(jsonData);

            if (firebaseProductsString !== jsonDataString) {
                console.log('มีข้อมูลไม่ตรงกัน จะทำการอัปเดตข้อมูล...');

                await updateJSONFile(firebaseProducts);
            } else {
                console.log('ข้อมูลตรงกัน ไม่มีการอัปเดต');
            }
        }

        async function updateJSONFile(data) {
            const response = await fetch('updatedata.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                console.log('อัปเดตสำเร็จ');
            } else {
                console.error('การอัปเดตไม่สำเร็จ:', response.statusText);
            }
        }

        document.addEventListener('DOMContentLoaded', async function () {
            await updateProductsIfNeeded();
        });

        document.getElementById('rankButton').addEventListener('click', async function () {
            const rankingTableContainer = document.getElementById('rankingTableContainer');
            const rankingTableBody = document.getElementById('rankingTable').querySelector('tbody');

            try {
                // ดึงข้อมูลผู้ใช้ทั้งหมดจาก Firestore
                const querySnapshot = await getDocs(collection(db, 'usersgame'));
                let usersList = [];

                querySnapshot.forEach((userDoc) => {
                    const userData = userDoc.data();
                    const { username, picture, money } = userData;
                    usersList.push({
                        username: username,
                        picture: picture,
                        money: money
                    });
                });

                // จัดเรียงข้อมูลตามจำนวนเงินจากมากไปน้อย
                usersList.sort((a, b) => b.money - a.money);

                // ล้างข้อมูลเก่าในตาราง
                rankingTableBody.innerHTML = '';

                // แสดงข้อมูลในตาราง
                usersList.forEach((user, index) => {
                    const row = rankingTableBody.insertRow();

                    const rankCell = row.insertCell(0);
                    rankCell.textContent = index + 1;

                    const pictureCell = row.insertCell(1);
                    const img = document.createElement('img');
                    img.src = user.picture;
                    img.alt = 'Profile Picture';
                    img.width = 50; // กำหนดขนาดภาพ
                    pictureCell.appendChild(img);

                    const usernameCell = row.insertCell(2);
                    usernameCell.textContent = user.username;

                    const moneyCell = row.insertCell(3);
                    moneyCell.textContent = user.money;
                });

                // แสดงตารางอันดับ
                rankingTableContainer.style.display = 'block';
            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการโหลดข้อมูลผู้ใช้:', error);
            }
        });












































    </script>
    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</body>

</html>