<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ระบบสร้างโปสเตอร์ PM2.5 อัตโนมัติ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <style>
      body {
        font-family: 'Tahoma', sans-serif;
      }
      .no-capture {
        display: none !important;
      }
      /* === CSS ที่แก้ไขและเพิ่มเติม เริ่มต้น === */
      .map-marker-container {
        position: absolute;
        transform: translate(
          -50%,
          -50%
        ); /* ย้าย transform มาที่ container หลัก */
      }
      .map-marker-dot {
        position: absolute;
        top: 0;
        left: 0;
        width: 10px;
        height: 10px;
        background-color: red;
        border-radius: 50%;
        border: 2px solid white;
        transform: translate(-50%, -50%);
        z-index: 99;
      }
      .leader-line-svg {
        position: absolute;
        top: 0;
        left: 0;
        overflow: visible;
        z-index: 9;
      }
      .leader-line-svg line {
        stroke: #333;
        stroke-width: 1.5;
      }
      .map-label-content {
        position: absolute;
        display: flex;
        align-items: center;
        white-space: nowrap;
        z-index: 999;
      }
      .map-label-number {
        z-index: 9999;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 12px;
        margin-right: 5px;
        border: 1px solid rgba(0, 0, 0, 0.2);
      }
      .map-label-text {
        padding: 3px 8px;
        border-radius: 5px;
        font-size: 12px;
        font-weight: bold;
      }
      /* === CSS ที่แก้ไขและเพิ่มเติม สิ้นสุด === */
      #top-5-list {
        position: absolute;
        top: 359px;
        left: 518px;
        width: 280px;
        font-size: 14px;
        font-weight: bolder;
        line-height: 2.3;
      }
      #bottom-5-list {
        position: absolute;
        top: 650px;
        left: 518px;
        width: 280px;
        font-size: 14px;
        font-weight: bolder;
        line-height: 2.3;
      }
      #date-display {
        position: absolute;
        top: 238px;
        left: 520px;
        font-size: 20px;
        font-weight: bolder;
        color: #000000;
      }
      /* ตำแหน่งของจุดบนแผนที่ (ไม่มีการเปลี่ยนแปลง) */
      [data-location-id='location-1'] {
        top: 24.25%;
        left: 31.75%;
      }
      [data-location-id='location-2'] {
        top: 20%;
        left: 37%;
      }
      [data-location-id='location-3'] {
        top: 11%;
        left: 31%;
      }
      [data-location-id='location-4'] {
        top: 27.5%;
        left: 12%;
      }
      [data-location-id='location-5'] {
        top: 16%;
        left: 9%;
      }
      [data-location-id='location-6'] {
        top: 33%;
        left: 22.65%;
      }
      [data-location-id='location-7'] {
        top: 34%;
        left: 43%;
      }
      [data-location-id='location-8'] {
        top: 42.5%;
        left: 20%;
      }
      [data-location-id='location-9'] {
        top: 51%;
        left: 24.5%;
      }
      [data-location-id='location-10'] {
        top: 65.5%;
        left: 45%;
      }
      [data-location-id='location-11'] {
        top: 56.5%;
        left: 39.5%;
      }
      [data-location-id='location-12'] {
        top: 80.2%;
        left: 53.2%;
      }
      [data-location-id='location-13'] {
        top: 70.6%;
        left: 47.1%;
      }
      [data-location-id='location-14'] {
        top: 63%;
        left: 48%;
      }
      [data-location-id='location-15'] {
        top: 51%;
        left: 46.3%;
      }
      [data-location-id='location-16'] {
        top: 46%;
        left: 44.5%;
      }
      [data-location-id='location-17'] {
        top: 43.6%;
        left: 42.6%;
      }
      [data-location-id='location-18'] {
        top: 42%;
        left: 37%;
      }
      [data-location-id='location-19'] {
        top: 35%;
        left: 35.8%;
      }
      [data-location-id='location-20'] {
        top: 46%;
        left: 34.8%;
      }
    </style>
  </head>
  <body class="bg-gray-100 p-4 sm:p-8">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-2xl font-bold mb-4 text-gray-800">
        ระบบสร้างโปสเตอร์ PM2.5 อัตโนมัติ
      </h1>

      <div id="controls" class="bg-white p-6 rounded-lg shadow-md mb-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label
              for="locationName"
              class="block text-sm font-medium text-gray-700"
            >
              ชื่อสถานที่
            </label>
            <input
              type="text"
              id="locationName"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
              placeholder="เช่น อาคาร KB"
              list="locationSuggestions"
            />
            <datalist id="locationSuggestions"></datalist>
          </div>
          <div>
            <label
              for="dustValue"
              class="block text-sm font-medium text-gray-700"
            >
              ค่าฝุ่น (PM2.5)
            </label>
            <input
              type="number"
              id="dustValue"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
              placeholder="เช่น 35"
            />
          </div>
          <div class="self-end">
            <button
              id="addLocationBtn"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors"
            >
              เพิ่มสถานที่
            </button>
          </div>
        </div>
        <div class="mt-4">
          <div>
            <label
              for="reportDate"
              class="block text-sm font-medium text-gray-700"
            >
              วันที่สรุปผล
            </label>
            <input
              type="date"
              id="reportDate"
              class="mt-1 block w-full md:w-1/3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
            />
          </div>
        </div>
        <hr class="my-6" />

        <div>
          <label
            for="jsonInput"
            class="block text-sm font-medium text-gray-700"
          >
            ป้อนข้อมูลทั้งหมดในรูปแบบ JSON
          </label>
          <textarea
            id="jsonInput"
            rows="10"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
            placeholder='[&#10;  { "name": "อาคาร KB", "value": 45.2 },&#10;  { "name": "คณะสหเวชศาสตร์", "value": 22.8 }&#10;]'
          ></textarea>
          <div class="mt-2 flex gap-x-2">
            <button
              id="processJsonBtn"
              class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors"
            >
              นำเข้าข้อมูลจาก JSON
            </button>
            <button
              id="loadDemoDataBtn"
              class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors"
            >
              ข้อมูลจำลอง
            </button>
          </div>
        </div>
        <div id="locationList" class="mt-6"></div>
      </div>

      <div class="flex flex-col items-center">
        <button
          id="captureBtn"
          class="mb-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors"
        >
          ดาวน์โหลดรูปภาพโปสเตอร์
        </button>

        <div
          id="posterContainer"
          class="relative shadow-lg"
          style="
            width: 800px;
            height: 1131px;
            background-size: cover;
            background-position: center;
            background-image: url('template.jpg');
          "
        >
          <div id="date-display"></div>
          <div id="top-5-list" class="space-y-2 text-gray-800"></div>
          <div id="bottom-5-list" class="space-y-2 text-gray-800"></div>
          <div id="map-markers"></div>
        </div>
      </div>
    </div>

    <script>
      const mapLocations = [
        { id: 'location-1', name: 'สำนักงานอธิการบดี' },
        { id: 'location-2', name: 'อาคาร KB' },
        { id: 'location-3', name: 'ป้ายรถหน้ามหาวิทยาลัย' },
        { id: 'location-4', name: 'คณะสหเวชศาสตร์' },
        { id: 'location-5', name: 'หอพักนิสิตแพทย์' },
        { id: 'location-6', name: 'หอพักนานาชาติ' },
        { id: 'location-7', name: 'สำนักหอสมุด' },
        { id: 'location-8', name: 'โรงเรียนสาธิตฯ' },
        { id: 'location-9', name: 'โรงเรียนสาธิตฯ อินเตอร์' },
        { id: 'location-10', name: 'คณะบริหาร' },
        { id: 'location-11', name: 'สระว่ายน้ำ' },
        { id: 'location-12', name: 'อาคารที่พักบุคลากร' },
        { id: 'location-13', name: 'อาคารพักอาศัยเสนาะ' },
        { id: 'location-14', name: 'หอพักเทาทอง 4' },
        { id: 'location-15', name: 'หอพักเทาทอง 2' },
        { id: 'location-16', name: 'โรงอาหารโภชนาการ' },
        { id: 'location-17', name: 'ลานเกือกม้า' },
        { id: 'location-18', name: 'ป้ายรถกองกิจ' },
        { id: 'location-19', name: 'สำนักบริการวิชาการ' },
        { id: 'location-20', name: 'คณะมนุษย์ฯ' },
      ];
      let enteredLocations = [];

      const locationSuggestionsDatalist = document.getElementById(
        'locationSuggestions'
      );
      const locationNameInput = document.getElementById('locationName');
      const dustValueInput = document.getElementById('dustValue');
      const addLocationBtn = document.getElementById('addLocationBtn');
      const locationListDiv = document.getElementById('locationList');
      const captureBtn = document.getElementById('captureBtn');
      const posterContainer = document.getElementById('posterContainer');
      const top5List = document.getElementById('top-5-list');
      const bottom5List = document.getElementById('bottom-5-list');
      const mapMarkersContainer = document.getElementById('map-markers');
      const dateInput = document.getElementById('reportDate');
      const dateDisplay = document.getElementById('date-display');

      // --- Element ที่เพิ่มเข้ามา ---
      const jsonInput = document.getElementById('jsonInput');
      const processJsonBtn = document.getElementById('processJsonBtn');
      const loadDemoDataBtn = document.getElementById('loadDemoDataBtn');

      dateInput.valueAsDate = new Date();
      renderAll();

      addLocationBtn.addEventListener('click', addLocation);
      captureBtn.addEventListener('click', capturePoster);
      dateInput.addEventListener('change', updateDateDisplay);
      locationListDiv.addEventListener('click', handleListClick);

      loadDemoDataBtn.addEventListener('click', loadDemoData);
      processJsonBtn.addEventListener('click', processJsonData);

      // --- ฟังก์ชันที่เพิ่มเข้ามา เริ่มต้น ---
      function loadDemoData() {
        const demoData = [
          { name: 'หอพักเทาทอง 4', value: 85.2 },
          { name: 'อาคารพักอาศัยเสนาะ', value: 78.9 },
          { name: 'หอพักเทาทอง 2', value: 48.3 },
          { name: 'โรงอาหารโภชนาการ', value: 21.0 },
          { name: 'คณะบริหาร', value: 18.9 },
          { name: 'สระว่ายน้ำ', value: 12.5 },
          { name: 'สำนักงานอธิการบดี', value: 0 },
          { name: 'อาคาร KB', value: 0 },
          { name: 'ป้ายรถหน้ามหาวิทยาลัย', value: 0 },
          { name: 'คณะสหเวชศาสตร์', value: 0 },
          { name: 'หอพักนิสิตแพทย์', value: 0 },
          { name: 'หอพักนานาชาติ', value: 0 },
          { name: 'สำนักหอสมุด', value: 0 },
          { name: 'โรงเรียนสาธิตฯ', value: 0 },
          { name: 'โรงเรียนสาธิตฯ อินเตอร์', value: 0 },
          { name: 'อาคารที่พักบุคลากร', value: 0 },
          { name: 'ลานเกือกม้า', value: 0 },
          { name: 'ป้ายรถกองกิจ', value: 0 },
          { name: 'สำนักบริการวิชาการ', value: 0 },
          { name: 'คณะมนุษย์ฯ', value: 0 },
        ];
        // แปลง Object เป็น String JSON ที่จัดรูปแบบสวยงาม
        jsonInput.value = JSON.stringify(demoData, null, 2);
      }

      function processJsonData() {
        const jsonString = jsonInput.value;
        jsonInput.classList.remove('border-red-500', 'border-green-500');

        if (!jsonString.trim()) {
          alert('กรุณาป้อนข้อมูล JSON');
          jsonInput.classList.add('border-red-500');
          return;
        }

        try {
          const data = JSON.parse(jsonString);
          if (!Array.isArray(data)) {
            throw new Error('ข้อมูลต้องเป็น Array');
          }
          // ตรวจสอบว่าทุก object มี key 'name' และ 'value'
          const isValid = data.every(
            (item) =>
              typeof item === 'object' &&
              item !== null &&
              'name' in item &&
              'value' in item &&
              typeof item.name === 'string' &&
              typeof item.value === 'number'
          );

          if (!isValid) {
            throw new Error(
              "ข้อมูลใน Array ไม่ถูกต้อง ทุกๆ item ต้องมี { name: 'ชื่อสถานที่', value: ค่าฝุ่น }"
            );
          }

          // แทนที่ข้อมูลเก่าด้วยข้อมูลใหม่จาก JSON
          enteredLocations = data;
          renderAll();
          jsonInput.classList.add('border-green-500');
        } catch (error) {
          alert('รูปแบบ JSON ไม่ถูกต้อง: ' + error.message);
          jsonInput.classList.add('border-red-500');
        }
      }

      function populateLocationSuggestions() {
        locationSuggestionsDatalist.innerHTML = '';
        const enteredNames = enteredLocations.map((loc) => loc.name);
        const availableLocations = mapLocations.filter(
          (loc) => !enteredNames.includes(loc.name)
        );
        availableLocations.forEach((loc) => {
          const option = document.createElement('option');
          option.value = loc.name;
          locationSuggestionsDatalist.appendChild(option);
        });
      }

      function updateDateDisplay() {
        const date = new Date(dateInput.value);
        if (!isNaN(date)) {
          const options = { year: 'numeric', month: 'long', day: 'numeric' };
          dateDisplay.textContent =
            'ประจำวันที่ ' + date.toLocaleDateString('th-TH', options);
        }
      }

      function addLocation() {
        const name = locationNameInput.value.trim();
        const value = parseFloat(dustValueInput.value);
        if (name && !isNaN(value)) {
          const existingLocation = enteredLocations.find(
            (loc) => loc.name === name
          );
          if (existingLocation) {
            existingLocation.value = value;
          } else {
            enteredLocations.push({ name, value });
          }
          locationNameInput.value = '';
          dustValueInput.value = '';
          locationNameInput.focus();
          renderAll();
        } else {
          if (!name) locationNameInput.classList.add('border-red-500');
          if (isNaN(value)) dustValueInput.classList.add('border-red-500');

          setTimeout(() => {
            locationNameInput.classList.remove('border-red-500');
            dustValueInput.classList.remove('border-red-500');
          }, 2000);
        }
      }

      function handleListClick(e) {
        if (e.target.classList.contains('remove-btn')) {
          const nameToRemove = e.target.dataset.name;
          enteredLocations = enteredLocations.filter(
            (loc) => loc.name !== nameToRemove
          );
          renderAll();
        }
      }

      function renderAll() {
        renderEnteredList();
        renderRankings();
        renderMapMarkers();
        populateLocationSuggestions();
        updateDateDisplay();
      }

      function renderEnteredList() {
        locationListDiv.innerHTML = '';
        if (enteredLocations.length === 0) {
          locationListDiv.innerHTML =
            '<p class="text-gray-500 text-sm">ยังไม่มีสถานที่ที่เพิ่มเข้ามา</p>';
          return;
        }

        const list = document.createElement('ul');
        list.className = 'space-y-2';
        [...enteredLocations]
          .sort((a, b) => a.name.localeCompare(b.name))
          .forEach((loc) => {
            const item = document.createElement('li');
            item.className =
              'flex justify-between items-center bg-gray-50 p-2 rounded-md';
            item.innerHTML = `<span><span class="font-semibold">${loc.name}</span>: ${loc.value}</span><button data-name="${loc.name}" class="remove-btn text-red-500 hover:text-red-700 font-bold">ลบ</button>`;
            list.appendChild(item);
          });
        locationListDiv.appendChild(list);
      }

      function getDustColorClasses(value) {
        if (value <= 15.0) {
          return { bg: 'bg-[#33cbf5]', text: 'text-white' }; // ฟ้า
        } else if (value <= 25.0) {
          return { bg: 'bg-[#33b773]', text: 'text-white' }; // เขียว
        } else if (value <= 37.5) {
          return { bg: 'bg-[#fdcc71]', text: 'text-white' }; // เหลือง
        } else if (value <= 75.0) {
          return { bg: 'bg-[#f4834e]', text: 'text-white' }; // ส้ม
        } else {
          return { bg: 'bg-[#ed1c24]', text: 'text-white' }; // แดง
        }
      }

      function renderRankings() {
        top5List.innerHTML = '';
        bottom5List.innerHTML = '';

        const sortedHigh = [...enteredLocations].sort(
          (a, b) => b.value - a.value
        );
        const top5 = sortedHigh.slice(0, 5);
        top5.forEach((loc) => {
          const div = document.createElement('div');
          div.className = 'flex justify-between items-center';
          const color = getDustColorClasses(loc.value);
          div.innerHTML = `
                          <span class="pr-4">${loc.name}</span>
                          <div class="flex items-center justify-center ${color.bg} ${color.text} rounded-full px-3 py-0.7" style="min-width: 102px;">
                              <span class="text-2xl font-bold mr-2">${loc.value}</span>
                              <span class="text-xs leading-tight">มคก./<br>ลบ.ม.</span>
                          </div>`;
          top5List.appendChild(div);
        });

        const sortedLow = [...enteredLocations].sort(
          (a, b) => a.value - b.value
        );
        const bottom5 = sortedLow.slice(0, 5);
        bottom5.forEach((loc) => {
          const div = document.createElement('div');
          div.className = 'flex justify-between items-center';
          const color = getDustColorClasses(loc.value);
          div.innerHTML = `
                          <span class="pr-4">${loc.name}</span>
                          <div class="flex items-center justify-center ${color.bg} ${color.text} rounded-full px-3 py-0.7" style="min-width: 102px;">
                              <span class="text-2xl font-bold mr-2">${loc.value}</span>
                              <span class="text-xs leading-tight">มคก./<br>ลบ.ม.</span>
                          </div>`;
          bottom5List.appendChild(div);
        });
      }

      function renderMapMarkers() {
        mapMarkersContainer.innerHTML = '';

        // กำหนดตำแหน่งการโยงเส้นของป้าย เพื่อป้องกันการทับกัน
        // ค่า x, y คือระยะห่างจากจุดศูนย์กลาง (หน่วยเป็น pixel)
        const labelOffsets = {
          'location-5': {
            x: 15,
            y: -30,
          },
          'location-4': {
            x: 24,
            y: -13,
          },
          'location-15': {
            x: -15,
            y: 20,
          },
          'location-3': {
            x: 24,
            y: 1,
          },
          'location-2': {
            x: 30,
            y: 0,
          },
          'location-1': {
            x: 30,
            y: 0,
          },
          'location-6': {
            x: 17,
            y: -35,
          },
          'location-19': {
            x: 19,
            y: 13,
          },
          'location-7': {
            x: 5,
            y: -25,
          },
          'location-8': {
            x: -10,
            y: 25,
          },
          'location-9': {
            x: -20,
            y: 25,
          },
          'location-11': {
            x: 0,
            y: 20,
          },
          'location-12': {
            x: -25,
            y: 25,
          },
          'location-13': {
            x: -50,
            y: 35,
          },
          'location-10': {
            x: 0,
            y: 20,
          },
          'location-14': {
            x: -30,
            y: -25,
          },
          'location-16': {
            x: -25,
            y: 25,
          },
          'location-18': {
            x: -5,
            y: -35,
          },
          'location-20': {
            x: -30,
            y: 50,
          },
        };

        const sortedHigh = [...enteredLocations].sort(
          (a, b) => b.value - a.value
        );
        const top5 = sortedHigh.slice(0, 5);

        top5.forEach((enteredLoc, index) => {
          const mapInfo = mapLocations.find(
            (ml) => ml.name === enteredLoc.name
          );

          if (mapInfo) {
            const container = document.createElement('div');
            container.className = 'map-marker-container';
            container.dataset.locationId = mapInfo.id;

            const dot = document.createElement('div');
            dot.className = 'map-marker-dot';

            const offset = labelOffsets[mapInfo.id] || { x: 15, y: -25 };

            const svgNS = 'http://www.w3.org/2000/svg';
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('class', 'leader-line-svg');

            const line = document.createElementNS(svgNS, 'line');
            line.setAttribute('x1', '0');
            line.setAttribute('y1', '0');
            line.setAttribute('x2', String(offset.x));
            line.setAttribute('y2', String(offset.y));
            svg.appendChild(line);

            const labelContent = document.createElement('div');
            labelContent.className = 'map-label-content';

            // --- จุดที่แก้ไข ---
            // เนื่องจากวงกลมตัวเลขมีขนาด 20x20px จุดศูนย์กลางจึงอยู่ที่ 10px
            // เราจึงต้องเลื่อนป้ายทั้งหมดไปทางซ้าย 10px และขึ้นไปข้างบน 10px
            // เพื่อให้ "จุดศูนย์กลางของวงกลม" มาอยู่ที่ปลายเส้นพอดี
            labelContent.style.transform = `translate(calc(${offset.x}px - 10px), calc(${offset.y}px - 10px))`;
            // --- สิ้นสุดจุดที่แก้ไข ---

            const color = getDustColorClasses(enteredLoc.value);

            const numberCircle = document.createElement('div');
            numberCircle.className = `map-label-number ${color.bg} ${color.text}`;
            numberCircle.textContent = index + 1;

            const labelText = document.createElement('div');
            labelText.className = `map-label-text ${color.bg} ${color.text}`;
            labelText.textContent = enteredLoc.name;

            labelContent.appendChild(numberCircle);
            labelContent.appendChild(labelText);

            container.appendChild(dot);
            container.appendChild(svg);
            container.appendChild(labelContent);
            mapMarkersContainer.appendChild(container);
          }
        });
      }

      async function capturePoster() {
        const captureButton = document.getElementById('captureBtn');
        const originalButtonText = captureButton.innerHTML;
        captureButton.innerHTML = 'กำลังประมวลผล...';
        captureButton.disabled = true;

        const elementsToHide = [
          document.getElementById('controls'),
          captureButton,
        ];
        elementsToHide.forEach((el) => el && el.classList.add('no-capture'));

        await new Promise((resolve) => setTimeout(resolve, 100));

        const node = document.getElementById('posterContainer');

        try {
          const dataUrl = await htmlToImage.toPng(node, {
            quality: 1.0,
            pixelRatio: 2,
          });

          const link = document.createElement('a');
          link.download = `pm25-poster-${dateInput.value}.png`;
          link.href = dataUrl;
          link.click();
        } catch (err) {
          console.error('Oops, something went wrong!', err);
        } finally {
          elementsToHide.forEach(
            (el) => el && el.classList.remove('no-capture')
          );
          captureButton.innerHTML = originalButtonText;
          captureButton.disabled = false;
        }
      }
    </script>
  </body>
</html>
