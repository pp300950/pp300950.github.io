
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Logic Flow Editor Pro - Responsive</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css" />
  <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet" />
  
  <style>
    :root {
      --bg-color: #f4f6f8;
      --grid-color: #e0e6ed;
      --panel-bg: #ffffff;
      --text-color: #333;
      --node-radius: 12px;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --debug-font-size: 13px;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Prompt', sans-serif;
      overflow: hidden;
      background-color: var(--bg-color);
      color: var(--text-color);
      touch-action: none;
    }

    #drawflow {
      height: 100vh;
      width: 100vw;
      position: relative;
      background-size: 25px 25px;
      background-image: radial-gradient(var(--grid-color) 2px, transparent 2px);
      background-position: 0px 0px;
      outline: none;
    }

    /* --- Toolbar / Palette --- */
    .palette {
      position: absolute;
      top: 10px;
      left: 10px;
      background: var(--panel-bg);
      padding: 12px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 160px;
      max-height: 60vh;
      overflow-y: auto;
      overflow-x: hidden;
      border: 1px solid #eee;
      transition: all 0.3s;
    }

    .palette.collapsed {
      height: 40px;
      overflow: hidden;
      padding-bottom: 0;
    }
    
    .palette.collapsed .drag-drawflow {
      display: none;
    }

    .palette-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .palette h3 {
      margin: 0;
      font-size: 14px;
      text-align: center;
      color: #555;
      font-weight: 600;
    }

    .toggle-palette-btn {
      cursor: pointer;
      color: #888;
      transition: transform 0.3s;
    }
    
    .palette.collapsed .toggle-palette-btn {
      transform: rotate(180deg);
    }

    .drag-drawflow {
      cursor: grab;
      background: #f8f9fa;
      color: #555;
      padding: 8px;
      border-radius: 8px;
      font-size: 12px;
      text-align: center;
      transition: all 0.2s;
      border: 1px solid #e2e8f0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .drag-drawflow:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .drag-drawflow[data-node='input'] { border-left: 4px solid #96e6a1; }
    .drag-drawflow[data-node='operation'] { border-left: 4px solid #8fd3f4; }
    .drag-drawflow[data-node='math'] { border-left: 4px solid #ff9a9e; }
    .drag-drawflow[data-node='gate'] { border-left: 4px solid #a18cd1; }
    .drag-drawflow[data-node='logic_and'] { border-left: 4px solid #f6d365; }
    .drag-drawflow[data-node='logic_not'] { border-left: 4px solid #4facfe; }
    .drag-drawflow[data-node='output'] { border-left: 4px solid #d57eeb; }
    .drag-drawflow[data-node='transistor'] { border-left: 4px solid #ff7f50; }

    /* --- Control Buttons --- */
    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 6px;
      z-index: 10;
      flex-wrap: wrap;
      max-width: calc(100% - 200px);
      justify-content: flex-end;
    }

    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
      font-weight: 600;
      font-size: 12px;
      box-shadow: var(--shadow);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      background: white;
      color: #444;
      border: 1px solid #eee;
      white-space: nowrap;
    }

    .btn:hover {
      background: #f8f9fa;
      transform: translateY(-1px);
    }
    
    .btn:active {
      transform: scale(0.95);
    }

    .btn-run {
      background: #4caf50;
      color: white;
      border: none;
    }
    
    .btn-run:hover {
      background: #43a047;
    }

    .btn-save {
      background: #2196f3;
      color: white;
      border: none;
    }
    
    .btn-save:hover {
      background: #1e88e5;
    }

    .btn-undo {
      background: #fff;
      color: #e67e22;
      border: 1px solid #e67e22;
    }
    
    .btn-undo:hover {
      background: #fff5e6;
    }

    .btn-probe {
      background: #607d8b;
      color: white;
      border: none;
    }
    
    .btn-probe:hover {
      background: #546e7a;
    }
    
    .btn-probe.active {
      background: #ffc107;
      color: #333;
      box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
      animation: pulse-border 2s infinite;
    }

    @keyframes pulse-border {
      0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
    }

    /* --- Tooltips and Floating Elements --- */
    #probe-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.85);
      color: #00e676;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 11px;
      pointer-events: none;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      border: 1px solid #333;
      font-family: 'Courier New', Courier, monospace;
      font-weight: bold;
    }

    #floating-copy-btn {
      position: absolute;
      display: none;
      background: #2196f3;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      z-index: 999;
      font-size: 11px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
      border: 2px solid white;
      transform: translate(-50%, -120%);
      animation: floatUp 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    }

    #floating-copy-btn:hover {
      background: #1976d2;
      transform: translate(-50%, -125%);
    }

    @keyframes floatUp {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -120%) scale(1);
      }
    }

    /* --- Debugger Panel --- */
    #debug-panel {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 40vh;
      min-height: 100px;
      max-height: 85vh;
      background: #2d3436;
      color: #dfe6e9;
      z-index: 20;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease-in-out;
      transform: translateY(100%);
    }

    #debug-panel.active {
      transform: translateY(0);
    }

    .debug-resizer-top {
      width: 100%;
      height: 8px;
      background: #3e4a4e;
      cursor: ns-resize;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
      touch-action: none;
    }
    
    .debug-resizer-top::after {
      content: '';
      width: 40px;
      height: 3px;
      background: #7f8c8d;
      border-radius: 2px;
    }

    .debug-header {
      padding: 8px 15px;
      background: #1e272e;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      font-weight: bold;
      flex-shrink: 0;
    }

    .debug-body {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .debug-console {
      width: 50%;
      overflow-y: auto;
      padding: 12px;
      font-family: 'Courier New', Courier, monospace;
      font-size: var(--debug-font-size);
      background: #2d3436;
    }

    .debug-resizer-mid {
      width: 6px;
      background: #1e272e;
      cursor: col-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: none;
    }
    
    .debug-resizer-mid:hover {
      background: #74b9ff;
    }
    
    .debug-resizer-mid::after {
      content: '';
      height: 20px;
      width: 2px;
      background: #555;
    }

    .debug-code {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      font-family: 'Fira Code', monospace;
      font-size: var(--debug-font-size);
      background: #262b2e;
      color: #f1f2f6;
      border-left: 1px solid #444;
      line-height: 1.5;
    }

    .code-var { color: #f1c40f; cursor: pointer; text-decoration: underline dotted; }
    .code-var.resolved { text-decoration: none; font-weight: 700; }
    .code-key { color: #ff7f50; font-weight: bold; }
    .code-op { color: #ff9a9e; }
    .code-val { color: #55efc4; }
    .code-comment { color: #636e72; font-style: italic; }

    .log-entry {
      margin-bottom: 8px;
      padding: 5px;
      border-bottom: 1px solid #444;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
    }
    
    .log-step { color: #f1c40f; min-width: 50px; }
    .log-node { color: #74b9ff; font-weight: bold; }
    .log-action { color: #b2bec3; }
    .log-result { color: #55efc4; font-weight: bold; }

    /* --- Nodes --- */
    .drawflow-node {
      background: white;
      border: 1px solid #e0e0e0;
      padding: 0;
      border-radius: var(--node-radius);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      width: 150px;
      transition: border 0.2s, box-shadow 0.2s;
      user-select: none;
      cursor: grab;
      touch-action: none;
    }
    
    .drawflow-node:active {
      cursor: grabbing;
    }
    
    .drawflow-node.selected {
      border: 2px solid #ff9a9e;
      box-shadow: 0 0 15px rgba(255, 154, 158, 0.4);
      z-index: 5 !important;
    }
    
    .drawflow-node.multi-selected {
      outline: 2px dashed #ff9800;
      outline-offset: 4px;
      z-index: 5 !important;
    }

    .node-header {
      padding: 8px;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      font-weight: 600;
      color: white;
      text-align: center;
      font-size: 12px;
      letter-spacing: 0.3px;
    }

    .node-content {
      padding: 10px 8px;
      font-size: 12px;
      color: #555;
      cursor: default;
      background: white !important;
    }

    .input-node .node-header { background: #96e6a1; }
    .op-node .node-header { background: #8fd3f4; }
    .math-node .node-header { background: #ff9a9e; }
    .gate-node .node-header { background: #a18cd1; }
    .logic-node .node-header { background: #f6d365; color: #444; }
    .not-node .node-header { background: #4facfe; }
    .output-node .node-header { background: #d57eeb; }
    .transistor-node .node-header { background: #ff7f50; }

    select, input {
      width: 90%;
      padding: 5px;
      border-radius: 6px;
      border: 1px solid #ddd;
      outline: none;
      background: #fdfdfd;
      font-size: 12px;
    }

    .drawflow .connection .main-path {
      stroke-width: 3px;
      stroke: #bdc3c7;
      cursor: pointer;
    }
    
    .drawflow .connection .main-path:hover {
      stroke: #ff9a9e;
    }

    .drawflow-node .input,
    .drawflow-node .output {
      width: 14px;
      height: 14px;
      background: #fff;
      border: 2px solid #bdc3c7;
      border-radius: 50%;
    }
    
    .drawflow-node .input:hover,
    .drawflow-node .output:hover {
      transform: scale(1.3);
      border-color: #ffc107;
    }

    /* --- Creator Badge --- */
    .creator-badge {
      position: absolute;
      bottom: 15px;
      right: 15px;
      z-index: 15;
      display: flex;
      align-items: flex-end;
      flex-direction: column;
    }

    .profile-image-container {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid white;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: transform 0.2s;
      background: #ddd;
    }
    
    .profile-image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .profile-image-container:hover {
      transform: scale(1.1);
    }

    .creator-info {
      background: white;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
      margin-bottom: 8px;
      width: 180px;
      font-size: 12px;
      text-align: left;
      display: none;
      animation: fadeIn 0.2s;
    }
    
    .creator-badge:hover .creator-info {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .creator-info h4 {
      margin: 0 0 5px 0;
      color: #333;
      font-size: 13px;
    }
    
    .creator-info p {
      margin: 0 0 8px 0;
      color: #666;
      font-size: 11px;
      line-height: 1.4;
    }
    
    .social-links {
      display: flex;
      gap: 8px;
    }
    
    .social-links a {
      color: #555;
      font-size: 14px;
      transition: color 0.2s;
    }
    
    .social-links a:hover {
      color: #2196f3;
    }

    .code-wrapper {
      counter-reset: line;
      font-family: 'Fira Code', monospace;
    }

    .code-line {
      display: grid;
      grid-template-columns: 40px 1fr;
      border-bottom: 1px solid #3a3a3a;
    }

    .code-line::before {
      counter-increment: line;
      content: counter(line);
      color: #6c757d;
      background: #1f2326;
      text-align: right;
      padding: 0 8px;
      user-select: none;
      font-size: 11px;
    }

    .code-content {
      padding-left: 10px;
      white-space: pre;
    }

    /* ========================================
       MOBILE RESPONSIVE STYLES
       ======================================== */
    @media (max-width: 768px) {
      /* Palette adjustments */
      .palette {
        top: 5px;
        left: 5px;
        width: 140px;
        max-height: 50vh;
        padding: 10px;
        gap: 6px;
      }

      .palette h3 {
        font-size: 12px;
      }

      .drag-drawflow {
        padding: 6px;
        font-size: 11px;
      }

      /* Controls adjustments */
      .controls {
        top: 5px;
        right: 5px;
        gap: 4px;
        max-width: calc(100% - 160px);
      }

      .btn {
        padding: 6px 10px;
        font-size: 11px;
        gap: 3px;
      }

      .btn i {
        font-size: 12px;
      }

      /* Hide text on mobile for space */
      .btn span {
        display: none;
      }

      /* Debug panel adjustments */
      #debug-panel {
        height: 50vh;
        max-height: 75vh;
      }

      .debug-header {
        padding: 6px 10px;
        font-size: 11px;
        flex-wrap: wrap;
        gap: 5px;
      }

      .debug-header span {
        font-size: 11px;
      }

      /* Stack console and code vertically on mobile */
      .debug-body {
        flex-direction: column;
      }

      .debug-console {
        width: 100%;
        max-height: 50%;
        border-bottom: 1px solid #444;
      }

      .debug-resizer-mid {
        display: none !important;
      }

      .debug-code {
        width: 100%;
        border-left: none;
        border-top: 1px solid #444;
      }

      /* Node adjustments */
      .drawflow-node {
        width: 130px;
      }

      .node-header {
        padding: 6px;
        font-size: 11px;
      }

      .node-content {
        padding: 8px 6px;
        font-size: 11px;
      }

      select, input {
        font-size: 11px;
        padding: 4px;
      }

      .drawflow-node .input,
      .drawflow-node .output {
        width: 16px;
        height: 16px;
      }

      /* Creator badge */
      .creator-badge {
        bottom: 10px;
        right: 10px;
      }

      .profile-image-container {
        width: 40px;
        height: 40px;
      }

      .creator-info {
        width: 160px;
        padding: 10px;
        font-size: 11px;
      }

      .creator-info h4 {
        font-size: 12px;
      }

      .creator-info p {
        font-size: 10px;
      }

      /* Adjust font sizes */
      :root {
        --debug-font-size: 11px;
      }

      .log-entry {
        font-size: 10px;
        gap: 6px;
      }

      .code-line {
        grid-template-columns: 35px 1fr;
      }

      .code-line::before {
        font-size: 10px;
        padding: 0 6px;
      }

      .code-content {
        padding-left: 8px;
        font-size: 11px;
      }

      /* Tooltip adjustments */
      #probe-tooltip {
        font-size: 10px;
        padding: 4px 8px;
      }

      #floating-copy-btn {
        padding: 5px 10px;
        font-size: 10px;
      }
    }

    /* Extra small devices */
    @media (max-width: 480px) {
      .palette {
        width: 120px;
      }

      .controls {
        max-width: calc(100% - 140px);
      }

      .btn {
        padding: 5px 8px;
        font-size: 10px;
      }

      .drawflow-node {
        width: 120px;
      }

      .node-header {
        font-size: 10px;
      }

      .node-content {
        font-size: 10px;
      }

      #debug-panel {
        height: 55vh;
      }

      .creator-info {
        display: none !important; /* Hide on tap for very small screens */
      }
    }

    /* Landscape mobile */
    @media (max-width: 768px) and (orientation: landscape) {
      .palette {
        max-height: 40vh;
      }

      #debug-panel {
        height: 45vh;
        max-height: 70vh;
      }

      .controls {
        flex-wrap: nowrap;
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <input type="file" id="file-input" accept=".json" style="display: none" />
  
  <div id="floating-copy-btn">
    <i class="fas fa-copy"></i>
    <span>คัดลอก</span>
  </div>
  
  <div id="probe-tooltip">Val: 0</div>

  <div class="palette" id="palette-box">
    <div class="palette-header">
      <h3><i class="fas fa-cubes"></i> คลังคำสั่ง</h3>
      <i class="fas fa-chevron-up toggle-palette-btn" id="palette-toggle"></i>
    </div>
    <div class="drag-drawflow" draggable="true" data-node="input">
      <i class="fas fa-play-circle"></i> ค่าเริ่มต้น
    </div>
    <div class="drag-drawflow" draggable="true" data-node="operation">
      <i class="fas fa-calculator"></i> ตัวลดพลังงาน
    </div>
    <div class="drag-drawflow" draggable="true" data-node="math">
      <i class="fas fa-plus-minus"></i> กระทำการ
    </div>
    <div class="drag-drawflow" draggable="true" data-node="gate">
      <i class="fas fa-torii-gate"></i> บล็อกเงื่อนไข
    </div>
    <div class="drag-drawflow" draggable="true" data-node="logic_and">
      <i class="fas fa-project-diagram"></i> AND Gate
    </div>
    <div class="drag-drawflow" draggable="true" data-node="logic_not">
      <i class="fas fa-exclamation-circle"></i> NOT Gate
    </div>
    <div class="drag-drawflow" draggable="true" data-node="transistor">
      <i class="fas fa-microchip"></i> ทรานซิสเตอร์
    </div>
    <div class="drag-drawflow" draggable="true" data-node="output">
      <i class="fas fa-flag-checkered"></i> ผลลัพธ์
    </div>
  </div>

  <div class="controls">
    <button class="btn btn-save" id="save-btn">
      <i class="fas fa-save"></i><span>บันทึก</span>
    </button>
    <button class="btn" id="load-btn">
      <i class="fas fa-folder-open"></i><span>เปิด</span>
    </button>
    <button class="btn btn-undo" id="undo-btn" title="ย้อนกลับ">
      <i class="fas fa-undo"></i>
    </button>
    <button class="btn btn-probe" id="probe-btn" title="วัดไฟ">
      <i class="fas fa-wrench"></i><span>วัดไฟ</span>
    </button>
    <button class="btn" id="copy-btn">
      <i class="fas fa-copy"></i>
    </button>
    <button class="btn" id="zoom-out"><i class="fas fa-minus"></i></button>
    <button class="btn" id="zoom-in"><i class="fas fa-plus"></i></button>
    <button class="btn btn-run" id="run-btn">
      <i class="fas fa-play"></i><span>รัน</span>
    </button>
  </div>

  <div id="debug-panel">
    <div class="debug-resizer-top" id="debug-resizer-top"></div>
    <div class="debug-header">
      <span><i class="fas fa-terminal"></i> Console & Code</span>
      <div style="display: flex; gap: 6px; align-items: center">
        <button class="btn" id="font-minus" title="ลดขนาด">A-</button>
        <button class="btn" id="font-plus" title="เพิ่มขนาด">A+</button>
        <span style="cursor: pointer" onclick="document.getElementById('debug-panel').classList.remove('active')">
          <i class="fas fa-times"></i>
        </span>
      </div>
    </div>
    <div class="debug-body" id="debug-body">
      <div class="debug-console" id="debug-log"></div>
      <div class="debug-resizer-mid" id="debug-resizer-mid"></div>
      <div class="debug-code" id="code-view">
        <div class="code-wrapper"></div>
      </div>
    </div>
  </div>

    <div class="creator-badge">
      <div class="creator-info">
        <h4>PungPon ปอนด์ปัง</h4>
        <p>
          นักพัฒนาซอฟต์แวร์ผู้หลงใหลในการสร้างสรรค์วงจรไฟฟ้าในเกมส์ Mini World
        </p>
        <div class="social-links">
          <a
            href="https://web.facebook.com/profile.php?id=61584509074271"
            target="_blank"
            title="Facebook"
          >
            <i class="fab fa-facebook"></i>
          </a>
          <a href="https://github.com/pp300950" target="_blank" title="GitHub">
            <i class="fab fa-github"></i>
          </a>
          <a href="mailto:toaiseriesandcat@gmail.com" title="Gmail">
            <i class="fas fa-envelope"></i>
          </a>
        </div>
      </div>
      <div class="profile-image-container">
        <img src="me.jpg" alt="Creator Profile" />
      </div>
    </div>

    <div id="drawflow"></div>

    <script>
      const container = document.getElementById('drawflow');

      // 1. ต้องประกาศตัวแปร editor ก่อนเสมอ (ย้ายบรรทัดนี้ขึ้นมา)
      const editor = new Drawflow(container);

      // 2. จากนั้นค่อยตั้งค่าต่าง ๆ ให้ editor
      editor.reroute = true;
      editor.reroute_fix_curvature = true;
      editor.draggable_inputs = false;
      editor.start();
      editor.zoom_value = 0.25;

      // 3. ส่วนของระบบ History สำหรับ Undo
      let history = [];
      let isActionFromUndo = false;

      function saveHistory() {
        if (isActionFromUndo) return; // ถ้ากำลัง Undo อยู่ ไม่ต้องบันทึกซ้ำ
        const exportData = editor.export();
        history.push(JSON.stringify(exportData));
        if (history.length > 20) history.shift(); // เก็บย้อนหลังสูงสุด 20 ครั้ง
      }

      // ตรวจจับเหตุการณ์ต่างๆ เพื่อบันทึกประวัติ
      editor.on('nodeCreated', saveHistory);
      editor.on('nodeRemoved', saveHistory);
      editor.on('connectionCreated', saveHistory);
      editor.on('connectionRemoved', saveHistory);
      editor.on('nodeMoved', saveHistory);

      // --- Grid Background ---
      function updateGridBackground() {
        const zoom = editor.zoom;
        const x = editor.canvas_x;
        const y = editor.canvas_y;
        container.style.backgroundSize = `${25 * zoom}px ${25 * zoom}px`;
        container.style.backgroundPosition = `${x}px ${y}px`;
        hideFloatingBtn();
      }
      editor.on('zoom', updateGridBackground);
      editor.on('translate', updateGridBackground);

      // --- Node HTML Templates ---
      const nodeTypes = {
        input: {
          html: `<div class="node-header"><i class="fas fa-bolt"></i> นำเข้าค่า</div>
               <div class="node-content">ค่าไฟ: <input type="number" df-value value="15" min="0" max="15"></div>`,
          inputs: 0,
          outputs: 1,
          class: 'input-node',
        },
        operation: {
          html: `<div class="node-header"><i class="fas fa-cog"></i> ตัวลดพลังงาน</div>
               <div class="node-content"><select df-op>
                  <option value="div2">/ 2 (ปัดลง)</option>
                  <option value="sub7">- 7</option>
                  <option value="sub4">- 4</option>
                  <option value="sub1">- 1</option>
               </select></div>`,
          inputs: 1,
          outputs: 1,
          class: 'op-node',
        },
        math: {
          html: `<div class="node-header"><i class="fas fa-calculator"></i> กระทำการทางคณิต</div>
               <div class="node-content">โหมด: <select df-mathOp><option value="add">บวก (+)</option><option value="sub">ลบ (-)</option></select>
               <div style="font-size:10px; color:#999; margin-top:5px;">*รับ 2 สายเข้า</div></div>`,
          inputs: 2,
          outputs: 1,
          class: 'math-node',
        },
        gate: {
          html: `<div class="node-header"><i class="fas fa-torii-gate"></i> เงื่อนไข</div>
               <div class="node-content" style="text-align:center;"><div style="font-size:10px;">เงื่อนไข: บน(หลัง) &#8805; ล่าง(ข้าง) ถึงจะปล่อยไฟที่สูงสุดออกมา</div></div>`,
          inputs: 2,
          outputs: 1,
          class: 'gate-node',
        },
        logic_and: {
          html: `<div class="node-header"><i class="fas fa-project-diagram"></i> AND</div>
               <div class="node-content" style="text-align:center;"><div style="font-size:10px;">ต้องมีไฟทั้งคู่</div></div>`,
          inputs: 2,
          outputs: 1,
          class: 'logic-node',
        },
        logic_not: {
          html: `<div class="node-header"><i class="fas fa-exclamation-circle"></i> NOT</div>
               <div class="node-content" style="text-align:center;"><div style="font-size:10px;">กลับค่า (ติด/ดับ)</div></div>`,
          inputs: 1,
          outputs: 1,
          class: 'not-node',
        },
        transistor: {
          html: `<div class="node-header"><i class="fas fa-microchip"></i> สวิตช์ไฟ</div>
               <div class="node-content" style="text-align:center;">
                  <div style="font-size:10px; color:#666;">บน: สัญญาณ, ล่าง: คุม</div>
                  <div style="font-size:9px; margin-top:5px; color:#999;">ถ้า Control มีไฟ -> ปล่อย Signal ผ่าน</div>
               </div>`,
          inputs: 2,
          outputs: 1,
          class: 'transistor-node',
        },
        output: {
          html: `<div class="node-header"><i class="fas fa-lightbulb"></i> เเสดงผลค่า</div>
               <div class="node-content" style="text-align:center;"><h2 style="margin:5px 0; color:#d57eeb;" df-result>?</h2><div style="font-size:10px; color:#aaa;">(แสดงค่ามากสุด)</div></div>`,
          inputs: 3,
          outputs: 0,
          class: 'output-node',
        },
      };

      // --- Drag & Drop ---
      const paletteItems = document.querySelectorAll('.drag-drawflow');
      paletteItems.forEach((item) => {
        item.addEventListener('dragstart', (e) =>
          e.dataTransfer.setData('node', e.target.dataset.node)
        );
      });

      container.addEventListener('dragover', (e) => e.preventDefault());
      container.addEventListener('drop', (e) => {
        e.preventDefault();
        const nodeType = e.dataTransfer.getData('node');
        addNodeToEditor(nodeType, e.clientX, e.clientY);
      });

      function addNodeToEditor(nodeType, clientX, clientY, data = null) {
        if (!nodeTypes[nodeType]) return;
        const typeData = nodeTypes[nodeType];
        const pos_x =
          clientX *
            (editor.precanvas.clientWidth /
              (editor.precanvas.clientWidth * editor.zoom)) -
          editor.precanvas.getBoundingClientRect().x *
            (editor.precanvas.clientWidth /
              (editor.precanvas.clientWidth * editor.zoom));
        const pos_y =
          clientY *
            (editor.precanvas.clientHeight /
              (editor.precanvas.clientHeight * editor.zoom)) -
          editor.precanvas.getBoundingClientRect().y *
            (editor.precanvas.clientHeight /
              (editor.precanvas.clientHeight * editor.zoom));
        const defaultData = {
          value: 15,
          op: 'div2',
          mathOp: 'add',
          result: '?',
        };
        editor.addNode(
          nodeType,
          typeData.inputs,
          typeData.outputs,
          pos_x,
          pos_y,
          typeData.class,
          data || defaultData,
          typeData.html
        );
      }

      // --- Palette Toggle ---
      const paletteBox = document.getElementById('palette-box');
      document
        .getElementById('palette-toggle')
        .addEventListener('click', () => {
          paletteBox.classList.toggle('collapsed');
        });

      // --- Resizable Logic (Vertical - Height) ---
      const debugPanel = document.getElementById('debug-panel');
      const resizerTop = document.getElementById('debug-resizer-top');
      let isResizingHeight = false;

      resizerTop.addEventListener('mousedown', (e) => {
        isResizingHeight = true;
        document.body.style.cursor = 'ns-resize';
        e.preventDefault();
      });

      // --- Resizable Logic (Horizontal - Width Split) ---
      const resizerMid = document.getElementById('debug-resizer-mid');
      const debugConsole = document.getElementById('debug-log');
      let isResizingWidth = false;

      resizerMid.addEventListener('mousedown', (e) => {
        isResizingWidth = true;
        document.body.style.cursor = 'col-resize';
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        // ปรับความสูง Panel
        if (isResizingHeight) {
          const newHeight = window.innerHeight - e.clientY;
          if (newHeight > 100 && newHeight < window.innerHeight - 50) {
            debugPanel.style.height = `${newHeight}px`;
            debugPanel.style.transition = 'none';
          }
        }
        // ปรับความกว้าง Console
        if (isResizingWidth) {
          const body = document.getElementById('debug-body');
          const containerWidth = body.clientWidth;

          let newWidthPercent = (e.clientX / containerWidth) * 100;

          // clamp แบบใหม่
          if (newWidthPercent < 0) newWidthPercent = 0;
          if (newWidthPercent > 95) newWidthPercent = 95;

          debugConsole.style.width = `${newWidthPercent}%`;

          // ถ้าชิดซ้ายมาก → ซ่อน console
          if (newWidthPercent < 5) {
            debugConsole.style.display = 'none';
            resizerMid.style.display = 'none';
          } else {
            debugConsole.style.display = 'block';
            resizerMid.style.display = 'flex';
          }
        }
        resizerMid.addEventListener('dblclick', () => {
          if (debugConsole.style.display === 'none') {
            debugConsole.style.display = 'block';
            debugConsole.style.width = '50%';
            resizerMid.style.display = 'flex';
          } else {
            debugConsole.style.display = 'none';
            resizerMid.style.display = 'none';
          }
        });
      });

      document.addEventListener('mouseup', () => {
        if (isResizingHeight) {
          isResizingHeight = false;
          document.body.style.cursor = 'default';
          debugPanel.style.transition = 'transform 0.3s ease-in-out';
        }
        if (isResizingWidth) {
          isResizingWidth = false;
          document.body.style.cursor = 'default';
        }
      });

      // --- Zoom & Undo ---
      document
        .getElementById('zoom-in')
        .addEventListener('click', () => editor.zoom_in());
      document
        .getElementById('zoom-out')
        .addEventListener('click', () => editor.zoom_out());

      // Undo Function
      document.getElementById('undo-btn').addEventListener('click', () => {
        if (history.length <= 1) {
          console.log('ไม่มีรายการให้ย้อนกลับ');
          return;
        }

        isActionFromUndo = true;
        history.pop(); // เอาสถานะปัจจุบันออก
        const previousState = JSON.parse(history[history.length - 1]);

        editor.import(previousState);

        setTimeout(() => {
          isActionFromUndo = false;
        }, 100);
      });

      let waitingConnection = null;
      container.addEventListener('click', (e) => {
        // (Context Menu ถูกปิดไปแล้ว)

        if (e.target.id === 'drawflow') {
          hideFloatingBtn();
          document
            .querySelectorAll('.drawflow-node.selected')
            .forEach((el) => el.classList.remove('selected'));
          editor.node_selected = null;
        }

        // Manual Connection Logic
        if (e.target.classList.contains('output')) {
          const node = e.target.closest('.drawflow-node');
          const nodeId = node.id.replace('node-', '');
          const outputClass = e.target.classList[1];
          document
            .querySelectorAll('.waiting-connect')
            .forEach((el) => el.classList.remove('waiting-connect'));
          waitingConnection = { nodeId, outputClass };
          e.target.classList.add('waiting-connect');
        } else if (e.target.classList.contains('input') && waitingConnection) {
          const node = e.target.closest('.drawflow-node');
          const targetNodeId = node.id.replace('node-', '');
          const inputClass = e.target.classList[1];
          if (waitingConnection.nodeId !== targetNodeId)
            editor.addConnection(
              waitingConnection.nodeId,
              waitingConnection.outputClass,
              targetNodeId,
              inputClass
            );
          document
            .querySelectorAll('.waiting-connect')
            .forEach((el) => el.classList.remove('waiting-connect'));
          waitingConnection = null;
        } else if (e.target.id === 'drawflow') {
          document
            .querySelectorAll('.waiting-connect')
            .forEach((el) => el.classList.remove('waiting-connect'));
          waitingConnection = null;
        }
      });
      // --- Floating Copy Button ---
      const floatingBtn = document.getElementById('floating-copy-btn');
      function updateFloatingBtnPos(nodeId) {
        const nodeEl = document.getElementById('node-' + nodeId);
        if (nodeEl) {
          const rect = nodeEl.getBoundingClientRect();
          floatingBtn.style.display = 'block';
          floatingBtn.style.left = `${rect.left + rect.width / 2}px`;
          floatingBtn.style.top = `${rect.top}px`;
        }
      }
      function hideFloatingBtn() {
        floatingBtn.style.display = 'none';
      }

      editor.on('nodeSelected', (id) => updateFloatingBtnPos(id));
      editor.on('nodeUnselected', () => {
        setTimeout(() => {
          if (!editor.node_selected) hideFloatingBtn();
        }, 100);
      });
      editor.on('nodeMoved', (id) => updateFloatingBtnPos(id));

      floatingBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        copySelectedNodes();
        if (clipboard && clipboard.length > 0) {
          const exportData = editor.export();
          const firstNode = exportData.drawflow.Home.data[clipboard[0]];
          if (firstNode) {
            clipboard.forEach((id) => {
              const nodeData = exportData.drawflow.Home.data[id];
              if (nodeData) {
                const inputCount = Object.keys(nodeData.inputs).length;
                const outputCount = Object.keys(nodeData.outputs).length;
                editor.addNode(
                  nodeData.name,
                  inputCount,
                  outputCount,
                  nodeData.pos_x + 50,
                  nodeData.pos_y + 50,
                  nodeData.class,
                  nodeData.data,
                  nodeData.html
                );
              }
            });
          }
        }
        const originalText = floatingBtn.innerHTML;
        floatingBtn.innerHTML = '<i class="fas fa-check"></i> เรียบร้อย';
        setTimeout(() => {
          floatingBtn.innerHTML = originalText;
          hideFloatingBtn();
          clearSelection();
        }, 800);
      });

      // --- Save / Load ---
      document.getElementById('save-btn').addEventListener('click', () => {
        const data = editor.export();
        const json = JSON.stringify(data);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'circuit-flow.json';
        a.click();
        URL.revokeObjectURL(url);
      });
      document
        .getElementById('load-btn')
        .addEventListener('click', () =>
          document.getElementById('file-input').click()
        );
      document.getElementById('file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const json = JSON.parse(e.target.result);
            editor.clearModuleSelected();
            editor.import(json);
            alert('นำเข้าไฟล์สำเร็จ!');
          } catch (err) {
            alert('ไฟล์เสียหาย');
          }
        };
        reader.readAsText(file);
        e.target.value = '';
      });

      // --- Multi-Select & Safe Space (Ctrl) Logic ---
      let selectedNodeIds = new Set();
      let isDraggingGroup = false;
      let lastMousePosition = { x: 0, y: 0 };
      let clipboard = null;

      container.addEventListener('click', (e) => {
        const nodeEl = e.target.closest('.drawflow-node');
        if (nodeEl && e.shiftKey) {
          const nodeId = nodeEl.id.replace('node-', '');
          if (selectedNodeIds.has(nodeId)) {
            selectedNodeIds.delete(nodeId);
            nodeEl.classList.remove('multi-selected');
          } else {
            selectedNodeIds.add(nodeId);
            nodeEl.classList.add('multi-selected');
          }
          hideFloatingBtn();
        } else if (
          !e.shiftKey &&
          !e.target.closest('.btn') &&
          !isDraggingGroup &&
          !e.target.closest('#floating-copy-btn')
        ) {
          if (e.target.id === 'drawflow') clearSelection();
        }
      });

      function clearSelection() {
        selectedNodeIds.forEach((id) => {
          const el = document.getElementById('node-' + id);
          if (el) el.classList.remove('multi-selected');
        });
        selectedNodeIds.clear();
      }

      container.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;

        // ** NEW: Safe Space Logic **
        // ถ้ากด Ctrl ค้างไว้ ห้ามลาก Node (return ออกไปเลย)
        if (e.ctrlKey) return;

        const nodeEl = e.target.closest('.drawflow-node');
        if (nodeEl) {
          const nodeId = nodeEl.id.replace('node-', '');
          if (selectedNodeIds.has(nodeId)) {
            isDraggingGroup = true;
            lastMousePosition = { x: e.clientX, y: e.clientY };
          }
        }
      });

      // ป้องกันการ Drag ของ Drawflow library เมื่อกด Ctrl
      // โดยการ Intercept event capture phase หรือตรวจสอบใน event ของ library
      // แต่วิธีที่ง่ายที่สุดคือสั่ง editor.editor_mode เป็น 'fixed' ชั่วคราว
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Control') {
          editor.editor_mode = 'fixed'; // ล็อคการขยับ Node
          container.style.cursor = 'grab'; // เปลี่ยน Cursor ให้รู้ว่าแพนได้
        }
      });
      window.addEventListener('keyup', (e) => {
        if (e.key === 'Control') {
          editor.editor_mode = 'edit'; // ปลดล็อค
          container.style.cursor = 'default';
        }
      });

      window.addEventListener('mousemove', (e) => {
        if (!isDraggingGroup) return;
        // ถ้ากด Ctrl ตอนลากกลุ่ม ก็หยุดเหมือนกัน
        if (e.ctrlKey) return;

        const dx = (e.clientX - lastMousePosition.x) / editor.zoom;
        const dy = (e.clientY - lastMousePosition.y) / editor.zoom;
        lastMousePosition = { x: e.clientX, y: e.clientY };

        const activeNodeId = editor.node_selected
          ? (typeof editor.node_selected === 'object'
              ? editor.node_selected.id
              : editor.node_selected
            ).replace('node-', '')
          : null;

        const currentModule = editor.module;
        selectedNodeIds.forEach((id) => {
          if (id !== activeNodeId) {
            const nodeData =
              editor.drawflow.drawflow?.[currentModule]?.data?.[id];
            if (nodeData) {
              nodeData.pos_x += dx;
              nodeData.pos_y += dy;
              const el = document.getElementById('node-' + id);
              if (el) {
                el.style.top = `${nodeData.pos_y}px`;
                el.style.left = `${nodeData.pos_x}px`;
              }
              editor.updateConnectionNodes('node-' + id);
            }
          }
        });
      });

      window.addEventListener('mouseup', () => {
        isDraggingGroup = false;
      });

      // --- Copy / Paste ---
      function copySelectedNodes() {
        if (selectedNodeIds.size > 0) {
          clipboard = Array.from(selectedNodeIds);
        } else if (editor.node_selected) {
          const selectedId =
            typeof editor.node_selected === 'object'
              ? editor.node_selected.id
              : editor.node_selected;
          if (selectedId) clipboard = [selectedId.replace('node-', '')];
        } else {
          clipboard = null;
        }
      }

      function pasteNodes(mouseX, mouseY) {
        if (!clipboard || clipboard.length === 0) return;
        const exportData = editor.export();
        const canvasX =
          mouseX *
            (editor.precanvas.clientWidth /
              (editor.precanvas.clientWidth * editor.zoom)) -
          editor.precanvas.getBoundingClientRect().x *
            (editor.precanvas.clientWidth /
              (editor.precanvas.clientWidth * editor.zoom));
        const canvasY =
          mouseY *
            (editor.precanvas.clientHeight /
              (editor.precanvas.clientHeight * editor.zoom)) -
          editor.precanvas.getBoundingClientRect().y *
            (editor.precanvas.clientHeight /
              (editor.precanvas.clientHeight * editor.zoom));

        const firstNode = exportData.drawflow.Home.data[clipboard[0]];
        if (!firstNode) return;

        const refX = firstNode.pos_x;
        const refY = firstNode.pos_y;

        clipboard.forEach((id) => {
          const nodeData = exportData.drawflow.Home.data[id];
          if (nodeData) {
            const offsetX = nodeData.pos_x - refX;
            const offsetY = nodeData.pos_y - refY;
            const inputCount = Object.keys(nodeData.inputs).length;
            const outputCount = Object.keys(nodeData.outputs).length;
            editor.addNode(
              nodeData.name,
              inputCount,
              outputCount,
              canvasX + offsetX,
              canvasY + offsetY,
              nodeData.class,
              nodeData.data,
              nodeData.html
            );
          }
        });
        clearSelection();
      }

      let currentMousePos = { x: 0, y: 0 };
      window.addEventListener('mousemove', (e) => {
        currentMousePos = { x: e.clientX, y: e.clientY };
      });

      window.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'C')) {
          if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT')
            copySelectedNodes();
        }
        if ((e.ctrlKey || e.metaKey) && (e.key === 'v' || e.key === 'V')) {
          if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT')
            pasteNodes(currentMousePos.x, currentMousePos.y);
        }
        // Undo Shortcut (Ctrl+Z)
        if ((e.ctrlKey || e.metaKey) && (e.key === 'z' || e.key === 'Z')) {
          editor.undo();
        }
      });

      document.getElementById('copy-btn').addEventListener('click', () => {
        copySelectedNodes();
        if (!clipboard) return;
        const exportData = editor.export();
        clipboard.forEach((id) => {
          const nodeData = exportData.drawflow.Home.data[id];
          if (nodeData) {
            const inputCount = Object.keys(nodeData.inputs).length;
            const outputCount = Object.keys(nodeData.outputs).length;
            editor.addNode(
              nodeData.name,
              inputCount,
              outputCount,
              nodeData.pos_x + 50,
              nodeData.pos_y + 50,
              nodeData.class,
              nodeData.data,
              nodeData.html
            );
          }
        });
        clearSelection();
      });

      // --- Core Simulation Logic + CODE GENERATOR ---
      function simulateGraph(returnResultsOnly = false) {
        const exportData = editor.export();
        const graph = exportData.drawflow.Home.data;
        const clamp = (num) => Math.min(15, Math.max(0, Math.floor(num)));

        const debugLogs = [];
        const codeLines = []; // เก็บโค้ดที่สร้างขึ้น
        const memo = {};

        function log(nodeName, nodeId, action, result) {
          if (!returnResultsOnly) {
            debugLogs.push({
              id: nodeId,
              name: nodeName,
              action: action,
              result: result,
            });
          }
        }

        function addCode(text) {
          if (!returnResultsOnly) codeLines.push(text);
        }

        function computeNode(nodeId, visited = new Set()) {
          if (visited.has(nodeId)) return 0;
          if (memo[nodeId] !== undefined) return memo[nodeId];

          visited.add(nodeId);
          const node = graph[nodeId];
          if (!node) return 0;

          let result = 0;
          let actionMsg = '';
          let varName = `<span class="code-var" data-node="${nodeId}">node_${nodeId}</span>`;

          // 1. INPUT
          if (node.name === 'input') {
            const domInput = document.querySelector(`#node-${nodeId} input`);
            const val = domInput ? domInput.value : node.data.value;
            result = clamp(parseInt(val) || 0);
            actionMsg = `ส่งค่าไฟเริ่มต้น`;

            addCode(
              `<span class="code-key">int</span> ${varName} = <span class="code-val">${result}</span>;`
            );

            memo[nodeId] = result;
            log('Input', nodeId, actionMsg, result);
            return result;
          }

          // Get Inputs
          let v1 = 0;
          let id1 = null;
          if (
            node.inputs.input_1 &&
            node.inputs.input_1.connections.length > 0
          ) {
            id1 = node.inputs.input_1.connections[0].node;
            v1 = computeNode(id1, new Set(visited));
          }

          let v2 = 0;
          let id2 = null;
          if (
            node.inputs.input_2 &&
            node.inputs.input_2.connections.length > 0
          ) {
            id2 = node.inputs.input_2.connections[0].node;
            v2 = computeNode(id2, new Set(visited));
          }

          // ตัวแปรอ้างอิงโค้ด
          const var1 = id1
            ? `<span class="code-var" data-node="${id1}">node_${id1}</span>`
            : '0';
          const var2 = id2
            ? `<span class="code-var" data-node="${id2}">node_${id2}</span>`
            : '0';

          // 2. OPERATION
          if (node.name === 'operation') {
            const domSelect = document.querySelector(`#node-${nodeId} select`);
            const op = domSelect ? domSelect.value : node.data.op;

            let mathSign = '';
            let operand = '';

            if (op === 'div2') {
              result = Math.floor(v1 / 2);
              actionMsg = `${v1} / 2`;
              mathSign = '/';
              operand = '2';
            }
            if (op === 'sub7') {
              result = v1 - 7;
              actionMsg = `${v1} - 7`;
              mathSign = '-';
              operand = '7';
            }
            if (op === 'sub4') {
              result = v1 - 4;
              actionMsg = `${v1} - 4`;
              mathSign = '-';
              operand = '4';
            }
            if (op === 'sub1') {
              result = v1 - 1;
              actionMsg = `${v1} - 1`;
              mathSign = '-';
              operand = '1';
            }
            result = clamp(result);

            addCode(
              `${varName} = ${var1} <span class="code-op">${mathSign}</span> ${operand}; <span class="code-comment">// = ${result}</span>`
            );
          }

          // 3. MATH
          else if (node.name === 'math') {
            const domSelect = document.querySelector(`#node-${nodeId} select`);
            const op = domSelect ? domSelect.value : node.data.mathOp;

            if (op === 'add') {
              result = v1 + v2;
              actionMsg = `${v1} + ${v2}`;
              addCode(
                `${varName} = ${var1} <span class="code-op">+</span> ${var2}; <span class="code-comment">// = ${result}</span>`
              );
            }
            if (op === 'sub') {
              result = v1 - v2;
              actionMsg = `${v1} - ${v2}`;
              addCode(
                `${varName} = ${var1} <span class="code-op">-</span> ${var2}; <span class="code-comment">// = ${result}</span>`
              );
            }
            result = clamp(result);
          }

          // 4. GATE
          else if (node.name === 'gate') {
            if (v1 >= v2) {
              result = clamp(v1);
              actionMsg = `Gate Open`;
              addCode(
                `if (${var1} >= ${var2}) { ${varName} = ${var1}; } else { ${varName} = 0; }`
              );
            } else {
              result = 0;
              actionMsg = `Gate Closed`;
              addCode(
                `if (${var1} >= ${var2}) { ${varName} = ${var1}; } else { ${varName} = 0; }`
              );
            }
          }

          // 5. AND
          else if (node.name === 'logic_and') {
            if (v1 > 0 && v2 > 0) {
              result = 15;
              actionMsg = `ON`;
              addCode(`${varName} = (${var1} > 0 && ${var2} > 0) ? 15 : 0;`);
            } else {
              result = 0;
              actionMsg = `OFF`;
              addCode(`${varName} = (${var1} > 0 && ${var2} > 0) ? 15 : 0;`);
            }
          }

          // 6. NOT
          else if (node.name === 'logic_not') {
            if (v1 > 0) {
              result = 0;
              actionMsg = `OFF`;
              addCode(`${varName} = (${var1} > 0) ? 0 : 15;`);
            } else {
              result = 15;
              actionMsg = `ON`;
              addCode(`${varName} = (${var1} > 0) ? 0 : 15;`);
            }
          }

          // 7. TRANSISTOR
          else if (node.name === 'transistor') {
            if (v2 > 0) {
              result = v1;
              actionMsg = `Pass`;
              addCode(
                `${varName} = (${var2} > 0) ? ${var1} : 0; <span class="code-comment">// Transistor</span>`
              );
            } else {
              result = 0;
              actionMsg = `Cut`;
              addCode(
                `${varName} = (${var2} > 0) ? ${var1} : 0; <span class="code-comment">// Transistor</span>`
              );
            }
          }

          // 8. OUTPUT
          else if (node.name === 'output') {
            let maxVal = 0;
            let inputsVars = [];

            Object.keys(node.inputs).forEach((key) => {
              const inputPort = node.inputs[key];
              if (inputPort.connections.length > 0) {
                const incomingId = inputPort.connections[0].node;
                const incomingVal = computeNode(incomingId, new Set(visited));
                inputsVars.push(
                  `<span class="code-var" data-node="${incomingId}">node_${incomingId}</span>`
                );

                if (incomingVal > maxVal) {
                  maxVal = incomingVal;
                }
              }
            });

            result = maxVal;
            const el = container.querySelector(`#node-${nodeId} [df-result]`);
            if (el) el.innerText = result;
            actionMsg = `Max Value`;

            if (inputsVars.length > 0) {
              addCode(
                `<span class="code-key">print</span>( max(${inputsVars.join(
                  ', '
                )}) ); <span class="code-comment">// Output = ${result}</span>`
              );
            } else {
              addCode(`<span class="code-key">print</span>( 0 );`);
            }
          }

          memo[nodeId] = result;
          log(node.name, nodeId, actionMsg, result);
          return result;
        }

        Object.keys(graph).forEach((nodeId) => {
          computeNode(nodeId);
        });

        return { logs: debugLogs, values: memo, code: codeLines };
      }

      // --- Enable clicking variable names to toggle to actual value ---
      function enableCodeVarsInteractivity(simResult) {
        // simResult.values คือ object { nodeId: value }
        const codeView = document.getElementById('code-view');
        if (!codeView) return;

        // ลบ listener เก่าๆ (เพื่อป้องกันผูกซ้ำ)
        codeView.querySelectorAll('.code-var').forEach((el) => {
          el.removeEventListener('click', el._clickHandler);
        });

        codeView.querySelectorAll('.code-var').forEach((el) => {
          const nodeId = el.getAttribute('data-node');
          // store original text
          if (!el.getAttribute('data-orig'))
            el.setAttribute('data-orig', el.innerText);

          const handler = function (ev) {
            ev.stopPropagation();
            const nid = el.getAttribute('data-node');
            const valObj =
              simResult && simResult.values ? simResult.values : null;
            const val = valObj && nid ? valObj[nid] : undefined;

            if (el.classList.contains('resolved')) {
              // ถ้าเป็น resolved อยู่ ให้กลับเป็นชื่อเดิม
              el.innerText = el.getAttribute('data-orig') || `node_${nid}`;
              el.classList.remove('resolved');
            } else {
              // แทนที่ด้วยค่าจริง (ถ้ามี) หรือ '?' ถ้าไม่มีค่า
              const show =
                val !== undefined && val !== null ? String(val) : '?';
              el.innerText = show;
              el.classList.add('resolved');
            }
          };

          // เก็บ handler เพื่อให้ลบได้ภายหลัง
          el._clickHandler = handler;
          el.addEventListener('click', handler);
        });
      }

      // --- Run Button ---
      document.getElementById('run-btn').addEventListener('click', () => {
        const simResult = simulateGraph(false);
        const debugLogs = simResult.logs;
        const generatedCode = simResult.code;

        debugPanel.classList.add('active');
        const debugConsole = document.getElementById('debug-log');
        const debugCode = document.getElementById('code-view');

        debugConsole.innerHTML = '';
        debugCode.innerHTML = '';

        // --- 1. Populate Console ---
        if (debugLogs.length === 0) {
          debugConsole.innerHTML =
            '<div style="padding:10px;">ไม่พบ Node หรือ Output ที่เชื่อมต่อกัน</div>';
        } else {
          debugLogs.forEach((log, index) => {
            const div = document.createElement('div');
            div.className = 'log-entry';
            let icon = '<i class="fas fa-caret-right"></i>';
            if (log.name === 'input') icon = '<i class="fas fa-bolt"></i>';
            div.innerHTML = `
                <div class="log-step">Step ${index + 1}</div>
                <div class="log-node">${icon} ${log.name.toUpperCase()} (ID:${
              log.id
            })</div>
                <div class="log-action">${log.action}</div>
                <div class="log-result">${log.result}</div>
              `;
            debugConsole.appendChild(div);
          });
        }

        // --- 2. Populate Code View ---
        if (generatedCode.length === 0) {
          debugCode.innerHTML = '// No Logic Detected';
        } else {
          debugCode.innerHTML = '';
          const wrapper = document.createElement('div');
          wrapper.className = 'code-wrapper';

          generatedCode.forEach((line) => {
            const row = document.createElement('div');
            row.className = 'code-line';

            const content = document.createElement('div');
            content.className = 'code-content';
            content.innerHTML = line;

            row.appendChild(content);
            wrapper.appendChild(row);
          });

          // End comment
          const endRow = document.createElement('div');
          endRow.className = 'code-line';
          endRow.innerHTML = `<div class="code-content code-comment">// End of Logic</div>`;
          wrapper.appendChild(endRow);

          debugCode.appendChild(wrapper);
        }
        enableCodeVarsInteractivity(simResult);

        debugConsole.scrollTop = debugConsole.scrollHeight;
      });

      // Probe Tool
      let isProbeMode = false;
      const probeBtn = document.getElementById('probe-btn');
      const tooltip = document.getElementById('probe-tooltip');

      probeBtn.addEventListener('click', () => {
        isProbeMode = !isProbeMode;
        if (isProbeMode) {
          probeBtn.classList.add('active');
          container.style.cursor = 'crosshair';
        } else {
          probeBtn.classList.remove('active');
          container.style.cursor = 'default';
          tooltip.style.display = 'none';
        }
      });

      container.addEventListener('mousemove', (e) => {
        if (!isProbeMode) return;
        const target = e.target;
        const nodeEl = target.closest('.drawflow-node');
        if (nodeEl) {
          const nodeId = nodeEl.id.replace('node-', '');
          const simResult = simulateGraph(true);
          const val = simResult.values[nodeId];
          tooltip.style.display = 'block';
          tooltip.style.left = e.clientX + 15 + 'px';
          tooltip.style.top = e.clientY + 15 + 'px';
          tooltip.innerHTML = `<i class="fas fa-bolt" style="color:#ffc107"></i> Value: <span style="font-size:14px; color:white;">${
            val !== undefined ? val : '?'
          }</span>`;
        } else {
          tooltip.style.display = 'none';
        }
      });

      let debugFontSize = 13;
      const MIN_FONT = 10;
      const MAX_FONT = 24;

      function applyDebugFontSize() {
        document.documentElement.style.setProperty(
          '--debug-font-size',
          debugFontSize + 'px'
        );
      }

      document.getElementById('font-plus').addEventListener('click', () => {
        if (debugFontSize < MAX_FONT) {
          debugFontSize += 1;
          applyDebugFontSize();
        }
      });

      document.getElementById('font-minus').addEventListener('click', () => {
        if (debugFontSize > MIN_FONT) {
          debugFontSize -= 1;
          applyDebugFontSize();
        }
      });
    </script>
  </body>
</html>
